#!/bin/bash
# author Adam Banaszkiewicz

if [ -z "$1" ]
then
    action="-"
else
    action="$1"
fi

composeFile="../docker/docker-compose.yml"
workdir="/var/www/html"

function docker_execute() {
    docker exec -it --workdir="$workdir" tulia_www $1
}

function composer_execute() {
    workdir="$workdir/tulia-cms"
    cmd="composer $1"
    docker_execute "$cmd"
}

if [ $action = 'start' ]
then
    docker-compose -f "$composeFile" up -d
elif [ $action = 'stop' ]
then
    docker-compose -f "$composeFile" stop
elif [ $action = 'restart' ]
then
    docker-compose -f "$composeFile" restart
elif [ $action = 'recreate' ]
then
    export USERID=`id -u` && export GROUPID=`id -g` && docker-compose -f "$composeFile" up -d --force-recreate --build
elif [ $action = 'clear' ]
then
    docker stop $(docker ps -a -q)
    docker container rm $(docker container ls -q)
    docker volume rm $(docker volume ls -q)
    docker image rm $(docker image ls -q) -f
    docker network rm $(docker network ls -q) -f
    docker system prune -f
elif [ $action = 'rm-v' ]
then
    docker-compose -f "$composeFile" rm -v
elif [ $action = 'rebuild' ]
then
    docker-compose -f "$composeFile" build --no-cache "${@:2}"
elif [ $action = 'hosts:install' ]
then
    sudo -- sh -c -e "echo '' >> /etc/hosts";
    sudo -- sh -c -e "echo '# Hosts for Tulia CMS Docker containers' >> /etc/hosts";
    sudo -- sh -c -e "echo '127.0.0.1 tulia.loc' >> /etc/hosts";
    sudo -- sh -c -e "echo '127.0.0.1 pl.tulia.loc' >> /etc/hosts";
    sudo -- sh -c -e "echo '127.0.0.1 de.tulia.loc' >> /etc/hosts";
    sudo -- sh -c -e "echo '127.0.0.1 doc.tulia.loc' >> /etc/hosts";
    sudo -- sh -c -e "echo '127.0.0.1 editor.tulia.loc' >> /etc/hosts";
else
    echo "Command not found"
fi
