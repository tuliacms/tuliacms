const TuliaEditor = function (selector, options) {
    this.container = null;

    this.on = function (event, callback) {
        this.container.get('TuliaEditor.Shared.EventDispatcher.EventDispatcher').on(event, callback);
    };

    this.container = new TuliaEditor.Shared.DependencyInjection.Container(TuliaEditor.services);
    options = $.extend({}, true, TuliaEditor.defaults, options);

    this.container.set('TuliaEditor.Shared.DependencyInjection.Container', this.container);
    this.container.set('editor', this);
    this.container.set('options', options);
    this.container.set('root', $(selector));

    this.container.get('TuliaEditor.Shared.EventDispatcher.ListenersRegistrator').registerListeners();

    let initiable = this.container.getTaggedServices('initiable');

    for (let i = 0; i < initiable.length; i++) {
        let service = this.container.get(initiable[i].service);

        if (typeof(service.init) !== 'function') {
            throw new Error('Initialable service "' + initiable[i].service + '" has not an "init" function.');
        }

        service.init();
    }

    options.setup(this);

    this.container.get('TuliaEditor.Shared.EventDispatcher.EventDispatcher').dispatch('editor.ready', this);
};

/**
 * @type {String}
 */
TuliaEditor.version = '0.0.1-dev.1';

/**
 * Store all configurations of the Editor.
 * @type {Object}
 */
TuliaEditor.services = {};

/**
 * Default configuration options for editor.
 * @type {Object}
 */
TuliaEditor.defaults = {
    /**
     * Content to render in the editor.
     */
    data: {},
    /**
     * CCC Framework to use in the editor.
     */
    framework: 'bootstrap-5',
    /**
     * Translations locale.
     */
    lang: 'en_US',
    /**
     * Fallbacks locales, used when single translation in `lang` not exists.
     */
    fallbackLangs: ['en_US', 'en'],
    /**
     * Defines whether or not, open editor in editing mode.
     * Default editor stays in preview mode.
     */
    autoopen: false,
    /**
     * Whether or not the editing mode should be opened inline or fullscreen.
     * Default fullscreen.
     */
    inline: false,
    /**
     * Includes used when building canvas.
     */
    include: {
        /**
         * Stylesheets added to canvas. Possible overwrite stylesheets using the same key.
         *  - key is the name of the stylesheets.
         *  - value is the link to the stylesheet.
         */
        stylesheets: {},
        /**
         * Scripts added to canvas. Possible overwrite scripts using the same key.
         *  - key is the name of the script.
         *  - value is the link to the script.
         */
        scripts: {},
    },
    /**
     * Function called after editor is initialized. Allows to bind events.
     */
    setup: function () {},
};

/**
 * Store all available blocks for the editor.
 * @type {Object}
 */
TuliaEditor.blocks = {};

/**
 * Editor translations.
 * @type {Object}
 */
TuliaEditor.i18n = {};
TuliaEditor.i18n['en'] = {
    'save': 'Save',
    'cancel': 'Cancel',
    'remove': 'Remove',
    'block': 'Block',
    'row': 'Row',
    'section': 'Section',
    'column': 'Column',
    'insert': 'Insert',
    'selectedRow': 'Selected row',
    'selectBlock': 'Select block',
    'selectedBlock': 'Selected block',
    'selectedSection': 'Selected section',
    'selectParentBlock': 'Select parent block',
    'emptyColumn': 'Empty column',
    'emptyRow': 'Empty row',
    'emptySection': 'Empty section',
    'insertBlockBeforeSelected': 'Block - Before selected',
    'insertBlockAfterSelected': 'Block - After selected',
    'insertRowBeforeSelected': 'Row - Before selected',
    'insertRowAfterSelected': 'Row - After selected',
    'insertSectionBeforeSelected': 'Section - Before selected',
    'insertSectionAfterSelected': 'Section - After selected',
    'duplicate': 'Duplicate',
    'document': 'Document',
    'lackOfStyle': 'Unstyled',
};
TuliaEditor.i18n['pl'] = {
    'save': 'Zapisz',
    'cancel': 'Anuluj',
    'remove': 'Usuń',
    'block': 'Blok',
    'row': 'Wiersz',
    'section': 'Sekcja',
    'column': 'Kolumna',
    'insert': 'Wstaw',
    'selectedRow': 'Wybrany wiersz',
    'selectBlock': 'Wybierz blok',
    'selectedBlock': 'Wybrany blok',
    'selectedSection': 'Wybrana sekcja',
    'selectParentBlock': 'Zaznacz blok wyżej',
    'emptyColumn': 'Pusta kolumna',
    'emptyRow': 'Pusty wiersz',
    'emptySection': 'Pusta sekcja',
    'insertBlockBeforeSelected': 'Blok - Przed',
    'insertBlockAfterSelected': 'Blok - Poniżej',
    'insertRowBeforeSelected': 'Wiersz - Przed',
    'insertRowAfterSelected': 'Wiersz - Poniżej',
    'insertSectionBeforeSelected': 'Sekcja - Przed',
    'insertSectionAfterSelected': 'Sekcja - Poniżej',
    'duplicate': 'Duplikuj',
    'document': 'Dokument',
    'lackOfStyle': 'Brak stylu',
};

/**
 * Creates namespace for TuliaEditor, and assign class to it.
 * Namespace must follows `TuliaEditor` prefix, example: 'TuliaEditor.Shared.EventDispatcher.EventDispatcher'
 *
 * @param {String} ns
 * @param {Object} cls
 */
TuliaEditor.ns = function (ns, cls) {
    let root = TuliaEditor;
    let splitted = ns.split('.');

    for (let i = 0; i < splitted.length; i++) {
        if (splitted[i] === 'TuliaEditor') {
            continue;
        }

        if (! root[splitted[i]]) {
            if (splitted.length === i) {
                root[splitted[i]] = {};
            } else {
                root[splitted[i]] = cls;
            }
        }

        root = root[splitted[i]];
    }
};

/**
 * Initiates editor in selector with defined options.
 *
 * @param {String} selector
 * @param {Object} options
 * @return {TuliaEditor}
 */
TuliaEditor.create = function (selector, options) {
    return new TuliaEditor(selector, options);
};

/**
 * Registers a block for editor.
 * @param {String} type
 * @param {String} cls
 * @param {Object} info
 */
TuliaEditor.block = function (type, cls, info) {
    let defaults = {
        icon: '',
        author: '',
        name: '',
        description: '',
    };

    TuliaEditor.blocks[type] = {
        class: cls,
        info: $.extend({}, defaults, info)
    };
};

TuliaEditor.uuid = function () {
    return 'xxxxxxxx-xxxx-4xxx-yxxx-xxxxxxxxxxxx'.replace(/[xy]/g, function(c) {
        let r = Math.random() * 16 | 0, v = c == 'x' ? r : (r & 0x3 | 0x8);
        return v.toString(16);
    });
};

window.TuliaEditor = TuliaEditor;

(function () {
    class EventDispatcher {
        events = [];

        /**
         * @param {String} events
         * @param {Object|CallableFunction}listener
         * @param {Number} priority
         * @return {TuliaEditor.Shared.EventDispatcher.EventDispatcher}
         */
        on (events, listener, priority) {
            events = events.split(',');
            priority = priority || 100;

            for (let i = 0; i < events.length; i++) {
                let name = events[i].trim();

                if (this.events[name]) {
                    this.events[name].push({
                        listener: listener,
                        priority: priority
                    });
                } else {
                    this.events[name] = [];
                    this.events[name].push({
                        listener: listener,
                        priority: priority
                    });
                }

                this.events[name].sort(function (a, b) {
                    return b.priority - a.priority;
                });
            }

            return this;
        }

        /**
         * @param {String} name
         * @param {Array} args
         * @return {TuliaEditor.Shared.EventDispatcher.EventDispatcher}
         */
        dispatch (name, ...args) {
            if (! this.events[name]) {
                return this;
            }

            args = args || [];

            let self = this;

            for (let i = 0; i < this.events[name].length; i++) {
                if (typeof(this.events[name][i].listener) !== 'function') {
                    throw new Error('One of the listeners of the "' + name + '" event is not a function.');
                }

                this.events[name][i].listener(...args);
            }

            return this;
        }
    }

    TuliaEditor.ns('TuliaEditor.Shared.EventDispatcher.EventDispatcher', EventDispatcher);
}());

(function () {
    class ListenersRegistrator {
        /**
         * @param {TuliaEditor.Shared.DependencyInjection.Container} container
         * @param {TuliaEditor.Shared.EventDispatcher.EventDispatcher} dispatcher
         */
        constructor(container, dispatcher) {
            this.container = container;
            this.dispatcher = dispatcher;
        }

        registerListeners () {
            let self = this;
            let listeners = this.container.getTaggedServices('event_listener');

            for (let i = 0; i < listeners.length; i++) {
                this.dispatcher.on(
                    listeners[i].tag.listen,
                    function (...args) {
                        let s = self.container.get(listeners[i].service);

                        if (s[listeners[i].tag.method]) {
                            return s[listeners[i].tag.method](...args);
                        } else {
                            throw new Error('Method ' + listeners[i].tag.method + '() of the ' + listeners[i].service + ' service is not callable.');
                        }
                    },
                    listeners[i].tag.priority || 100
                );
            }
        }
    }

    TuliaEditor.ns('TuliaEditor.Shared.EventDispatcher.ListenersRegistrator', ListenersRegistrator);
}());

(function () {
    class Container {
        /**
         * @param {Object} config
         */
        constructor(config) {
            this.config = config;
            this.objects = [];
        }

        /**
         * Build service by it's name, store it's instance in collection
         * and returns it's instance every time when get(name) is called.
         *
         * @param {String} name
         * @return {Object}
         */
        get (name) {
            if (this.objects[name]) {
                return this.objects[name];
            }

            return this.objects[name] = this.build(name);
        };

        /**
         * Build service by it's name every time when produce(name) is called.
         * Every time returns new object.
         *
         * @param {String} name
         * @return {Object}
         */
        produce (name) {
            return this.build(name);
        };

        /**
         * @param {String} name
         * @param {Object} obj
         */
        set (name, obj) {
            this.objects[name] = obj;
        };

        /**
         * @param {String} name
         * @return {Boolean}
         */
        has (name) {
            return !! this.config[name];
        }

        /**
         * @param {String} name
         * @return {Object}
         */
        build (name) {
            let definition = this.config[name];

            if (! definition) {
                throw new Error('Cannot find service ' + name + '.');
            }

            if (! definition.class) {
                throw new Error('Class of service ' + name + ' not exists.');
            }

            let args = this.resolveArguments(definition.arguments);
            let obj = null;

            try {
                obj = new definition.class(...args);
            } catch (error) {
                console.error('Error occured during class instantiating, of service ' + name);
                throw error;
            }

            if (definition.calls) {
                for (let i = 0; i < definition.calls.length; i++) {
                    obj[i].apply(obj, this.resolveArguments(definition.calls[i]));
                }
            }

            return obj;
        };

        /**
         * @param {String} tag
         * @return {Array}
         */
        getTaggedServices (tag) {
            let tagged = [];

            for (let name in this.config) {
                if (this.config[name].tags) {
                    for (let def in this.config[name].tags) {
                        if (this.config[name].tags[def].name === tag) {
                            tagged.push({
                                'service': name,
                                'tag': this.config[name].tags[def],
                            });
                        }
                    }
                }
            }

            return tagged;
        };

        resolveArguments (args) {
            let newArgs = [];

            if (args) {
                for (let i = 0; i < args.length; i++) {
                    newArgs.push(this.resolveArgument(args[i]));
                }
            }

            return newArgs;
        };

        resolveArgument (arg) {
            if (typeof(arg) === 'string') {
                if (arg.substring(0, 1) === '@') {
                    return this.get(arg.substring(1));
                } else {
                    return arg;
                }
            }

            return arg;
        };
    }

    TuliaEditor.ns('TuliaEditor.Shared.DependencyInjection.Container', Container);
}());

(function () {
    class Catalogue {
        /**
         * @param {Object} translations
         */
        constructor (translations) {
            /** @type {Object} */
            this.translations = translations;
        }

        /**
         * @param {String} name
         * @return {String|null}
         */
        get (name) {
            return this.translations[name] ?? null;
        }
    }

    TuliaEditor.ns('TuliaEditor.Shared.I18n.Catalogue', Catalogue);
}());

(function () {
    class Translator {
        /** @type {TuliaEditor.Shared.I18n.Catalogue[]} */
        catalogues = {};

        /**
         * @param {Object} options
         */
        constructor (options) {
            /** @type {Object} */
            this.options = options;
        }

        /**
         * @param {String} name
         * @param {Object} data
         * @param {null|String} lang
         * @return {String}
         */
        trans (name, data, lang) {
            let langs = [lang ?? this.options.lang].concat(this.options.fallbackLangs);
            let translation = null;

            for (let lang of langs) {
                translation = this.getCatalogue(lang).get(name);

                // Break if found in this locale.
                if (translation !== null) {
                    break;
                }
            }

            if (translation === null) {
                translation = name;
            }

            return translation;
        }

        /**
         * @param {String} lang
         * @return {TuliaEditor.Shared.I18n.Catalogue}
         */
        getCatalogue (lang) {
            if (this.catalogues[lang]) {
                return this.catalogues[lang];
            }

            this.catalogues[lang] = new TuliaEditor.Shared.I18n.Catalogue(TuliaEditor.i18n[lang] ?? {});

            return this.catalogues[lang];
        }
    }

    TuliaEditor.ns('TuliaEditor.Shared.I18n.Translator', Translator);
}());


(function () {
    class PropertyAccessor {
        object;

        constructor (object) {
            this.object = object;
        }

        get (property, defaultValue) {
            let parts = this.explode(property);
            let s = this.object;
            defaultValue = defaultValue ?? null;

            for (let i in parts) {
                i = parseInt(i);

                if (i === parts.length - 1) {
                    // End of the loop, get the value.
                    return s[parts[i]] ?? defaultValue;
                } else {
                    if (! s[parts[i]]) {
                        return defaultValue;
                    }

                    s = s[parts[i]];
                }
            }

            return defaultValue;
        }

        set (property, value) {
            let parts = this.explode(property);
            let s = this.object;

            for (let i in parts) {
                i = parseInt(i);

                if (i === parts.length - 1) {
                    // End of the loop, set the value.
                    s[parts[i]] = value;
                } else {
                    if (! s[parts[i]]) {
                        s[parts[i]] = {};
                    }

                    s = s[parts[i]];
                }
            }
        }

        explode (property) {
            return property.split('.');
        }
    }

    TuliaEditor.ns('TuliaEditor.Shared.DataManipulation.PropertyAccessor', PropertyAccessor);
}());

(function() {
    class CanvasSize {
        /**
         * @param {TuliaEditor.Layout.Domain.View.Canvas} canvas
         * @param {TuliaEditor.Document.Infrastructure.FrontendFramework.FrameworkProvider} frameworkProvider
         */
        constructor (canvas, frameworkProvider) {
            /** @type {TuliaEditor.Layout.Domain.View.Canvas} */
            this.canvas = canvas;
            /** @type {TuliaEditor.Document.Infrastructure.FrontendFramework.FrameworkProvider} */
            this.frameworkProvider = frameworkProvider;
        }

        getCurrentBreakpoint () {
            return this.canvas.breakpoint;
        }
    }

    TuliaEditor.ns('TuliaEditor.Layout.Application.Service.CanvasSize', CanvasSize);
}());

(function() {
    class EditControls {
        /** @type {null|TuliaEditor.Document.Domain.Grid.Entity.AbstractEntity} */
        lastRenderedEntity = null;

        /**
         * @param {TuliaEditor.Layout.Domain.EditControls.Collector} collector
         * @param {TuliaEditor.Layout.Infrastructure.EditControls.EditControls} view
         */
        constructor (collector, view) {
            /** @type {TuliaEditor.Layout.Domain.EditControls.Collector} */
            this.collector = collector;
            /** @type {TuliaEditor.Layout.Infrastructure.EditControls.EditControls} */
            this.view = view;
        }

        hideEditControls () {
            this.view.hide();
            this.lastRenderedEntity = true;
        }

        /**
         * @param {TuliaEditor.Document.Domain.Grid.Entity.AbstractEntity} entity
         */
        showEditControls (entity) {
            // Prevent render multiple times for the same entity.
            if (entity === this.lastRenderedEntity) {
                return;
            }

            this.view.show(this.collector.collect(entity));
            this.lastRenderedEntity = entity;
        }

        updateEditControls () {
            if (! this.lastRenderedEntity) {
                return;
            }

            this.view.show(this.collector.collect(this.lastRenderedEntity));
        }
    }

    TuliaEditor.ns('TuliaEditor.Layout.Application.Command.EditControls', EditControls);
}());

(function() {
    class ChangeCanvasSize {
        /**
         * @param {TuliaEditor.Layout.Infrastructure.View.Layout} layout
         */
        constructor (layout) {
            /** @type {TuliaEditor.Layout.Infrastructure.View.Layout} */
            this.layout = layout;
        }

        /**
         * @param {Number} height
         */
        changeHeight (height) {
            this.layout.updateHeight(height);
        }
    }

    TuliaEditor.ns('TuliaEditor.Layout.Application.EventListener.ChangeCanvasSize', ChangeCanvasSize);
}());

(function() {
    class ChangeCanvasBreakpoint {
        /**
         * @param {TuliaEditor.Layout.Domain.View.Canvas} canvas
         */
        constructor (canvas) {
            /** @type {TuliaEditor.Layout.Domain.View.Canvas} */
            this.canvas = canvas;
        }

        /**
         * @param {String} name
         */
        changeBreakpoint (name) {
            this.canvas.changeBreakpoint(name);
        }
    }

    TuliaEditor.ns('TuliaEditor.Layout.Application.EventListener.ChangeCanvasBreakpoint', ChangeCanvasBreakpoint);
}());

(function() {
    class EditControls {
        /**
         * @param {TuliaEditor.Layout.Application.Command.EditControls} command
         */
        constructor (command) {
            /** @type {TuliaEditor.Layout.Application.Command.EditControls} */
            this.command = command;
        }

        hideEditControls () {
            this.command.hideEditControls();
        }

        /**
         * @param {TuliaEditor.Document.Domain.Grid.Entity.AbstractEntity} entity
         */
        showEditControls (entity) {
            this.command.showEditControls(entity);
        }

        updateEditControls () {
            this.command.updateEditControls();
        }
    }

    TuliaEditor.ns('TuliaEditor.Layout.Application.EventListener.EditControls', EditControls);
}());

(function () {
    const preview = '<div class="tued-container tued-preview tued-preview-opened">'
            + '<div class="tued-preview-toolbar"><button type="button" class="tued-btn" data-tued-action="edit">Edit</button></div>'
            + '<iframe class="tued-preview-iframe"></iframe>'
        + '</div>';
    const editor = '<div class="tued-container tued-editor">'
        + '<div class="tued-visual-builder">'
            + '<ul class="tued-context-menu"></ul>'
            + '<div class="tued-modals-container"></div>'
            + '<div class="tued-canvas">'
                + '<div class="tued-canvas-inner">'
                    + '<div class="tued-canvas-sizer"></div>'
                    + '<div class="tued-canvas-device-faker">'
                        + '<div class="tued-element-boundaries tued-element-selected-boundaries tued-hidden">'
                            + '<div class="tued-node-name"></div>'
                        + '</div>'
                        + '<div class="tued-element-boundaries tued-element-hovered-boundaries tued-hidden"></div>'
                        + '<div class="tued-element-actions tued-hidden"></div>'
                        + '<iframe class="tued-iframe"></iframe>'
                    + '</div>'
                + '</div>'
            + '</div>'
            + '<div class="tued-sidebar">'
                + '<div class="tued-sidebar-inner">'
                    + '<div class="tued-controls-group">'
                        + '<button type="button" class="tued-btn" data-tued-action="save">Save</button>&nbsp;'
                        + '<button type="button" class="tued-btn" data-tued-action="cancel">Cancel</button>'
                    + '</div>'
                    + '<div class="tued-edit-controls">'
                        + '<div class="tued-controls-groups"></div>'
                        + '<div class="tued-controls-group"></div>'
                    + '</div>'
                + '</div>'
            + '</div>'
        + '</div>'
    + '</div>';

    class Layout {
        /** @type {jQuery} */
        root = null;

        /** @type {jQuery} */
        preview = null;

        /** @type {jQuery} */
        editor = null;

        /**
         * @param {jQuery} root
         * @param {TuliaEditor.Shared.EventDispatcher.EventDispatcher} eventDispatcher
         * @param {TuliaEditor.Shared.I18n.Translator} translator
         */
        constructor (root, eventDispatcher, translator) {
            /** @type {jQuery} */
            this.root = root;
            /** @type {TuliaEditor.Shared.EventDispatcher.EventDispatcher} */
            this.eventDispatcher = eventDispatcher;
            /** @type {TuliaEditor.Shared.I18n.Translator} */
            this.translator = translator;
        }

        /**
         * @param {String} classname
         */
        addClass (classname) {
            this.editor.find('.tued-visual-builder').addClass(classname);
        }

        updateHeight (height) {
            this.editor.find('.tued-canvas, .tued-iframe, .tued-sidebar').height(height);
        }

        getEditor () {
            return this.editor;
        }

        getPreview () {
            return this.preview;
        }

        getHoverableElementBoundariesNode () {
            return this.editor.find('.tued-element-hovered-boundaries');
        }

        getSelectedElementBoundariesNode () {
            return this.editor.find('.tued-element-selected-boundaries');
        }

        getSelectedElementActionsNode () {
            return this.editor.find('.tued-element-actions');
        }

        getContextMenu () {
            return this.editor.find('.tued-context-menu');
        }

        getModalsNode () {
            return this.editor.find('.tued-modals-container');
        }

        getEditControlsNode () {
            return this.editor.find('.tued-edit-controls');
        }

        getPreviewNode () {
            return this.preview.find('.tued-preview-iframe');
        }

        /**
         * @internal
         */
        createLayout (config) {
            let self = this;
            this.editor = $(editor);
            this.preview = $(preview);

            this.root.html(this.preview);
            this.editor.appendTo('body');

            if (config.inline) {
                this.editor.addClass('tued-placement-inline');
            } else {
                this.editor.addClass('tued-placement-fixed');
            }

            this.editor.find('button[data-tued-action="save"]').text(this.translator.trans('save'));
            this.editor.find('button[data-tued-action="cancel"]').text(this.translator.trans('cancel'));

            this.editor.on('click', '[data-tued-action]', function () {
                self.eventDispatcher.dispatch('layout.view.action.' + $(this).attr('data-tued-action'));
            });
            this.preview.on('click', '[data-tued-action]', function () {
                self.eventDispatcher.dispatch('layout.view.action.' + $(this).attr('data-tued-action'));
            });
        }
    }

    TuliaEditor.ns('TuliaEditor.Layout.Infrastructure.View.Layout', Layout);
}());

(function () {
    class Canvas {
        /**
         * @param {TuliaEditor.Layout.Infrastructure.View.Layout} layout
         * @param {TuliaEditor.Shared.EventDispatcher.EventDispatcher} eventDispatcher
         */
        constructor (layout, eventDispatcher) {
            /** @type {TuliaEditor.Layout.Infrastructure.View.Layout} */
            this.layout = layout;
            /** @type {TuliaEditor.Shared.EventDispatcher.EventDispatcher} */
            this.eventDispatcher = eventDispatcher;
        }

        /**
         * @internal
         */
        init () {
            let self = this;

            this.layout.getEditor().on('click', '.tued-canvas-size', function () {
                self.eventDispatcher.dispatch('layout.canvas.change_breakpoint', $(this).attr('data-breakpoint'));
            });

            this.element.ready(function () {
                self.eventDispatcher.dispatch('layout.canvas.ready');
                self.element.addClass('tued-canvas-loaded');
            });
        }

        /**
         * @param {Number} width
         */
        changeWidth (width) {
            this.layout.getEditor()
                .find('.tued-canvas-size')
                .removeClass('active')
                .filter('[data-breakpoint=' + width + ']')
                .addClass('active')
            ;

            this.layout.getEditor().find('.tued-canvas-device-faker').width(width + 'px');
        }

        createSizing (breakpoints) {
            let node = this.layout.getEditor().find('.tued-canvas-sizer');

            for (let i in breakpoints) {
                let name = breakpoints[i].name;
                let size = breakpoints[i].width;

                node.append('<div class="tued-canvas-size" data-breakpoint="' + name + '" style="width:' + size + 'px"><span class="tued-canvas-size-left">' + size + 'px</span><span class="tued-canvas-size-right">' + size + 'px</span></div>');
            }

            this.layout.getEditor().find('.tued-canvas-inner').width(breakpoints[0].width);
        }

        get element () {
            return this.layout.getEditor().find('.tued-iframe');
        }

        get wrapper () {
            return this.layout.getEditor().find('.tued-canvas');
        }

        get window () {
            let iframe = this.element.get(0);

            return iframe.contentWindow ? iframe.contentWindow : iframe.contentDocument;
        };

        get document () {
            return this.window.document;
        };

        get body () {
            return this.element.contents().find('body');
        };

        get head () {
            return this.element.contents().find('head');
        };

        getOffset () {
            return this.element.offset();
        }

        getScrollTop () {
            return $(this.window).scrollTop();
        }
    }

    TuliaEditor.ns('TuliaEditor.Layout.Infrastructure.View.Canvas', Canvas);
}());

(function() {
    class Renderer {
        /**
         * @param {TuliaEditor.Layout.Infrastructure.View.Layout} layout
         * @param {TuliaEditor.Shared.I18n.Translator} translator
         * @param {TuliaEditor.Shared.EventDispatcher.EventDispatcher} eventDispatcher
         */
        constructor (layout, translator, eventDispatcher) {
            /** @type {TuliaEditor.Layout.Infrastructure.View.Layout} */
            this.layout = layout;
            /** @type {TuliaEditor.Shared.I18n.Translator} */
            this.translator = translator;
            /** @type {TuliaEditor.Shared.EventDispatcher.EventDispatcher} */
            this.eventDispatcher = eventDispatcher;
        }

        hide () {
            let node = this.layout.getEditControlsNode();
            node.find('.tued-controls-groups').empty();
            node.find('.tued-controls-group').remove();
        }

        openGroupControls (name) {
            let root = this.layout.getEditControlsNode();

            root.find('.tued-control-group-label')
                .removeClass('tued-active')
                .filter('[data-tued-edit-controls-group=' + name + ']')
                .addClass('tued-active')
            ;

            root.find('.tued-controls-group')
                .removeClass('tued-active')
                .filter('[data-tued-edit-controls-group=' + name + ']')
                .addClass('tued-active')
            ;
        }

        /**
         * @param {TuliaEditor.Layout.Domain.EditControls.Model.Group[]} groups
         */
        renderGroups (groups) {
            let self = this;
            let root = this.layout.getEditControlsNode();
            let groupsTabs = root.find('.tued-controls-groups');
            let firstGroup = null;

            groupsTabs.empty();
            root.find('.tued-controls-group').remove();

            for (let name in groups) {
                let group = groups[name];

                if (firstGroup === null) {
                    firstGroup = name;
                }

                let translated = this.translator.trans(name);
                groupsTabs.append('<div class="tued-control-group-label" data-tued-edit-controls-group="' + name + '" title="' + translated + '">' + translated + '</div>');

                let controlsNode = $('<div class="tued-controls-group" data-tued-edit-controls-group="' + name + '"></div>');

                for (let control of group.controls) {
                    this.renderControl(controlsNode, control, group.entity);
                }

                root.append(controlsNode);
            }

            root.find('.tued-control-group-label').click(function () {
                self.openGroupControls($(this).attr('data-tued-edit-controls-group'));
            });

            if (firstGroup) {
                this.openGroupControls(firstGroup);
            }
        }

        /**
         * @param {jQuery} node
         * @param {TuliaEditor.Layout.Domain.EditControls.Model.AbstractControl} control
         * @param {TuliaEditor.Document.Domain.Grid.Entity.AbstractEntity} entity
         */
        renderControl (node, control, entity) {
            let self = this;

            let value = control.valueGetter.call(control, entity);
            let callback = function (value) {
                control.callback(entity, value, function () {
                    self.eventDispatcher.dispatch('layout.layout.edit_control.change', control, entity);
                });
            };

            control.translator = this.translator;
            control.node = $('<div></div>');
            control.render(value, callback);

            node.append(control.node);
        }
    }

    TuliaEditor.ns('TuliaEditor.Layout.Infrastructure.EditControls.Renderer', Renderer);
}());

(function() {
    class EditControls {
        /**
         * @param {TuliaEditor.Layout.Infrastructure.View.Layout} layout
         * @param {TuliaEditor.Layout.Infrastructure.EditControls.Renderer} renderer
         */
        constructor (layout, renderer) {
            /** @type {TuliaEditor.Layout.Infrastructure.View.Layout} */
            this.layout = layout;
            /** @type {TuliaEditor.Layout.Infrastructure.EditControls.Renderer} */
            this.renderer = renderer;
        }

        /**
         * @param {TuliaEditor.Layout.Domain.EditControls.Model.Controls} controls
         */
        show (controls) {
            let groups = this.collectNotEmptyGroups(controls);
            this.renderer.renderGroups(groups);
        }

        hide () {
            this.renderer.hide();
        }

        collectNotEmptyGroups (controls) {
            let groups = {};

            for (let name in controls.groups) {
                if (controls.groups[name].isEmpty()) {
                    continue;
                }

                groups[name] = controls.groups[name];
            }

            return groups;
        }
    }

    TuliaEditor.ns('TuliaEditor.Layout.Infrastructure.EditControls.EditControls', EditControls);
}());

(function () {
    class Layout {
        /**
         * @param {TuliaEditor.Layout.Infrastructure.View.Layout} view
         * @param {TuliaEditor.Shared.EventDispatcher.EventDispatcher} eventDispatcher
         * @param {Object} options
         */
        constructor (view, eventDispatcher, options) {
            /** @type {TuliaEditor.Layout.Infrastructure.View.Layout} */
            this.view = view;
            /** @type {TuliaEditor.Shared.EventDispatcher.EventDispatcher} */
            this.eventDispatcher = eventDispatcher;
            /** @type {Object} */
            this.options = options;
        }

        /**
         * @internal
         */
        init () {
            this.view.createLayout({
                inline: this.options.inline
            });
            this.view.addClass('tued-has-sidebar-styles');

            this.view.updateHeight(200);

            this.eventDispatcher.dispatch('layout.view.layout.ready');
        }

        /**
         * @param {String} classname
         */
        addClass (classname) {
            this.view.addClass(classname);
        }
    }

    TuliaEditor.ns('TuliaEditor.Layout.Domain.View.Layout', Layout);
}());

(function () {
    class Canvas {
        /** @type {TuliaEditor.Document.Infrastructure.FrontendFramework.Model.Grid.Breakpoint} */
        breakpoint;

        /**
         * @param {TuliaEditor.Layout.Infrastructure.View.Canvas} view
         * @param {TuliaEditor.Document.Infrastructure.FrontendFramework.FrameworkProvider} frameworkProvider
         */
        constructor (view, frameworkProvider) {
            /** @type {TuliaEditor.Layout.Infrastructure.View.Canvas} */
            this.view = view;
            /** @type {TuliaEditor.Document.Infrastructure.FrontendFramework.FrameworkProvider} */
            this.frameworkProvider = frameworkProvider;
        }

        /**
         * @internal
         */
        init () {
            this.view.createSizing(this.frameworkProvider.getGridSizeProvider().getBreakpoints());
            this.changeBreakpoint(this.frameworkProvider.getGridSizeProvider().getDesktopBreakpoint().name);
        }

        /**
         * @param {String} name
         */
        changeBreakpoint (name) {
            this.breakpoint = this.frameworkProvider.getGridSizeProvider().getBreakpoint(name);
            this.view.changeWidth(this.breakpoint.width);
        }
    }

    TuliaEditor.ns('TuliaEditor.Layout.Domain.View.Canvas', Canvas);
}());

(function () {
    class CanvasSizeWatcher {
        /** @type {null|number} */
        interval = null;

        /** @type {number} */
        lastHeight = 0;

        /**
         * @param {jQuery} iframe
         */
        constructor(iframe) {
            this.iframe = iframe;
        }

        /**
         * @internal
         */
        /*init () {
            let self = this;

            this.onChange(function (height) {
                self.eventDispatcher.dispatch('layout.canvas.height_change', height);
            });
        }*/

        onChange (callback) {
            let self = this;

            let body = this.document.body,
                html = this.document.documentElement;

            this.interval = setInterval(function () {
                let height = Math.max(body.scrollHeight, body.offsetHeight, html.clientHeight, html.scrollHeight, html.offsetHeight);

                if(self.lastHeight !== height) {
                    callback(height);
                    self.lastHeight = height;
                }
            }, 200);
        }

        get window () {
            let iframe = this.iframe.get(0);

            return iframe.contentWindow ? iframe.contentWindow : iframe.contentDocument;
        };

        get document () {
            return this.window.document;
        };
    }

    TuliaEditor.ns('TuliaEditor.Layout.Domain.View.CanvasSizeWatcher', CanvasSizeWatcher);
}());

(function() {
    class Collector {
        /**
         * @param {TuliaEditor.Shared.EventDispatcher.EventDispatcher} eventDispatcher
         * @param {TuliaEditor.Document.Domain.Model.Document} document
         */
        constructor (eventDispatcher, document) {
            /** @type {TuliaEditor.Shared.EventDispatcher.EventDispatcher} */
            this.eventDispatcher = eventDispatcher;
            /** @type {TuliaEditor.Document.Domain.Model.Document} */
            this.document = document;
        }

        /**
         * @param {TuliaEditor.Document.Domain.Grid.Entity.AbstractEntity} element
         * @return {TuliaEditor.Layout.Domain.EditControls.Model.Controls}
         */
        collect (element) {
            let stack = this.document.getStack(element);
            let controls = new TuliaEditor.Layout.Domain.EditControls.Model.Controls();

            for (let entity of stack) {
                let group = new TuliaEditor.Layout.Domain.EditControls.Model.Group(entity);

                this.eventDispatcher.dispatch('domain.layout.edit-controls.collect.' + entity.type, entity, group);

                controls.addGroup(entity.type, group);
            }

            return controls;
        }
    }

    TuliaEditor.ns('TuliaEditor.Layout.Domain.EditControls.Collector', Collector);
}());

(function() {
    class AbstractControl {
        /** @type {jQuery} */
        node;

        /** @type {TuliaEditor.Shared.I18n.Translator} */
        translator;

        /** @type {Function} */
        valueGetter = function () {};

        /**
         * @param {String} id
         * @param {String} label
         * @param {Function} value
         * @param {Function} callback
         * @param {Object} options
         */
        constructor (id, label, value, callback, options) {
            this.id = id;
            this.setLabel(label);
            this.setValue(value);
            this.setCallback(callback);
            this.setOptions(options);
        }

        /**
         * @param {String} label
         * @return {TuliaEditor.Layout.Domain.EditControls.Model.AbstractControl}
         */
        setLabel (label) {
            this.label = label;

            return this;
        }

        /**
         * @param {Function} callback
         * @return {TuliaEditor.Layout.Domain.EditControls.Model.AbstractControl}
         */
        setCallback (callback) {
            this.callback = callback;

            return this;
        }

        /**
         * Value must be the function that returns the value of the entity.
         *
         * @param {Function} value
         * @return {TuliaEditor.Layout.Domain.EditControls.Model.AbstractControl}
         */
        setValue (value) {
            if (!value) {
                this.valueGetter = function () {};
            } else {
                if (typeof (value) === 'function') {
                    this.valueGetter = value;
                } else {
                    console.log(value);
                    throw new Error('Parameter of setValue() must be a function that returns the value for the control.');
                }
            }

            return this;
        }

        /**
         * @param {Object} options
         * @return {TuliaEditor.Layout.Domain.EditControls.Model.AbstractControl}
         */
        setOptions (options) {
            this.options = typeof(options) === 'object' ? options : {};

            return this;
        }

        /**
         * Renders control in given node. Also must bind given callback
         * to element and execute it when value of the control changes.
         * Options param store label, help text and other options
         * used by Control to render.
         *
         * The `onChange(value)` function must be called in this.callback function, after
         * update any HTML nodes. It will always generate some event to update
         * eventually selection of the modified element and other functionalities.
         *
         * @param {*} value
         * @param {Function} onChange
         */
        render (value, onChange) {

        }

        /**
         * Build controls form group with label and other generic HTML informations.
         *
         * @param {jQuery} control
         * @param {Object} options
         * @return {jQuery}
         */
        buildControl (control, options) {
            let node = $('<div class="tued-form-group"></div>');

            if (this.label) {
                node.append('<label class="tued-label">' + this.trans(this.label) + '</label>');
            }

            node.append(control);

            if (options.help_text) {
                node.append('<label class="tued-help-text">' + this.trans(options.help_text) + '</label>');
            }

            return node;
        }

        /**
         * @param {String} name
         * @param {Object} data
         * @param {null|String} lang
         * @return {String}
         */
        trans (name, data, lang) {
            return this.translator.trans(name, data, lang);
        }
    }

    TuliaEditor.ns('TuliaEditor.Layout.Domain.EditControls.Model.AbstractControl', AbstractControl);
}());

(function() {
    class RangeSliderControl extends TuliaEditor.Layout.Domain.EditControls.Model.AbstractControl {
        /**
         * @inheritDoc
         */
        render (value, onChange) {
            let listId = 'range-slide-list-' + TuliaEditor.uuid();

            let input = $('<input type="range" value="" class="tued-form-control" list="' + listId + '" />');

            this.options.min ? input.attr('min', this.options.min) : null;
            this.options.max ? input.attr('max', this.options.max) : null;
            this.options.step ? input.attr('step', this.options.step) : null;

            input.on('change input keyup', function () {
                onChange($(this).val());
            });

            input.val(value);

            this.node.append(this.createList(listId));
            this.node.append(this.buildControl(input, this.options));
        }

        createList (listId) {
            let node = $('<datalist id="' + listId + '"></datalist>');
            let min = parseInt(this.options.min);
            let max = parseInt(this.options.max);
            let step = parseInt(this.options.step);

            for (let i = min; i <= max; i += step) {
                node.append('<option value="' + i + '"></option>');
            }

            node.find('option:first-child').attr('label', min).text(min);
            node.find('option:last-child').attr('label', max).text(max);

            return node;
        }
    }

    TuliaEditor.ns('TuliaEditor.Layout.Domain.EditControls.Model.RangeSliderControl', RangeSliderControl);
}());


(function() {
    class TextControl extends TuliaEditor.Layout.Domain.EditControls.Model.AbstractControl {
        /**
         * @inheritDoc
         */
        render (value, onChange) {
            let input = $('<input type="text" value="" class="tued-form-control" />');
            input.on('change keyup', function () {
                onChange($(this).val());
            });

            input.val(value);

            this.node.append(this.buildControl(input, this.options));
        }
    }

    TuliaEditor.ns('TuliaEditor.Layout.Domain.EditControls.Model.TextControl', TextControl);
}());

(function() {
    class SelectControl extends TuliaEditor.Layout.Domain.EditControls.Model.AbstractControl {
        /**
         * @inheritDoc
         */
        render (value, onChange) {
            let input = $('<select class="tued-form-control"></select>');
            input.on('change', function () {
                onChange($(this).val());
            });

            for (let key in this.options.choices) {
                input.append('<option value="' + key + '">' + this.trans(this.options.choices[key]) + '</option>');
            }

            input.val(value);

            this.node.append(this.buildControl(input, this.options));
        }
    }

    TuliaEditor.ns('TuliaEditor.Layout.Domain.EditControls.Model.SelectControl', SelectControl);
}());

(function() {
    class Group {
        /** @type {TuliaEditor.Layout.Domain.EditControls.Model.AbstractControl[]} */
        controls = [];

        /** @type {TuliaEditor.Document.Domain.Grid.Entity.AbstractEntity} */
        entity;

        /**
         * @param {TuliaEditor.Document.Domain.Grid.Entity.AbstractEntity} entity
         */
        constructor (entity) {
            this.entity = entity;
        }

        /**
         * @return {Boolean}
         */
        isEmpty () {
            return this.controls.length === 0;
        }

        /**
         * @param {String|TuliaEditor.Layout.Domain.EditControls.Model.AbstractControl} control
         * @param {null|String} id
         * @return {TuliaEditor.Layout.Domain.EditControls.Model.AbstractControl}
         */
        addControl (control, id) {
            if (control instanceof TuliaEditor.Layout.Domain.EditControls.Model.AbstractControl) {
                // If control is an instance of TuliaEditor.Layout.Domain.EditControls.Model.AbstractControl
                // we use it as well.
            } else if (typeof(control) === 'string' && typeof(id) === 'string') {
                control = this.createControl(control, id);
            } else {
                throw new Error('Control must be instance of "TuliaEditor.Layout.Domain.EditControls.Model.AbstractControl"');
            }

            this.controls.push(control);

            return control;
        }

        /**
         * @param {String} id
         * @return {null|TuliaEditor.Layout.Domain.EditControls.Model.AbstractControl}
         */
        getControl (id) {
            for (let control of this.controls) {
                if (control.id === id) {
                    return control;
                }
            }
        }

        /**
         * @internal
         * @param {String} type
         * @param {String} id
         * @return {TuliaEditor.Layout.Domain.EditControls.Model.AbstractControl}
         */
        createControl (type, id) {
            switch (type) {
                case 'range-slider':
                    return new TuliaEditor.Layout.Domain.EditControls.Model.RangeSliderControl(id);
                case 'text':
                    return new TuliaEditor.Layout.Domain.EditControls.Model.TextControl(id);
                case 'select':
                    return new TuliaEditor.Layout.Domain.EditControls.Model.SelectControl(id);
            }

            throw new Error('Control type "' + type + '" is not supported.');
        }
    }

    TuliaEditor.ns('TuliaEditor.Layout.Domain.EditControls.Model.Group', Group);
}());

(function() {
    class Controls {
        /** @type {TuliaEditor.Layout.Domain.EditControls.Model.Group[]} */
        groups = {};

        /**
         * @return {Boolean}
         */
        isEmpty () {
            return this.groups.length === 0;
        }

        /**
         * @param {String} name
         * @param {TuliaEditor.Layout.Domain.EditControls.Model.Group} group
         */
        addGroup (name, group) {
            if (! (group instanceof TuliaEditor.Layout.Domain.EditControls.Model.Group)) {
                throw new Error('Group must be instance of "TuliaEditor.Layout.Domain.EditControls.Model.Group"');
            }

            this.groups[name] = group;
        }

        /**
         * @param {String} name
         * @return {null|TuliaEditor.Layout.Domain.EditControls.Model.Group}
         */
        getGroup (name) {
            return this.groups[name] ?? null;
        }

        /**
         * @param {String} name
         * @return {bool}
         */
        hasGroup (name) {
            return !! this.groups[name];
        }
    }

    TuliaEditor.ns('TuliaEditor.Layout.Domain.EditControls.Model.Controls', Controls);
}());

(function () {
    class PrepareDocument {
        /**
         * @param {Object} options
         * @param {TuliaEditor.Document.Domain.Service.SourceParser} sourceParser
         * @param {TuliaEditor.Document.Application.Service.Document} documentService
         * @param {TuliaEditor.Document.Domain.Model.Document} document
         */
        constructor (options, sourceParser, documentService, document) {
            /** @type {Object} */
            this.options = options;
            /** @type {TuliaEditor.Document.Domain.Service.SourceParser} */
            this.sourceParser = sourceParser;
            /** @type {TuliaEditor.Document.Application.Service.Document} */
            this.documentService = documentService;
            /** @type {TuliaEditor.Document.Domain.Model.Document} */
            this.document = document;
        }

        prepareDocument () {
            this.documentService.prepareHead();
            this.createStructure();
        }

        /**
         * @internal
         */
        createStructure () {
            let structure = this.sourceParser.parse(this.options.data?.source?.sections ?? null);

            if (this.options.data?.manifest?.framework && this.options.framework !== this.options.data?.manifest?.framework) {
                alert('Editor\'s framework (' + this.options.framework + ') do not match Document\'s framework (' + this.options.data.manifest.framework + '). These must be the same. Document will not be rendered in editor.');
                structure = new TuliaEditor.Document.Domain.Model.Structure();
            }

            this.document.setStructure(structure);
        }
    }

    TuliaEditor.ns('TuliaEditor.Document.Application.EventListener.Document.PrepareDocument', PrepareDocument);
}());

(function () {
    class SelectedActions {
        /**
         * @param {TuliaEditor.Document.Domain.Model.Document} document
         * @param {TuliaEditor.Shared.I18n.Translator} translator
         * @param {TuliaEditor.Document.Application.Service.StructureManipulator.BlockManipulator} blockManipulator
         * @param {TuliaEditor.Document.Application.Service.StructureManipulator.RowManipulator} rowManipulator
         * @param {TuliaEditor.Document.Application.Service.StructureManipulator.SectionManipulator} sectionManipulator
         */
        constructor (document, translator, blockManipulator, rowManipulator, sectionManipulator) {
            /** @type {TuliaEditor.Document.Domain.Model.Document} */
            this.document = document;
            /** @type {TuliaEditor.Shared.I18n.Translator} */
            this.translator = translator;
            /** @type {TuliaEditor.Document.Application.Service.StructureManipulator.BlockManipulator} */
            this.blockManipulator = blockManipulator;
            /** @type {TuliaEditor.Document.Application.Service.StructureManipulator.RowManipulator} */
            this.rowManipulator = rowManipulator;
            /** @type {TuliaEditor.Document.Application.Service.StructureManipulator.SectionManipulator} */
            this.sectionManipulator = sectionManipulator;
        }

        /**
         * @param {TuliaEditor.Document.Domain.Grid.Entity.AbstractEntity} element
         * @param {TuliaEditor.Selection.Domain.Actions.Model.Actions} actions
         */
        collect (element, actions) {
            if (element instanceof TuliaEditor.Document.Domain.Grid.Entity.Block) {
                this.collectForBlocks(element, actions);
            }
            if (element instanceof TuliaEditor.Document.Domain.Grid.Entity.Column) {
                this.collectForColumns(element, actions);
            }
            if (element instanceof TuliaEditor.Document.Domain.Grid.Entity.Row) {
                this.collectForRows(element, actions);
            }
            if (element instanceof TuliaEditor.Document.Domain.Grid.Entity.Section) {
                this.collectForSections(element, actions);
            }
        }

        /**
         * @param {TuliaEditor.Document.Domain.Grid.Entity.Block} block
         * @param {TuliaEditor.Selection.Domain.Actions.Model.Actions} actions
         */
        collectForBlocks (block, actions) {
            actions.add(this.createDuplicateBlockAction(block));
            actions.add(this.createRemoveBlockAction(block));
        }

        /**
         * @param {TuliaEditor.Document.Domain.Grid.Entity.Column} column
         * @param {TuliaEditor.Selection.Domain.Actions.Model.Actions} actions
         */
        collectForColumns (column, actions) {
            actions.add(this.createRemoveAction(column));
        }

        /**
         * @param {TuliaEditor.Document.Domain.Grid.Entity.Row} row
         * @param {TuliaEditor.Selection.Domain.Actions.Model.Actions} actions
         */
        collectForRows (row, actions) {
            actions.add(this.createRemoveRowAction(row));
        }

        /**
         * @param {TuliaEditor.Document.Domain.Grid.Entity.Section} section
         * @param {TuliaEditor.Selection.Domain.Actions.Model.Actions} actions
         */
        collectForSections (section, actions) {
            actions.add(this.createRemoveSectionAction(section));
        }

        /**
         * @param {TuliaEditor.Document.Domain.Grid.Entity.AbstractEntity} element
         * @return {TuliaEditor.Selection.Domain.Actions.Model.Action}
         */
        createRemoveAction (element) {
            let self = this;
            return new TuliaEditor.Selection.Domain.Actions.Model.Action(
                this.translator.trans('remove'),
                '<i class="fas fa-trash"></i>',
                function (element) {
                    self.document.remove(element);
                }
            );
        }

        /**
         * @param {TuliaEditor.Document.Domain.Grid.Entity.Block} block
         * @return {TuliaEditor.Selection.Domain.Actions.Model.Action}
         */
        createRemoveBlockAction (block) {
            let self = this;
            return new TuliaEditor.Selection.Domain.Actions.Model.Action(
                this.translator.trans('remove'),
                '<i class="fas fa-trash"></i>',
                function (block) {
                    self.blockManipulator.remove(block);
                }
            );
        }

        /**
         * @param {TuliaEditor.Document.Domain.Grid.Entity.Section} section
         * @return {TuliaEditor.Selection.Domain.Actions.Model.Action}
         */
        createRemoveSectionAction (section) {
            let self = this;
            return new TuliaEditor.Selection.Domain.Actions.Model.Action(
                this.translator.trans('remove'),
                '<i class="fas fa-trash"></i>',
                function (section) {
                    self.sectionManipulator.remove(section);
                }
            );
        }

        /**
         * @param {TuliaEditor.Document.Domain.Grid.Entity.Row} row
         * @return {TuliaEditor.Selection.Domain.Actions.Model.Action}
         */
        createRemoveRowAction (row) {
            let self = this;
            return new TuliaEditor.Selection.Domain.Actions.Model.Action(
                this.translator.trans('remove'),
                '<i class="fas fa-trash"></i>',
                function (row) {
                    self.rowManipulator.remove(row);
                }
            );
        }

        /**
         * @param {TuliaEditor.Document.Domain.Grid.Entity.AbstractEntity} element
         * @return {TuliaEditor.Selection.Domain.Actions.Model.Action}
         */
        createDuplicateBlockAction (element) {
            let self = this;
            return new TuliaEditor.Selection.Domain.Actions.Model.Action(
                this.translator.trans('duplicate'),
                '<i class="fas fa-copy"></i>',
                function (element) {self.blockManipulator.duplicate(element);}
            );
        }
    }

    TuliaEditor.ns('TuliaEditor.Document.Application.EventListener.UI.SelectedActions', SelectedActions);
}());

(function () {
    class SectionContextMenu {
        /**
         * @param {TuliaEditor.Shared.I18n.Translator} translator
         * @param {TuliaEditor.Document.Application.Service.StructureManipulator.SectionManipulator} manipulator
         */
        constructor (translator, manipulator) {
            /** @type {TuliaEditor.Shared.I18n.Translator} */
            this.translator = translator;
            /** @type {TuliaEditor.Document.Application.Service.StructureManipulator.SectionManipulator} */
            this.manipulator = manipulator;
        }

        /**
         * @param {TuliaEditor.ContextMenu.Domain.Entity.Menu} menu
         * @param {TuliaEditor.Document.Domain.Grid.Entity.AbstractEntity} entity
         */
        buildForSection (menu, entity) {
            let self = this;
            let rowMenu = menu.find('core.insert').menu;

            rowMenu.addItem(
                new TuliaEditor.ContextMenu.Domain.Entity.Item(
                    'core.section.insert.before',
                    this.translator.trans('insertSectionBeforeSelected'),
                    function () {self.manipulator.createBefore(entity);}
                )
            );

            rowMenu.addItem(
                new TuliaEditor.ContextMenu.Domain.Entity.Item(
                    'core.section.insert.after',
                    this.translator.trans('insertSectionAfterSelected'),
                    function () {self.manipulator.createAfter(entity);}
                )
            );

            menu.find('core.remove').menu.addItem(
                new TuliaEditor.ContextMenu.Domain.Entity.Item(
                    'core.section.remove',
                    this.translator.trans('selectedSection'),
                    function () {self.manipulator.remove(entity);}
                )
            );

            let globalInsertItem = menu.find('core.section.insert');

            if (globalInsertItem instanceof TuliaEditor.ContextMenu.Domain.Entity.Item) {
                menu.removeItem(globalInsertItem);
            }
        }

        /**
         * @param {TuliaEditor.ContextMenu.Domain.Entity.Menu} menu
         */
        buildForRoot (menu) {
            let self = this;

            menu.find('core.insert').menu.addItem(
                new TuliaEditor.ContextMenu.Domain.Entity.Item(
                    'core.section.insert',
                    this.translator.trans('section'),
                    function () {self.manipulator.create();}
                )
            );
        }
    }

    TuliaEditor.ns('TuliaEditor.Document.Application.EventListener.UI.ContextMenu.SectionContextMenu', SectionContextMenu);
}());

(function () {
    class RowContextMenu {
        /**
         * @param {TuliaEditor.Shared.I18n.Translator} translator
         * @param {TuliaEditor.Document.Application.Service.StructureManipulator.RowManipulator} manipulator
         */
        constructor (translator, manipulator) {
            /** @type {TuliaEditor.Shared.I18n.Translator} */
            this.translator = translator;
            /** @type {TuliaEditor.Document.Application.Service.StructureManipulator.RowManipulator} */
            this.manipulator = manipulator;
        }

        /**
         * @param {TuliaEditor.ContextMenu.Domain.Entity.Menu} menu
         * @param {TuliaEditor.Document.Domain.Grid.Entity.Row} entity
         */
        buildForRow (menu, entity) {
            let self = this;
            let rowMenu = menu.find('core.insert').menu;

            rowMenu.addItem(
                new TuliaEditor.ContextMenu.Domain.Entity.Item(
                    'core.row.insert.before',
                    this.translator.trans('insertRowBeforeSelected'),
                    function () {self.manipulator.createBefore(entity);}
                )
            );

            rowMenu.addItem(
                new TuliaEditor.ContextMenu.Domain.Entity.Item(
                    'core.row.insert.after',
                    this.translator.trans('insertRowAfterSelected'),
                    function () {self.manipulator.createAfter(entity);}
                )
            );

            menu.find('core.remove').menu.addItem(
                new TuliaEditor.ContextMenu.Domain.Entity.Item(
                    'core.row.remove',
                    this.translator.trans('selectedRow'),
                    function () {self.manipulator.remove(entity);}
                )
            );
        }

        /**
         * @param {TuliaEditor.ContextMenu.Domain.Entity.Menu} menu
         * @param {TuliaEditor.Document.Domain.Grid.Entity.Section} section
         */
        buildForSection (menu, section) {
            let self = this;

            let item = menu.find('core.row.insert.before');

            if (! (item instanceof TuliaEditor.ContextMenu.Domain.Entity.Item)) {
                menu.find('core.insert').menu.addItem(
                    new TuliaEditor.ContextMenu.Domain.Entity.Item(
                        'core.row.insert',
                        this.translator.trans('row'),
                        function () {self.manipulator.createInto(section);}
                    )
                );
            }
        }
    }

    TuliaEditor.ns('TuliaEditor.Document.Application.EventListener.UI.ContextMenu.RowContextMenu', RowContextMenu);
}());

(function () {
    class BlockContextMenu {
        /**
         * @param {TuliaEditor.Shared.I18n.Translator} translator
         * @param {TuliaEditor.Document.Application.Service.StructureManipulator.BlockManipulator} manipulator
         */
        constructor (translator, manipulator) {
            /** @type {TuliaEditor.Shared.I18n.Translator} */
            this.translator = translator;
            /** @type {TuliaEditor.Document.Application.Service.StructureManipulator.BlockManipulator} */
            this.manipulator = manipulator;
        }

        /**
         * @param {TuliaEditor.ContextMenu.Domain.Entity.Menu} menu
         * @param {TuliaEditor.Document.Domain.Grid.Entity.AbstractEntity} entity
         */
        build (menu, entity) {
            let self = this;
            let blockMenu = menu.find('core.insert').menu;

            blockMenu.addItem(
                new TuliaEditor.ContextMenu.Domain.Entity.Item(
                    'core.block.insert.before',
                    this.translator.trans('insertBlockBeforeSelected'),
                    function () {self.manipulator.createBefore(entity);}
                )
            );

            blockMenu.addItem(
                new TuliaEditor.ContextMenu.Domain.Entity.Item(
                    'core.block.insert.after',
                    this.translator.trans('insertBlockAfterSelected'),
                    function () {self.manipulator.createAfter(entity);}
                )
            );

            menu.find('core.remove').menu.addItem(
                new TuliaEditor.ContextMenu.Domain.Entity.Item(
                    'core.block.remove',
                    this.translator.trans('selectedBlock'),
                    function () {self.manipulator.remove(entity);}
                )
            );

            if (entity instanceof TuliaEditor.Document.Domain.Grid.Entity.Block) {
                let blockSpecialMenu = new TuliaEditor.ContextMenu.Domain.Entity.Menu();

                entity.block.contextmenu(blockSpecialMenu);

                if (blockSpecialMenu.isEmpty() === false) {
                    let item = new TuliaEditor.ContextMenu.Domain.Entity.Item('core.block', this.translator.trans('block'));
                    item.menu = blockSpecialMenu;
                    menu.addItem(item);
                }
            }
        }

        /**
         * @param {TuliaEditor.ContextMenu.Domain.Entity.Menu} menu
         * @param {TuliaEditor.Document.Domain.Grid.Entity.Column} column
         */
        buildForColumn (menu, column) {
            let self = this;
            let blockMenu = menu.find('core.insert').menu;

            /**
             * Do not add global Insert Block option,
             * if there was defined insert options for single block.
             */
            if (menu.find('core.block.insert.after')) {
                return;
            }

            blockMenu.addItem(
                new TuliaEditor.ContextMenu.Domain.Entity.Item(
                    'core.block.insert',
                    this.translator.trans('block'),
                    function () {self.manipulator.createInside(column);}
                )
            );
        }
    }

    TuliaEditor.ns('TuliaEditor.Document.Application.EventListener.UI.ContextMenu.BlockContextMenu', BlockContextMenu);
}());

(function () {
    class RowEditControls {
        /**
         * @param {TuliaEditor.Document.Domain.Grid.Entity.Row} entity
         * @param {TuliaEditor.Layout.Domain.EditControls.Model.Group} group
         */
        collectEditControls (entity, group) {
            group.addControl('select', 'row_width')
                .setValue(function (entity) {
                    return entity.data.style_width ?? 'default';
                    //return entity.node.hasClass('container-fluid') ? 'fluid' : 'default';
                })
                .setLabel('Row width')
                .setOptions({
                    choices: {
                        'default': "Default",
                        'fluid': "Fluid width",
                    }
                })
                .setCallback(function (entity, value, next) {
                    entity.data.style_width = value;
                   /* if (value === 'fluid') {
                        entity.node
                            .removeClass('container')
                            .addClass('container-fluid');
                    } else {
                        entity.node
                            .removeClass('container-fluid')
                            .addClass('container');
                    }*/

                    next();
                })
            ;
        }
    }

    TuliaEditor.ns('TuliaEditor.Document.Application.EventListener.UI.EditControls.RowEditControls', RowEditControls);
}());

(function () {
    class ColumnEditControls {
        /**
         * @type {TuliaEditor.Layout.Application.Service.CanvasSize} canvasSize
         */
        constructor (canvasSize) {
            /** @type {TuliaEditor.Layout.Application.Service.CanvasSize} */
            this.canvasSize = canvasSize;
        }

        /**
         * @param {TuliaEditor.Document.Domain.Grid.Entity.Column} entity
         * @param {TuliaEditor.Layout.Domain.EditControls.Model.Group} group
         */
        collectEditControls (entity, group) {
            let breakpoint = this.canvasSize.getCurrentBreakpoint();

            group.addControl(new TuliaEditor.Document.Domain.EditControls.Model.ColumnWidthControl('column_width'))
                .setValue(function (entity) {
                    return entity.size.get(breakpoint.name);
                })
                .setLabel('Column width')
                .setOptions({
                    min: 1,
                    max: 12,
                    step: 1
                })
                .setCallback(function (entity, value, next) {
                    entity.size.set(new TuliaEditor.Document.Domain.Grid.Entity.Column.Size(breakpoint.name, value));
                    next();
                })
            ;
        }
    }

    TuliaEditor.ns('TuliaEditor.Document.Application.EventListener.UI.EditControls.ColumnEditControls', ColumnEditControls);
}());

(function () {
    class InsertElement {
        /**
         * @param {TuliaEditor.Document.Infrastructure.View.Grid.Grid} view
         */
        constructor (view) {
            /** @type {TuliaEditor.Document.Infrastructure.View.Grid.Grid} */
            this.view = view;
        }

        insertElementIntoView (entity, position, target) {
            this.view.insertElement(entity, position, target);
        }
    }

    TuliaEditor.ns('TuliaEditor.Document.Application.EventListener.Structure.InsertElement', InsertElement);
}());

(function () {
    class RemoveElement {
        /**
         * @param {TuliaEditor.Document.Infrastructure.View.Grid.Grid} view
         */
        constructor (view) {
            /** @type {TuliaEditor.Document.Infrastructure.View.Grid.Grid} */
            this.view = view;
        }

        removeElementFromView (entity) {
            this.view.removeElement(entity);
        }
    }

    TuliaEditor.ns('TuliaEditor.Document.Application.EventListener.Structure.RemoveElement', RemoveElement);
}());

(function () {
    class ReplaceWholeStructure {
        /**
         * @param {TuliaEditor.Document.Infrastructure.View.Grid.Grid} view
         */
        constructor (view) {
            /** @type {TuliaEditor.Document.Infrastructure.View.Grid.Grid} */
            this.view = view;
        }

        replaceWholeStructure (structure) {
            this.view.render(structure);
        }
    }

    TuliaEditor.ns('TuliaEditor.Document.Application.EventListener.Structure.ReplaceWholeStructure', ReplaceWholeStructure);
}());

(function () {
    class UpdateColumnPreview {
        /**
         * @param {TuliaEditor.Document.Infrastructure.View.Structure.NodesStorage} nodesStorage
         * @param {TuliaEditor.Document.Infrastructure.View.Grid.Renderer.ColumnRenderer} renderer
         */
        constructor (nodesStorage, renderer) {
            /** @type {TuliaEditor.Document.Infrastructure.View.Structure.NodesStorage} */
            this.nodesStorage = nodesStorage;
            /** @type {TuliaEditor.Document.Infrastructure.View.Grid.Renderer.ColumnRenderer} */
            this.renderer = renderer;
        }

        /**
         * @param {TuliaEditor.Layout.Domain.EditControls.Model.AbstractControl} control
         * @param {TuliaEditor.Document.Domain.Grid.Entity.AbstractEntity} entity
         */
        updateColumnPreview (control, entity) {
            if (! (entity instanceof TuliaEditor.Document.Domain.Grid.Entity.Column)) {
                return;
            }

            this.renderer.update(entity, this.nodesStorage.get(entity.id));
        }
    }

    TuliaEditor.ns('TuliaEditor.Document.Application.EventListener.Document.Preview.UpdateColumnPreview', UpdateColumnPreview);
}());

(function () {
    class Exporter {
        /**
         * @param {Object} options
         * @param {TuliaEditor.Document.Domain.Model.Document} document
         * @param {TuliaEditor.Document.Infrastructure.View.Grid.Renderer.RendererFactory} rendererFactory
         */
        constructor (options, document, rendererFactory) {
            /** @type {Object} */
            this.options = options;
            /** @type {TuliaEditor.Document.Domain.Model.Document} */
            this.document = document;
            /** @type {TuliaEditor.Document.Infrastructure.View.Grid.Renderer.RendererFactory} */
            this.rendererFactory = rendererFactory;
        }

        /**
         * @return {Object}
         */
        export () {
            let body = $('<div></div>');

            for (let section of this.document.structure.document.sections) {
                body.append(this.renderSection(section));
            }

            return {
                manifest: {
                    version: TuliaEditor.version,
                    framework: this.options.framework
                },
                styles: this.options.include.stylesheets,
                scripts: [],
                source: {
                    sections: this.document.structure.export()
                },
                content: body.html()
            };
        }

        /**
         * @internal
         * @param {TuliaEditor.Document.Domain.Grid.Entity.Section} section
         * @return {jQuery}
         */
        renderSection (section) {
            let rows = $('<div></div>');

            /** @type TuliaEditor.Document.Domain.Grid.Entity.Column column */
            for (let row of section.rows) {
                rows.append(this.renderRow(row));
            }

            return this.rendererFactory.getRenderer('section')
                .export(section, rows.contents());
        }

        /**
         * @internal
         * @param {TuliaEditor.Document.Domain.Grid.Entity.Row} row
         * @return {jQuery}
         */
        renderRow (row) {
            let columns = $('<div></div>');

            /** @type TuliaEditor.Document.Domain.Grid.Entity.Column column */
            for (let column of row.columns) {
                columns.append(this.renderColumn(column));
            }

            return this.rendererFactory.getRenderer('row')
                .export(row, columns.contents());
        }

        /**
         * @internal
         * @param {TuliaEditor.Document.Domain.Grid.Entity.Column} column
         * @return {jQuery}
         */
        renderColumn (column) {
            let blocks = $('<div></div>');

            /** @type TuliaEditor.Document.Domain.Grid.Entity.Block block */
            for (let block of column.blocks) {
                blocks.append(this.renderBlock(block));
            }

            return this.rendererFactory.getRenderer('column')
                .export(column, blocks.contents());
        }

        /**
         * @internal
         * @param {TuliaEditor.Document.Domain.Grid.Entity.Block} block
         * @return {jQuery}
         */
        renderBlock (block) {
            return this.rendererFactory.getRenderer('block')
                .export(block, block.block.compile());
        }
    }

    TuliaEditor.ns('TuliaEditor.Document.Application.Service.Exporter', Exporter);
}());

(function () {
    class SectionManipulator {
        /**
         * @param {TuliaEditor.Document.Domain.Model.Document} document
         */
        constructor (document) {
            /** @type {TuliaEditor.Document.Domain.Model.Document} */
            this.document = document;
        }

        /**
         * @param {TuliaEditor.Document.Domain.Grid.Entity.Section} targetSection
         */
        createAfter (targetSection) {
            this.createSection('after', targetSection);
        }

        /**
         * @param {TuliaEditor.Document.Domain.Grid.Entity.Section} targetSection
         */
        createBefore (targetSection) {
            this.createSection('before', targetSection);
        }

        create () {
            this.createSection();
        }

        /**
         * @param {TuliaEditor.Document.Domain.Grid.Entity.Section} entity
         */
        remove (entity) {
            this.document.remove(entity);
        }

        /**
         * @internal
         */
        createSection (place, target) {
            let entity = new TuliaEditor.Document.Domain.Grid.Entity.Section(
                TuliaEditor.uuid()
            );

            if (place === 'before') {
                this.document.insertSectionBefore(entity, target);
            } else if (place === 'after') {
                this.document.insertSectionAfter(entity, target);
            } else {
                this.document.insertSection(entity);
            }
        }
    }

    TuliaEditor.ns('TuliaEditor.Document.Application.Service.StructureManipulator.SectionManipulator', SectionManipulator);
}());

(function () {
    class RowManipulator {
        /**
         * @param {TuliaEditor.Document.Domain.Model.Document} document
         * @param {TuliaEditor.Document.Infrastructure.FrontendFramework.FrameworkProvider} frameworkProvider
         */
        constructor (document, frameworkProvider) {
            /** @type {TuliaEditor.Document.Domain.Model.Document} */
            this.document = document;
            /** @type {TuliaEditor.Document.Infrastructure.FrontendFramework.FrameworkProvider} */
            this.frameworkProvider = frameworkProvider;
        }

        /**
         * @param {TuliaEditor.Document.Domain.Grid.Entity.Row} row
         */
        createAfter (row) {
            this.createRow('after', row);
        }

        /**
         * @param {TuliaEditor.Document.Domain.Grid.Entity.Row} row
         */
        createBefore (row) {
            this.createRow('before', row);
        }

        /**
         * @param {TuliaEditor.Document.Domain.Grid.Entity.Section} section
         */
        createInto (section) {
            this.createRow('inside', section);
        }

        /**
         * @param {TuliaEditor.Document.Domain.Grid.Entity.Row} row
         */
        remove (row) {
            this.document.remove(row);
        }

        /**
         * @internal
         */
        createRow (place, target) {
            let row = new TuliaEditor.Document.Domain.Grid.Entity.Row(TuliaEditor.uuid());

            let column = new TuliaEditor.Document.Domain.Grid.Entity.Column(TuliaEditor.uuid());
            column.size.set(new TuliaEditor.Document.Domain.Grid.Entity.Column.Size(
                this.frameworkProvider.getGridSizeProvider().getDesktopBreakpoint().name,
                this.frameworkProvider.getGridSizeProvider().getColumnsCount()
            ));

            row.appendColumn(column);

            if (place === 'before') {
                this.document.insertRowBefore(row, target);
            } else if (place === 'after') {
                this.document.insertRowAfter(row, target);
            } else {
                this.document.insertRow(row, target);
            }
        }
    }

    TuliaEditor.ns('TuliaEditor.Document.Application.Service.StructureManipulator.RowManipulator', RowManipulator);
}());

(function () {
    class BlockManipulator {
        /**
         * Store insert informations used when client selects Block from modal.
         *
         * @type {Object}
         */
        insertInfo;

        /**
         * @param {TuliaEditor.Block.Domain.Block.BlockPicker} blocksPicker
         * @param {TuliaEditor.Document.Domain.Service.BlockDuplicator} duplicator
         * @param {TuliaEditor.Document.Domain.Model.Document} document
         */
        constructor (blocksPicker, duplicator, document) {
            /** @type {TuliaEditor.Block.Domain.Block.BlockPicker} */
            this.blocksPicker = blocksPicker;
            /** @type {TuliaEditor.Document.Domain.Service.BlockDuplicator} */
            this.duplicator = duplicator;
            /** @type {TuliaEditor.Document.Domain.Model.Document} */
            this.document = document;
        }

        /**
         * @param {TuliaEditor.Document.Domain.Grid.Entity.Block} targetBlock
         */
        createAfter (targetBlock) {
            this.insertInfo = {
                column: targetBlock.parent,
                after: targetBlock
            };

            this.createBlock();
        }

        /**
         * @param {TuliaEditor.Document.Domain.Grid.Entity.Block} targetBlock
         */
        createBefore (targetBlock) {
            this.insertInfo = {
                column: targetBlock.column,
                before: targetBlock
            };

            this.createBlock();
        }

        /**
         * @param {TuliaEditor.Document.Domain.Grid.Entity.Column} column
         */
        createInside (column) {
            this.insertInfo = {
                column: column
            };

            this.createBlock();
        }

        /**
         * @param {TuliaEditor.Document.Domain.Grid.Entity.Block} block
         */
        duplicate (block) {
            let duplicate = this.duplicator.duplicate(block);
            this.document.insertBlockAfter(duplicate, block);
        }

        /**
         * @param {TuliaEditor.Document.Domain.Grid.Entity.Block} entity
         */
        remove (entity) {
            this.document.remove(entity);
        }

        /**
         * @internal
         */
        createBlock () {
            let self = this;

            this.blocksPicker.open(function (name) {
                self.insert(name);
                self.blocksPicker.close();
            });
        }

        /**
         * @internal
         * @param {TuliaEditor.Document.Domain.Grid.Entity.Block} block
         */
        insert (block) {
            let entity = new TuliaEditor.Document.Domain.Grid.Entity.Block(
                TuliaEditor.uuid(),
                block
            );

            entity.data = block.getDefaultData();
            entity.block.data = entity.data;

            if (this.insertInfo.before) {
                this.document.insertBlockBefore(entity, this.insertInfo.before);
            } else if (this.insertInfo.after) {
                this.document.insertBlockAfter(entity, this.insertInfo.after);
            } else {
                this.document.insertBlock(entity, this.insertInfo.column);
            }

            this.insertInfo = {};
        }
    }

    TuliaEditor.ns('TuliaEditor.Document.Application.Service.StructureManipulator.BlockManipulator', BlockManipulator);
}());

(function () {
    class Document {
        /** @type {object} */
        stylesheets = {};

        /** @type {object} */
        scripts = {};

        /**
         * @param {Object} options
         * @param {TuliaEditor.Document.Infrastructure.View.Document} view
         * @param {TuliaEditor.Shared.I18n.Translator} translator
         */
        constructor (options, view, translator) {
            /** @type {Object} */
            this.options = options;
            /** @type {TuliaEditor.Document.Infrastructure.View.Document} */
            this.view = view;
            /** @type {TuliaEditor.Shared.I18n.Translator} */
            this.translator = translator;
        }

        addStylesheet (name, link) {
            this.stylesheets[name] = link;
            this.view.refreshStylesheets(this.stylesheets);
        }

        addScript (name, link) {
            this.scripts[name] = link;
            this.view.refreshScripts(this.scripts);
        }

        /**
         * @internal
         */
        prepareHead () {
            this.prepareStylesheets();
            this.prepareScripts();

            this.view.addTag('<meta charset="utf-8">');
            this.view.addTag('<meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">');
            this.view.addTag('<style>\
                body {padding-top:25px;padding-bottom:25px;}\
                /*body:hover,\
                body *:hover {cursor:default !important;}\
                body *[tued-selectable]:hover,\
                body *[tued-selectable] *:hover {cursor:pointer !important;}\
                */\
                body.tued-movable-active *[tued-selectable]:hover,\
                body.tued-movable-active *[tued-selectable] *:hover {cursor:move !important;}\
                body.tued-movable-active .tued-movable-placeholder:hover {cursor:move !important;}\
                .tued-prevent-scroll {overflow:hidden !important;}\
                [tued-editor-text-empty] {min-height:12px;min-width:20px;max-width:100%;display:inline-block;}\
                [contenteditable]:focus {outline:none !important}\
                body .tued-block-movable {position:absolute;z-index:1000;left:0;top:0;right:0;background-color:#fff !important;pointer-events:none;}\
                \
                body/*.tued-show-blocks-guides*/ [data-tued-element] {padding:20px 0;}\
                body/*.tued-show-blocks-guides*/ [data-tued-element]:before {position:absolute;left:0;top:0;z-index:100;display:block;padding:4px 9px;font-size:11px;color:#000;background-color:#fff;opacity:.7;content:attr(data-tued-element);pointer-events:none}\
                body/*.tued-show-blocks-guides*/ [data-tued-element]:after {content:"";display:block;position:absolute;left:0;top:0;right:0;bottom:0;z-index:200;pointer-events:none;border:1px dashed #ddd;}\
                \
                .tued-repeatable-button {display:none;position:relative;border-radius:3px;overflow:hidden;min-height:50px;}\
                .tued-repeatable-button-label {position:absolute;left:0;top:0;right:0;bottom:0;z-index:10;background-color:#fff;border:1px solid #ddd;border-radius:3px;transition:.12s all}\
                .tued-repeatable-button-label:hover {cursor:pointer;border-color:#0088cc;background-color:rgba(0,136,204,.2)}\
                .tued-repeatable-button-label > div {display:table;width:100%;height:100%}\
                .tued-repeatable-button-label > div > div {display:table-cell;vertical-align:middle;text-align:center;font-size:14px;color:#000;}\
                \
                body/*.tued-show-blocks-guides*/ .tued-repeatable-button {display:block;}\
                \
                .tued-node-column-placeholder:empty,\
                .tued-node-row-placeholder:empty,\
                .tued-node-section-placeholder:empty {min-height:50px;position:relative;border:1px dashed #dcdcdc;}\
                .tued-node-column-placeholder:empty:before,\
                .tued-node-row-placeholder:empty:before,\
                .tued-node-section-placeholder:empty:before {display:block;position:absolute;left:50%;top:50%;transform:translate(-50%,-50%);color:#dcdcdc;text-transform:uppercase;font-size:12px;}\
                .tued-node-column-placeholder:empty:before {content:"' + this.translator.trans('emptyColumn') + '";}\
                .tued-node-row-placeholder:empty:before {content:"' + this.translator.trans('emptyRow') + '";}\
                .tued-node-section-placeholder:empty:before {content:"' + this.translator.trans('emptySection') + '";}\
                \
                .tued-btn {display:inline-block;font-weight:400;text-align:center;white-space:nowrap;vertical-align:middle; -webkit-user-select:none; -moz-user-select:none; -ms-user-select:none;user-select:none;border:1px solid #0088cc;padding:9px 13px;font-size:13px;line-height:1;border-radius:3px;transition:color .15s ease-in-out,background-color .15s ease-in-out,border-color .15s ease-in-out,box-shadow .15s ease-in-out;color:#0088cc;background-color:#fff;}\
                \
                /** Mark editable textx for preview with dashed outline on hover. */\
                [data-tued-editable]:hover {outline:1px dashed #bbb;cursor:text;}\
                /** Prevents empty inline-editable element to dissapear. */\
                [data-tued-editable]:empty:before {content:"\\a0";display:inline;line-height:inherit;}\
            </style>');

            this.view.refreshStylesheets(this.stylesheets);
        }

        /**
         * @internal
         */
        prepareStylesheets () {
            for (let name in this.options.include.stylesheets) {
                this.addStylesheet(name, this.options.include.stylesheets[name]);
            }
        }

        /**
         * @internal
         */
        prepareScripts () {
            for (let name in this.options.include.scripts) {
                this.addScript(name, this.options.include.scripts[name]);
            }
        }
    }

    TuliaEditor.ns('TuliaEditor.Document.Application.Service.Document', Document);
}());

(function () {
    class StructureEntityDataAccessor {
        /**
         * @param {TuliaEditor.Shared.EventDispatcher.EventDispatcher} eventDispatcher
         */
        constructor (eventDispatcher) {
            /** @type {TuliaEditor.Shared.EventDispatcher.EventDispatcher} */
            this.eventDispatcher = eventDispatcher;
        }

        /**
         * @param {TuliaEditor.Document.Domain.Grid.Entity.AbstractEntity} entity
         */
        update (entity) {
            this.eventDispatcher.dispatch('domain.document.grid.element.updated', entity);
        }

        setValue (entity, property, value) {
            let accessor = new TuliaEditor.Shared.DataManipulation.PropertyAccessor(entity.data);
            accessor.set(property, value);

            this.update(entity);
        }
    }

    TuliaEditor.ns('TuliaEditor.Document.Application.Service.StructureEntityDataAccessor', StructureEntityDataAccessor);
}());

(function() {
    class ColumnWidthControl extends TuliaEditor.Layout.Domain.EditControls.Model.AbstractControl {
        /**
         * @inheritDoc
         */
        render (value, onChange) {
            let listId = 'range-slide-list-' + TuliaEditor.uuid();

            let cont = $('<div class="tued-form-group">' +
                '  <label class="tued-label">' + this.trans(this.label) + '</label>' +
                '  <div class="tued-input-group mb-3">' +
                '    <div class="tued-input-group-text">' +
                '      <input class="tued-form-check-input mt-0" type="checkbox" />' +
                '    </div>' +
                '    <input type="range" class="tued-form-range" list="' + listId + '" />' +
                '  </div>' +
                '</div>');

            let range = cont.find('.tued-form-range');
            let disabler = cont.find('.tued-form-check-input');

            this.options.min ? range.attr('min', this.options.min) : null;
            this.options.max ? range.attr('max', this.options.max) : null;
            this.options.step ? range.attr('step', this.options.step) : null;

            range.on('change input keyup', function () {
                onChange($(this).val());
            });

            if (value) {
                range.val(value);
                disabler.attr('checked', 'checked');
                range.removeAttr('disabled');
            } else {
                range.val(0);
                range.attr('disabled', 'disabled');
                disabler.removeAttr('checked');
            }

            disabler.on('change', function () {
                if ($(this).is(':checked')) {
                    range.removeAttr('disabled');
                } else {
                    range.val(1).attr('disabled', 'disabled');
                    onChange(null);
                }
            });

            this.node.append(this.createList(listId));
            this.node.append(cont);
        }

        createList (listId) {
            let node = $('<datalist id="' + listId + '"></datalist>');
            let min = parseInt(this.options.min);
            let max = parseInt(this.options.max);
            let step = parseInt(this.options.step);

            for (let i = min; i <= max; i += step) {
                node.append('<option value="' + i + '"></option>');
            }

            node.find('option:first-child').attr('label', min).text(min);
            node.find('option:last-child').attr('label', max).text(max);

            return node;
        }
    }

    TuliaEditor.ns('TuliaEditor.Document.Domain.EditControls.Model.ColumnWidthControl', ColumnWidthControl);
}());

(function () {
    class Document {
        /** @type {TuliaEditor.Document.Domain.Model.Structure} */
        structure;

        /** @type {Array} */
        operationsStack = [];

        /**
         * @param {TuliaEditor.Shared.EventDispatcher.EventDispatcher} eventDispatcher
         */
        constructor (eventDispatcher) {
            /** @type {TuliaEditor.Shared.EventDispatcher.EventDispatcher} */
            this.eventDispatcher = eventDispatcher;
        }

        /**
         * @param {TuliaEditor.Document.Domain.Model.Structure} structure
         */
        setStructure (structure) {
            this.structure = structure;
            this.eventDispatcher.dispatch('domain.document.grid.structure.replace', structure);
        }

        /**
         * @param {String} id
         * @return {null|TuliaEditor.Document.Domain.Grid.Entity.AbstractEntity}
         */
        get (id) {
            return this.structure.get(id);
        }

        /**
         * @param {TuliaEditor.Document.Domain.Grid.Entity.AbstractEntity|TuliaEditor.Document.Domain.Model.Structure} element
         * @return {TuliaEditor.Document.Domain.Grid.Entity.AbstractEntity[]|TuliaEditor.Document.Domain.Model.Structure[]}
         */
        getStack (element) {
            let stack = [element];

            while (element.parent) {
                stack.push(element.parent);

                element = element.parent;
            }

            return stack;
        }

        /**
         * @param {TuliaEditor.Document.Domain.Grid.Entity.Section} section
         */
        insertSection (section) {
            this.structure.insertSection(section);
            this.operationsStack.push({
                type: 'insert',
                position: 'inside',
                entity: section,
                target: this.structure
            });
            this.commit();
        }

        /**
         * @param {TuliaEditor.Document.Domain.Grid.Entity.Section} section
         * @param {TuliaEditor.Document.Domain.Grid.Entity.Section} after
         */
        insertSectionAfter (section, after) {
            this.structure.insertSectionAfter(section, after);
            this.operationsStack.push({
                type: 'insert',
                position: 'after',
                entity: section,
                target: after
            });
            this.commit();
        }

        /**
         * @param {TuliaEditor.Document.Domain.Grid.Entity.Section} section
         * @param {TuliaEditor.Document.Domain.Grid.Entity.Section} before
         */
        insertSectionBefore (section, before) {
            this.structure.insertSectionBefore(section, before);
            this.operationsStack.push({
                type: 'insert',
                position: 'before',
                entity: section,
                target: before
            });
            this.commit();
        }

        /**
         * @param {TuliaEditor.Document.Domain.Grid.Entity.Row} row
         * @param {TuliaEditor.Document.Domain.Grid.Entity.Section} section
         */
        insertRow (row, section) {
            this.structure.insertRow(row, section);
            this.operationsStack.push({
                type: 'insert',
                position: 'inside',
                entity: row,
                target: section
            });
            this.commit();
        }

        /**
         * @param {TuliaEditor.Document.Domain.Grid.Entity.Row} row
         * @param {TuliaEditor.Document.Domain.Grid.Entity.Row} after
         */
        insertRowAfter (row, after) {
            this.structure.insertRowAfter(row, after);
            this.operationsStack.push({
                type: 'insert',
                position: 'after',
                entity: row,
                target: after
            });
            this.commit();
        }

        /**
         * @param {TuliaEditor.Document.Domain.Grid.Entity.Row} row
         * @param {TuliaEditor.Document.Domain.Grid.Entity.Row} before
         */
        insertRowBefore (row, before) {
            this.structure.insertRowBefore(row, before);
            this.operationsStack.push({
                type: 'insert',
                position: 'before',
                entity: row,
                target: before
            });
            this.commit();
        }

        /**
         * @param {TuliaEditor.Document.Domain.Grid.Entity.Block} block
         * @param {TuliaEditor.Document.Domain.Grid.Entity.Block} before
         */
        insertBlockBefore (block, before) {
            this.structure.insertBlockBefore(block, before);
            this.operationsStack.push({
                type: 'insert',
                position: 'before',
                entity: block,
                target: before
            });
            this.commit();
        }

        /**
         * @param {TuliaEditor.Document.Domain.Grid.Entity.Block} block
         * @param {TuliaEditor.Document.Domain.Grid.Entity.Block} after
         */
        insertBlockAfter (block, after) {
            this.structure.insertBlockAfter(block, after);
            this.operationsStack.push({
                type: 'insert',
                position: 'after',
                entity: block,
                target: after
            });
            this.commit();
        }

        /**
         * @param {TuliaEditor.Document.Domain.Grid.Entity.Block} block
         * @param {TuliaEditor.Document.Domain.Grid.Entity.Column} column
         */
        insertBlock (block, column) {
            this.structure.insertBlock(block, column);
            this.operationsStack.push({
                type: 'insert',
                position: 'inside',
                entity: block,
                target: column
            });
            this.commit();
        }

        /**
         * @param {TuliaEditor.Document.Domain.Grid.Entity.Row|TuliaEditor.Document.Domain.Grid.Entity.Column|TuliaEditor.Document.Domain.Grid.Entity.Block} entity
         */
        remove (entity) {
            this.structure.remove(entity);
            this.operationsStack.push({
                type: 'remove',
                entity: entity,
            });
            this.commit();
        }

        commit () {
            let events = [];

            for (let operation of this.operationsStack) {
                if (operation.type === 'remove') {
                    events.push({
                        name: 'removed',
                        arguments: [operation.entity]
                    });
                }

                if (operation.type === 'insert') {
                    events.push({
                        name: 'inserted',
                        arguments: [
                            operation.entity,
                            operation.position,
                            operation.target
                        ]
                    });
                }
            }

            this.operationsStack = [];

            for (let event of events) {
                this.eventDispatcher.dispatch('domain.document.grid.element.' + event.name, ...event.arguments);
            }
        }
    }

    TuliaEditor.ns('TuliaEditor.Document.Domain.Model.Document', Document);
}());

(function () {
    class Structure {
        /** @type {TuliaEditor.Document.Domain.Grid.Entity.Document} */
        document;

        /**
         * @param {TuliaEditor.Document.Domain.Grid.Entity.Document} document
         */
        constructor (document) {
            /** @type {TuliaEditor.Document.Domain.Grid.Entity.Document} */
            this.document = document;
        }

        get id () {
            return 'structure';
        }

        get type () {
            return 'structure';
        }

        /**
         * Finds Grid element by jQuery element.
         * Search by ID stored in 'data-tued-element-id' attribute.
         *
         * @param {jQuery} element
         * @return {null|TuliaEditor.Document.Domain.Grid.Entity.AbstractEntity}
         */
        findByElement (element) {
            return this.get(element.attr('data-tued-element-id'));
        }

        /**
         * @param {String} id
         * @return {null|TuliaEditor.Document.Domain.Grid.Entity.AbstractEntity}
         */
        get (id) {
            for (let section of this.document.sections) {
                if (section.id === id) {
                    return section;
                }

                for (let row of section.rows) {
                    if (row.id === id) {
                        return row;
                    }

                    for (let column of row.columns) {
                        if (column.id === id) {
                            return column;
                        }

                        for (let block of column.blocks) {
                            if (block.id === id) {
                                return block;
                            }
                        }
                    }
                }
            }

            return null;
        }

        remove (element) {
            let id = element.id;
            let remove = function (item, items) {
                let index = items.indexOf(item);
                if (index > -1) {
                    items.splice(index, 1);
                }
            };

            for (let section of this.document.sections) {
                if (section.id === id) {
                    remove(section, this.document.sections);
                    return;
                }

                for (let row of section.rows) {
                    if (row.id === id) {
                        remove(row, section.rows);
                        return;
                    }

                    for (let column of row.columns) {
                        if (column.id === id) {
                            remove(column, row.columns);
                            return;
                        }

                        for (let block of column.blocks) {
                            if (block.id === id) {
                                remove(block, column.blocks);
                                return;
                            }
                        }
                    }
                }
            }
        }

        /**
         * @param {TuliaEditor.Document.Domain.Grid.Entity.Section} section
         */
        insertSection (section) {
            if (! (section instanceof TuliaEditor.Document.Domain.Grid.Entity.Section)) {
                throw new Error('Section must be instance of "TuliaEditor.Document.Domain.Grid.Entity.Section".');
            }

            this.document.appendSection(section);
        }

        /**
         * @param {TuliaEditor.Document.Domain.Grid.Entity.Section} section
         * @param {TuliaEditor.Document.Domain.Grid.Entity.Section} after
         */
        insertSectionAfter (section, after) {
            if (! (section instanceof TuliaEditor.Document.Domain.Grid.Entity.Section)) {
                throw new Error('Section must be instance of "TuliaEditor.Document.Domain.Grid.Entity.Section".');
            }

            if (! (after instanceof TuliaEditor.Document.Domain.Grid.Entity.Section)) {
                throw new Error('The "after" element must be instance of "TuliaEditor.Document.Domain.Grid.Entity.Section".');
            }

            for (let i in this.document.sections) {
                if (this.document.sections[i].id === after.id) {
                    this.document.sections.splice(i++, 0, section);

                    section.parent = this.document;
                    break;
                }
            }
        }

        /**
         * @param {TuliaEditor.Document.Domain.Grid.Entity.Section} section
         * @param {TuliaEditor.Document.Domain.Grid.Entity.Section} before
         */
        insertSectionBefore (section, before) {
            if (! (section instanceof TuliaEditor.Document.Domain.Grid.Entity.Section)) {
                throw new Error('Row must be instance of "TuliaEditor.Document.Domain.Grid.Entity.Section".');
            }

            if (! (before instanceof TuliaEditor.Document.Domain.Grid.Entity.Section)) {
                throw new Error('The "before" element must be instance of "TuliaEditor.Document.Domain.Grid.Entity.Section".');
            }

            for (let i in this.document.sections) {
                if (this.document.sections[i].id === before.id) {
                    this.document.sections.splice(i, 0, section);

                    section.parent = this.document;
                    break;
                }
            }
        }

        /**
         * @param {TuliaEditor.Document.Domain.Grid.Entity.Row} row
         * @param {TuliaEditor.Document.Domain.Grid.Entity.Section} section
         */
        insertRow (row, section) {
            if (! (row instanceof TuliaEditor.Document.Domain.Grid.Entity.Row)) {
                throw new Error('Row must be instance of "TuliaEditor.Document.Domain.Grid.Entity.Row".');
            }
            if (! (section instanceof TuliaEditor.Document.Domain.Grid.Entity.Section)) {
                throw new Error('Section must be instance of "TuliaEditor.Document.Domain.Grid.Entity.Section".');
            }

            section.appendRow(row);
        }

        /**
         * @param {TuliaEditor.Document.Domain.Grid.Entity.Row} row
         * @param {TuliaEditor.Document.Domain.Grid.Entity.Row} after
         */
        insertRowAfter (row, after) {
            if (! (row instanceof TuliaEditor.Document.Domain.Grid.Entity.Row)) {
                throw new Error('Row must be instance of "TuliaEditor.Document.Domain.Grid.Entity.Row".');
            }

            if (! (after instanceof TuliaEditor.Document.Domain.Grid.Entity.Row)) {
                throw new Error('The "after" element must be instance of "TuliaEditor.Document.Domain.Grid.Entity.Row".');
            }

            for (let i in after.parent.rows) {
                if (after.parent.rows[i].id === after.id) {
                    after.parent.rows.splice(i++, 0, row);

                    row.parent = after.parent;
                    break;
                }
            }
        }

        /**
         * @param {TuliaEditor.Document.Domain.Grid.Entity.Row} row
         * @param {TuliaEditor.Document.Domain.Grid.Entity.Row} before
         */
        insertRowBefore (row, before) {
            if (! (row instanceof TuliaEditor.Document.Domain.Grid.Entity.Row)) {
                throw new Error('Row must be instance of "TuliaEditor.Document.Domain.Grid.Entity.Row".');
            }

            if (! (before instanceof TuliaEditor.Document.Domain.Grid.Entity.Row)) {
                throw new Error('The "before" element must be instance of "TuliaEditor.Document.Domain.Grid.Entity.Row".');
            }

            for (let i in before.parent.rows) {
                if (before.parent.rows[i].id === before.id) {
                    before.parent.rows.splice(i, 0, row);

                    row.parent = before.parent;
                    break;
                }
            }
        }

        /**
         * @param {TuliaEditor.Document.Domain.Grid.Entity.Block} block
         * @param {TuliaEditor.Document.Domain.Grid.Entity.Column} column
         */
        insertBlock (block, column) {
            if (! (block instanceof TuliaEditor.Document.Domain.Grid.Entity.Block)) {
                throw new Error('Block must be instance of "TuliaEditor.Document.Domain.Grid.Entity.Block".');
            }
            if (! (column instanceof TuliaEditor.Document.Domain.Grid.Entity.Column)) {
                throw new Error('Column must be instance of "TuliaEditor.Document.Domain.Grid.Entity.Column".');
            }

            column.appendBlock(block);
        }

        /**
         * @param {TuliaEditor.Document.Domain.Grid.Entity.Block} block
         * @param {TuliaEditor.Document.Domain.Grid.Entity.Block} after
         */
        insertBlockAfter (block, after) {
            if (! (block instanceof TuliaEditor.Document.Domain.Grid.Entity.Block)) {
                throw new Error('Row must be instance of "TuliaEditor.Document.Domain.Grid.Entity.Block".');
            }

            if (! (after instanceof TuliaEditor.Document.Domain.Grid.Entity.Block)) {
                throw new Error('The "after" element must be instance of "TuliaEditor.Document.Domain.Grid.Entity.Block".');
            }

            for (let i in after.parent.blocks) {
                if (after.parent.blocks[i].id === after.id) {
                    after.parent.blocks.splice(i++, 0, block);

                    block.parent = after.parent;
                    break;
                }
            }
        }

        /**
         * @param {TuliaEditor.Document.Domain.Grid.Entity.Block} block
         * @param {TuliaEditor.Document.Domain.Grid.Entity.Block} before
         */
        insertBlockBefore (block, before) {
            if (! (block instanceof TuliaEditor.Document.Domain.Grid.Entity.Block)) {
                throw new Error('Row must be instance of "TuliaEditor.Document.Domain.Grid.Entity.Block".');
            }

            if (! (before instanceof TuliaEditor.Document.Domain.Grid.Entity.Block)) {
                throw new Error('The "before" element must be instance of "TuliaEditor.Document.Domain.Grid.Entity.Block".');
            }

            for (let i in before.parent.blocks) {
                if (before.parent.blocks[i].id === before.id) {
                    before.parent.blocks.splice(i, 0, block);

                    block.parent = before.parent;
                    break;
                }
            }
        }

        export () {
            let data = [];

            for (let section of this.document.sections) {
                data.push(section.export());
            }

            return data;
        }

        /**
         * @param {Number} deep 1=Rows, 2=Rows+Columns, 3=Rows+Columns+Blocks
         * @return {string}
         */
        dump (deep) {
            let result = '';
            deep = deep || 3;

            for (let row of this.document.rows) {
                result += 'row - ' + row.id + "\n";

                if (deep >= 2) {
                    for (let column of row.columns) {
                        result += '  column - ' + column.id + "\n";

                        if (deep >= 3) {
                            for (let block of column.blocks) {
                                result += '    block - ' + block.id + "\n";
                            }
                        }
                    }
                }
            }

            return result;
        }
    }

    TuliaEditor.ns('TuliaEditor.Document.Domain.Model.Structure', Structure);
}());

(function () {
    class AbstractEntity {
        /** @type {TuliaEditor.Document.Domain.Grid.Entity.AbstractEntity} */
        parent;

        /**
         * @type {Object}
         */
        data = {};

        export () {
            return {};
        }
    }

    TuliaEditor.ns('TuliaEditor.Document.Domain.Grid.Entity.AbstractEntity', AbstractEntity);
}());

(function () {
    class Document extends TuliaEditor.Document.Domain.Grid.Entity.AbstractEntity {
        /** @type {TuliaEditor.Document.Domain.Grid.Entity.Row[]} */
        sections = [];

        get type () {
            return 'document';
        }

        /**
         * @param {TuliaEditor.Document.Domain.Grid.Entity.Row} section
         */
        appendSection (section) {
            if (! (section instanceof TuliaEditor.Document.Domain.Grid.Entity.Section)) {
                throw new Error('Row must be instance of "TuliaEditor.Document.Domain.Grid.Entity.Section".');
            }

            section.parent = this;
            this.sections.push(section);
        }
    }

    TuliaEditor.ns('TuliaEditor.Document.Domain.Grid.Entity.Document', Document);
}());

(function () {
    class Section extends TuliaEditor.Document.Domain.Grid.Entity.AbstractEntity {
        /** @type {TuliaEditor.Document.Domain.Grid.Entity.Row[]} */
        rows = [];

        /** @type {String} */
        id;

        /**
         * @param {String} id
         */
        constructor (id) {
            super();

            /** @type {String} */
            this.id = id;
        }

        get type () {
            return 'section';
        }

        /**
         * @param {TuliaEditor.Document.Domain.Grid.Entity.Row} row
         */
        appendRow (row) {
            if (! (row instanceof TuliaEditor.Document.Domain.Grid.Entity.Row)) {
                throw new Error('Row must be instance of "TuliaEditor.Document.Domain.Grid.Entity.Row".');
            }

            row.parent = this;
            this.rows.push(row);
        }

        export () {
            let rows = [];

            for (let c in this.rows) {
                rows.push(this.rows[c].export());
            }

            return {
                id: this.id,
                rows: rows
            }
        }
    }

    TuliaEditor.ns('TuliaEditor.Document.Domain.Grid.Entity.Section', Section);
}());

(function () {
    class Row extends TuliaEditor.Document.Domain.Grid.Entity.AbstractEntity {
        /** @type {String} */
        id;

        /** @type {TuliaEditor.Document.Domain.Grid.Entity.Column[]} */
        columns = [];

        /**
         * @param {String} id
         */
        constructor (id) {
            super();

            /** @type {String} */
            this.id = id;
        }

        get type () {
            return 'row';
        }

        /**
         * @param {TuliaEditor.Document.Domain.Grid.Entity.Column} column
         */
        appendColumn (column) {
            if (! column instanceof TuliaEditor.Document.Domain.Grid.Entity.Column) {
                throw new Error('Column must be instance of "TuliaEditor.Document.Domain.Grid.Entity.Column" class.');
            }

            column.parent = this;

            this.columns.push(column);
        }

        export () {
            let columns = [];

            for (let c in this.columns) {
                columns.push(this.columns[c].export());
            }

            return {
                id: this.id,
                columns: columns
            }
        }
    }

    TuliaEditor.ns('TuliaEditor.Document.Domain.Grid.Entity.Row', Row);
}());

(function () {
    class Column extends TuliaEditor.Document.Domain.Grid.Entity.AbstractEntity {
        /** @type {String} */
        id;

        /** @type {TuliaEditor.Document.Domain.Grid.Entity.Block[]} */
        blocks = [];

        /** @type {TuliaEditor.Document.Domain.Grid.Entity.Column.SizeCollection} */
        size;

        /**
         * @param {String} id
         */
        constructor (id) {
            super();

            /** @type {String} */
            this.id = id;

            /** @type {TuliaEditor.Document.Domain.Grid.Entity.Column.SizeCollection} */
            this.size = new TuliaEditor.Document.Domain.Grid.Entity.Column.SizeCollection();
        }

        get type () {
            return 'column';
        }

        /**
         * @param {TuliaEditor.Document.Domain.Grid.Entity.Block} block
         */
        appendBlock (block) {
            if (! (block instanceof TuliaEditor.Document.Domain.Grid.Entity.Block)) {
                throw new Error('Block must be instance of "TuliaEditor.Document.Domain.Grid.Entity.Block" class.');
            }

            block.parent = this;

            this.blocks.push(block);
        }

        export () {
            let blocks = [];

            for (let b in this.blocks) {
                blocks.push(this.blocks[b].export());
            }

            return {
                id: this.id,
                row_id: this.parent.id,
                size: this.size.serialize(),
                blocks: blocks
            }
        }
    }

    TuliaEditor.ns('TuliaEditor.Document.Domain.Grid.Entity.Column', Column);
}());

(function () {
    class Block extends TuliaEditor.Document.Domain.Grid.Entity.AbstractEntity {
        /** @type {String} */
        id;

        /** @type {TuliaEditor.Block.Domain.Block.AbstractBlock} */
        block;

        /**
         * @param {String} id
         * @param {TuliaEditor.Block.Domain.Block.AbstractBlock} block
         */
        constructor (id, block) {
            super();

            /** @type {String} */
            this.id = id;
            /** @type {TuliaEditor.Block.Domain.Block.AbstractBlock} */
            this.block = block;
        }

        get type () {
            return 'block';
        }

        /**
         * @return {Object}
         */
        export () {
            return {
                id: this.id,
                column_id: this.parent.id,
                type: this.block.type,
                data: this.block.export()
            }
        }
    }

    TuliaEditor.ns('TuliaEditor.Document.Domain.Grid.Entity.Block', Block);
}());

(function () {
    class Size {
        /**
         * @param {String} breakpoint
         * @param {Number} size
         */
        constructor (breakpoint, size) {
            this.breakpoint = breakpoint;
            this.size = parseInt(size);
        }
    }

    TuliaEditor.ns('TuliaEditor.Document.Domain.Grid.Entity.Column.Size', Size);
}());

(function () {
    class SizeCollection {
        /** @type {TuliaEditor.Document.Domain.Grid.Entity.Column.Size[]} */
        collection = [];

        /**
         * @param {TuliaEditor.Document.Domain.Grid.Entity.Column.Size} size
         */
        set (size) {
            for (let i in this.collection) {
                if (this.collection[i].breakpoint === size.breakpoint) {
                    this.collection[i] = size;
                    return;
                }
            }

            this.collection.push(size);
        }

        get (breakpoint) {
            for (let size of this.collection) {
                if (size.breakpoint === breakpoint) {
                    return size.size;
                }
            }
        }

        serialize () {
            let sizes = [];

            for (let size of this.collection) {
                sizes.push({
                    breakpoint: size.breakpoint,
                    size: size.size
                });
            }

            return sizes;
        }
    }

    TuliaEditor.ns('TuliaEditor.Document.Domain.Grid.Entity.Column.SizeCollection', SizeCollection);
}());

(function () {
    class SourceParser {
        /**
         * @param {TuliaEditor.Block.Domain.Block.BlocksRegistry} blocksRegistry
         */
        constructor (blocksRegistry) {
            /** @type {TuliaEditor.Block.Domain.Block.BlocksRegistry} */
            this.blocksRegistry = blocksRegistry;
        }

        /**
         * @param {Object} source
         * @return {TuliaEditor.Document.Domain.Model.Structure}
         */
        parse (source) {
            /** @type {TuliaEditor.Document.Domain.Grid.Entity.Document} document */
            let document = new TuliaEditor.Document.Domain.Grid.Entity.Document();

            if (Array.isArray(source)) {
                for (let s in source) {
                    let section = new TuliaEditor.Document.Domain.Grid.Entity.Section(
                        source[s].id ?? TuliaEditor.uuid()
                    );
                    section.data = source[s].data ?? {};

                    for (let r in source[s].rows) {
                        let row = new TuliaEditor.Document.Domain.Grid.Entity.Row(
                            source[s].rows[r].id ?? TuliaEditor.uuid()
                        );
                        row.data = source[s].rows[r].data ?? {};

                        for (let c in source[s].rows[r].columns) {
                            let column = new TuliaEditor.Document.Domain.Grid.Entity.Column(
                                source[s].rows[r].columns[c].id ?? TuliaEditor.uuid()
                            );
                            column.data = source[s].rows[r].columns[c].data ?? {};
                            this.parseSize(column, source[s].rows[r].columns[c].size);

                            for (let b in source[s].rows[r].columns[c].blocks) {
                                let block = new TuliaEditor.Document.Domain.Grid.Entity.Block(
                                    source[s].rows[r].columns[c].blocks[b].id ?? TuliaEditor.uuid(),
                                    this.blocksRegistry.get(source[s].rows[r].columns[c].blocks[b].type)
                                );
                                block.data = source[s].rows[r].columns[c].blocks[b].data ?? {};

                                column.appendBlock(block);
                            }

                            row.appendColumn(column);
                        }

                        section.appendRow(row);
                    }

                    document.appendSection(section);
                }
            }

            return new TuliaEditor.Document.Domain.Model.Structure(document);
        }

        /**
         * @internal
         * @param {TuliaEditor.Document.Domain.Grid.Entity.Column} column
         * @param {Object} source
         */
        parseSize (column, source) {
            for (let size of source) {
                if (this.sizeContainsRequiredData(size)) {
                    column.size.set(new TuliaEditor.Document.Domain.Grid.Entity.Column.Size(
                        size.breakpoint,
                        size.size,
                    ));
                }
            }
        }

        /**
         * @internal
         * @param {Object} size
         * @return {boolean}
         */
        sizeContainsRequiredData (size) {
            return size.breakpoint && typeof(size.breakpoint) === 'string'
                && size.size && typeof(size.size) === 'number';
        }
    }

    TuliaEditor.ns('TuliaEditor.Document.Domain.Service.SourceParser', SourceParser);
}());

(function () {
    class BlockDuplicator {
        /**
         * @param {TuliaEditor.Block.Domain.Block.BlocksRegistry} blocksRegistry
         */
        constructor(blocksRegistry) {
            /** @type {TuliaEditor.Block.Domain.Block.BlocksRegistry} */
            this.blocksRegistry = blocksRegistry;
        }

        /**
         * @param {TuliaEditor.Document.Domain.Grid.Entity.Block} block
         */
        duplicate (block) {
            let blockData = block.export();

            let duplicate = new TuliaEditor.Document.Domain.Grid.Entity.Block(
                TuliaEditor.uuid(),
                this.blocksRegistry.get(blockData.type)
            );

            duplicate.data = $.extend({}, true, blockData.data);
            duplicate.block.data = duplicate.data;

            return duplicate;
        }
    }

    TuliaEditor.ns('TuliaEditor.Document.Domain.Service.BlockDuplicator', BlockDuplicator);
}());

(function () {
    class Document {
        /**
         * @param {TuliaEditor.Layout.Infrastructure.View.Canvas} canvas
         */
        constructor (canvas) {
            /** @type {TuliaEditor.Layout.Infrastructure.View.Canvas} */
            this.canvas = canvas;
        }

        addTag (tag) {
            this.canvas.head.append(tag);
        }

        refreshStylesheets (stylesheets) {
            let head = this.canvas.head;
            head.find('.tued-stylesheet').remove();

            for (let name in stylesheets) {
                head.append('<link rel="stylesheet" type="text/css" class="tued-stylesheet" data-name="' + name + '" href="' + stylesheets[name] + '" />');
            }
        }

        refreshScripts (scripts) {
            let head = this.canvas.head;
            head.find('.tued-script').remove();

            for (let name in scripts) {
                head.append('<script class="tued-script" data-name="' + name + '" src="' + scripts[name] + '"></script>');
            }
        }
    }

    TuliaEditor.ns('TuliaEditor.Document.Infrastructure.View.Document', Document);
}());

(function () {
    class Grid {
        /**
         * @param {TuliaEditor.Layout.Infrastructure.View.Canvas} canvas
         * @param {TuliaEditor.Document.Infrastructure.View.Grid.Renderer.RendererFactory} rendererFactory
         * @param {TuliaEditor.Document.Infrastructure.View.Structure.NodesStorage} storage
         */
        constructor (canvas, rendererFactory, storage) {
            /** @type {TuliaEditor.Layout.Infrastructure.View.Canvas} */
            this.canvas = canvas;
            /** @type {TuliaEditor.Document.Infrastructure.View.Grid.Renderer.RendererFactory} */
            this.rendererFactory = rendererFactory;
            /** @type {TuliaEditor.Document.Infrastructure.View.Structure.NodesStorage} */
            this.storage = storage;
        }

        /**
         * Renders page content and appends it to the Canvas.
         *
         * @param {TuliaEditor.Document.Domain.Model.Structure} structure
         */
        render (structure) {
            let body = this.canvas.body;
            this.storage.set('structure', body);

            body.empty();

            for (let section of structure.document.sections) {
                body.append(this.renderSection(section, 'preview'));
            }
        }

        /**
         * @param {TuliaEditor.Document.Domain.Grid.Entity.Row|TuliaEditor.Document.Domain.Grid.Entity.Column|TuliaEditor.Document.Domain.Grid.Entity.Block} element
         */
        removeElement (element) {
            this.storage.get(element.id).remove();
            this.storage.remove(element.id);
        }

        /**
         * @param {TuliaEditor.Document.Domain.Grid.Entity.Row|TuliaEditor.Document.Domain.Grid.Entity.Column|TuliaEditor.Document.Domain.Grid.Entity.Block} element
         * @param {String} position
         * @param {TuliaEditor.Document.Domain.Grid.Entity.Row|TuliaEditor.Document.Domain.Grid.Entity.Column|TuliaEditor.Document.Domain.Grid.Entity.Block|null} target
         */
        insertElement (element, position, target) {
            if (element instanceof TuliaEditor.Document.Domain.Grid.Entity.Block) {
                this.renderBlock(element);
            }
            if (element instanceof TuliaEditor.Document.Domain.Grid.Entity.Column) {
                this.renderColumn(element);
            }
            if (element instanceof TuliaEditor.Document.Domain.Grid.Entity.Row) {
                this.renderRow(element);
            }
            if (element instanceof TuliaEditor.Document.Domain.Grid.Entity.Section) {
                this.renderSection(element);
            }

            let targetNode = this.storage.get(target.id);
            let sourceNode = this.storage.get(element.id);

            if (position === 'before') {
                sourceNode.insertBefore(targetNode);
            }
            if (position === 'after') {
                sourceNode.insertAfter(targetNode);
            }
            if (position === 'inside') {
                targetNode.append(sourceNode);
            }
        }

        /**
         * @param {TuliaEditor.Document.Domain.Grid.Entity.Section} section
         * @return {jQuery}
         */
        renderSection (section) {
            let rows = $('<div></div>');

            /** @type TuliaEditor.Document.Domain.Grid.Entity.Column column */
            for (let row of section.rows) {
                rows.append(this.renderRow(row));
            }

            let node = this.rendererFactory.getRenderer('section').render(section, rows.contents());

            this.storage.set(section.id, node);

            return node;
        }

        /**
         * @param {TuliaEditor.Document.Domain.Grid.Entity.Row} row
         * @return {jQuery}
         */
        renderRow (row) {
            let columns = $('<div></div>');

            /** @type TuliaEditor.Document.Domain.Grid.Entity.Column column */
            for (let column of row.columns) {
                columns.append(this.renderColumn(column));
            }

            let node = this.rendererFactory.getRenderer('row').render(row, columns.contents());

            this.storage.set(row.id, node);

            return node;
        }

        /**
         * @param {TuliaEditor.Document.Domain.Grid.Entity.Column} column
         * @return {jQuery}
         */
        renderColumn (column) {
            let blocks = $('<div></div>');

            /** @type TuliaEditor.Document.Domain.Grid.Entity.Block block */
            for (let block of column.blocks) {
                blocks.append(this.renderBlock(block));
            }

            let node = this.rendererFactory.getRenderer('column').render(column, blocks.contents());

            this.storage.set(column.id, node);

            return node;
        }

        /**
         * @param {TuliaEditor.Document.Domain.Grid.Entity.Block} entity
         * @return {jQuery}
         */
        renderBlock (entity) {
            entity.block.node = $('<div></div>');
            entity.block.data = entity.data;
            entity.block.render();

            let node = this.rendererFactory.getRenderer('block').render(entity, entity.block.node);

            this.storage.set(entity.id, node);

            return node;
        }
    }

    TuliaEditor.ns('TuliaEditor.Document.Infrastructure.View.Grid.Grid', Grid);
}());

(function () {
    class RendererFactory {
        /**
         * @param {TuliaEditor.Document.Infrastructure.View.Grid.Renderer.SectionRenderer} sectionRenderer
         * @param {TuliaEditor.Document.Infrastructure.View.Grid.Renderer.RowRenderer} rowRenderer
         * @param {TuliaEditor.Document.Infrastructure.View.Grid.Renderer.ColumnRenderer} columnRenderer
         * @param {TuliaEditor.Document.Infrastructure.View.Grid.Renderer.BlockRenderer} blockRenderer
         */
        constructor (sectionRenderer, rowRenderer, columnRenderer, blockRenderer) {
            /** @type {TuliaEditor.Document.Infrastructure.View.Grid.Renderer.SectionRenderer} */
            this.sectionRenderer = sectionRenderer;
            /** @type {TuliaEditor.Document.Infrastructure.View.Grid.Renderer.RowRenderer} */
            this.rowRenderer = rowRenderer;
            /** @type {TuliaEditor.Document.Infrastructure.View.Grid.Renderer.ColumnRenderer} */
            this.columnRenderer = columnRenderer;
            /** @type {TuliaEditor.Document.Infrastructure.View.Grid.Renderer.BlockRenderer} */
            this.blockRenderer = blockRenderer;
        }

        getRenderer (type) {
            if (type === 'section') {
                return this.sectionRenderer;
            }
            if (type === 'row') {
                return this.rowRenderer;
            }
            if (type === 'column') {
                return this.columnRenderer;
            }
            if (type === 'block') {
                return this.blockRenderer;
            }
        }
    }

    TuliaEditor.ns('TuliaEditor.Document.Infrastructure.View.Grid.Renderer.RendererFactory', RendererFactory);
}());

(function () {
    class SectionRenderer {
        /**
         * @param {TuliaEditor.Document.Domain.Grid.Entity.Section} section
         * @param {jQuery} content
         * @return {jQuery}
         */
        render (section, content) {
            let node = $('<div class="tued-node-section tued-node-section-placeholder" id="tued-section-id-' + section.id + '" data-tued-element-id="' + section.id + '" data-tued-selectable data-tued-contextmenu="section"></div>');

            node.append(content);

            return node;
        }

        /**
         * @param {TuliaEditor.Document.Domain.Grid.Entity.Section} section
         * @param {jQuery} content
         * @return {jQuery}
         */
        export (section, content) {
            let elm = $('<section class="tued-node-section" id="tued-section-id-' + section.id + '"></section>');

            elm.append(content);

            return elm;
        }
    }

    TuliaEditor.ns('TuliaEditor.Document.Infrastructure.View.Grid.Renderer.SectionRenderer', SectionRenderer);
}());

(function () {
    class RowRenderer {
        /**
         * @param {TuliaEditor.Document.Domain.Grid.Entity.Row} row
         * @param {jQuery} content
         * @return {jQuery}
         */
        render (row, content) {
            let node = $('<div class="tued-node-row container" id="tued-row-id-' + row.id + '" data-tued-element-id="' + row.id + '" data-tued-selectable data-tued-contextmenu="row"><div class="row tued-node-row-placeholder"></div></div>');

            node.find('.row').append(content);

            return node;
        }

        /**
         * @param {TuliaEditor.Document.Domain.Grid.Entity.Row} row
         * @param {jQuery} content
         * @return {jQuery}
         */
        export (row, content) {
            let elm = $('<div class="tued-node-row container" id="tued-row-id-' + row.id + '"><div class="row"></div></div>');

            elm.find('.row').append(content);

            return elm;
        }
    }

    TuliaEditor.ns('TuliaEditor.Document.Infrastructure.View.Grid.Renderer.RowRenderer', RowRenderer);
}());

(function () {
    class ColumnRenderer {
        DEFAULT_CLASSLIST = 'tued-node-column tued-node-column-placeholder';

        /**
         * @param {TuliaEditor.Document.Infrastructure.FrontendFramework.FrameworkProvider} frameworkProvider
         */
        constructor (frameworkProvider) {
            /** @type {TuliaEditor.Document.Infrastructure.FrontendFramework.FrameworkProvider} */
            this.frameworkProvider = frameworkProvider;
        }

        /**
         * @param {TuliaEditor.Document.Domain.Grid.Entity.Column} column
         * @param {jQuery} content
         * @return {jQuery}
         */
        render (column, content) {
            let node = $('<div class="' + this.DEFAULT_CLASSLIST + '" id="tued-column-id-' + column.id + '" data-tued-element-id="' + column.id + '" data-tued-selectable data-tued-contextmenu="column"></div>');

            for (let size of column.size.collection) {
                node.addClass(this.frameworkProvider.getGridSizeProvider().getSizeClass(size.size, size.breakpoint));
            }

            node.append(content);

            return node;
        }

        /**
         * @param {TuliaEditor.Document.Domain.Grid.Entity.Column} column
         * @param {jQuery} node
         */
        update (column, node) {
            let classlist = this.DEFAULT_CLASSLIST;

            for (let size of column.size.collection) {
                classlist += ' ' + this.frameworkProvider.getGridSizeProvider().getSizeClass(size.size, size.breakpoint);
            }

            node.attr('class', classlist);
        }

        /**
         * @param {TuliaEditor.Document.Domain.Grid.Entity.Column} column
         * @param {jQuery} content
         * @return {jQuery}
         */
        export (column, content) {
            let elm = $('<div class="tued-node-column col-sm" id="tued-column-id-' + column.id + '"></div>');

            elm.append(content);

            return elm;
        }
    }

    TuliaEditor.ns('TuliaEditor.Document.Infrastructure.View.Grid.Renderer.ColumnRenderer', ColumnRenderer);
}());

(function () {
    class BlockRenderer {
        /**
         * @param {TuliaEditor.Document.Domain.Grid.Entity.Block} block
         * @param {jQuery} content
         * @return {jQuery}
         */
        render (block, content) {
            let node = $('<div class="tued-node-block" id="tued-block-id-' + block.id + '" data-tued-element-id="' + block.id + '" data-tued-selectable data-tued-contextmenu="block"></div>');

            node.append(content);

            return node;
        }

        /**
         * @param {TuliaEditor.Document.Domain.Grid.Entity.Block} block
         * @param {jQuery} content
         * @return {jQuery}
         */
        export (block, content) {
            let elm = $('<div class="tued-node-block" id="tued-block-id-' + block.id + '"></div>');

            elm.append(content);

            return elm;
        }
    }

    TuliaEditor.ns('TuliaEditor.Document.Infrastructure.View.Grid.Renderer.BlockRenderer', BlockRenderer);
}());

(function () {
    class NodesStorage {
        /** @type {jQuery[]} */
        nodes = {};

        /**
         * @param {TuliaEditor.Layout.Infrastructure.View.Canvas} canvas
         */
        constructor (canvas) {
            /** @type {TuliaEditor.Layout.Infrastructure.View.Canvas} */
            this.canvas = canvas;
        }

        /**
         * @param {String} id
         * @return {boolean}
         */
        has (id) {
            return !! this.nodes[id];
        }

        /**
         * @param {String} id
         * @return {null|jQuery}
         */
        get (id) {
            return this.nodes[id] ?? null;
        }

        /**
         * @param {String} id
         * @param {jQuery} node
         */
        set (id, node) {
            this.nodes[id] = node;
        }

        /**
         * @param {String} id
         */
        remove (id) {
            if (this.has(id)) {
                delete this.nodes[id];
            }
        }

        /**
         * @param {jQuery} node
         * @return {String|null}
         */
        getIdByNode (node) {
            for (let id in this.nodes) {
                if (node.is(this.nodes[id])) {
                    return id;
                }
            }

            return this.getIdByNode(node.parent());
        }
    }

    TuliaEditor.ns('TuliaEditor.Document.Infrastructure.View.Structure.NodesStorage', NodesStorage);
}());

(function () {
    class FrameworkProvider {
        /** @type {TuliaEditor.Document.Infrastructure.FrontendFramework.Contract.AbstractFramework} */
        provider = null;

        /**
         * @param {Object} options
         * @param {TuliaEditor.Shared.DependencyInjection.Container} container
         */
        constructor (options, container) {
            /** @type {TuliaEditor.Document.Infrastructure.FrontendFramework.Contract.AbstractSizeProvider} */
            this.options = options;

            let services = container.getTaggedServices('document.framework.type');
            let types = [];

            for (let i = 0; i < services.length; i++) {
                types.push(services[i].tag.type);

                if (this.options.framework === services[i].tag.type) {
                    this.provider = container.get(services[i].service);
                }
            }

            if (this.provider === null) {
                let alertText = 'Unsupported Framework setted. Available are only ' + types.join(', ') + '.';
                alert(alertText);
                throw new Error(alertText);
            }
        }

        /**
         * Grid size (columns width) provider.
         *
         * @return {TuliaEditor.Document.Infrastructure.FrontendFramework.Proxy.ColumnSizeProvider}
         */
        getGridSizeProvider () {
            return new TuliaEditor.Document.Infrastructure.FrontendFramework.Proxy.ColumnSizeProvider(this.provider.getGridSizeProvider());
        }

        /**
         * Margin/padding provider for all types of the content (sections, rows, columns and blocks).
         */
        getSizingProvider () {

        }
    }

    TuliaEditor.ns('TuliaEditor.Document.Infrastructure.FrontendFramework.FrameworkProvider', FrameworkProvider);
}());

(function () {
    class AbstractFramework {
        /**
         * Grid size (columns width) provider.
         *
         * @return {TuliaEditor.Document.Infrastructure.FrontendFramework.Contract.AbstractSizeProvider}
         */
        getGridSizeProvider () {

        }

        /**
         * Margin/padding provider for all types of the content (sections, rows, columns and blocks).
         */
        getSizingProvider () {

        }

        /**
         * Tells whether the Framework supports Mobile-First or is tradittionally Desktop-First.
         *
         * @return {boolean}
         */
        isMobileFirst () {
            return false;
        }
    }

    TuliaEditor.ns('TuliaEditor.Document.Infrastructure.FrontendFramework.Contract.AbstractFramework', AbstractFramework);
}());

(function () {
    class AbstractSizeProvider {
        /**
         * @return {String}
         */
        get framework () {
            return '';
        }

        /**
         * @param {String} size
         * @param {String} breakpoint
         * @return {String}
         */
        getSizeClass (size, breakpoint) {
            return '';
        }

        /**
         * @return {Number}
         */
        getColumnsCount () {
            return 12;
        }

        /**
         * @return {Array}
         */
        getBreakpoints () {
            return [new TuliaEditor.Document.Infrastructure.FrontendFramework.Model.Grid.Breakpoint('desktop', 1200)];
        }

        /**
         * @return {TuliaEditor.Document.Infrastructure.FrontendFramework.Model.Grid.Breakpoint}
         */
        getDesktopBreakpoint () {
            return this.getBreakpoints()[0];
        }
    }

    TuliaEditor.ns('TuliaEditor.Document.Infrastructure.FrontendFramework.Contract.AbstractSizeProvider', AbstractSizeProvider);
}());

(function () {
    class Bootstrap5Framework extends TuliaEditor.Document.Infrastructure.FrontendFramework.Contract.AbstractFramework {
        /**
         * @return {TuliaEditor.Document.Infrastructure.FrontendFramework.BuiltInFramework.Bootstrap5.SizeProvider}
         */
        getGridSizeProvider () {
            return new TuliaEditor.Document.Infrastructure.FrontendFramework.BuiltInFramework.Bootstrap5.SizeProvider();
        }

        /**
         * @return {Boolean}
         */
        isMobileFirst () {
            return true;
        }
    }

    TuliaEditor.ns('TuliaEditor.Document.Infrastructure.FrontendFramework.BuiltInFramework.Bootstrap5.Bootstrap5Framework', Bootstrap5Framework);

    TuliaEditor.services['TuliaEditor.Document.Infrastructure.FrontendFramework.BuiltInFramework.Bootstrap5.Bootstrap5Framework'] = {
        'class': Bootstrap5Framework,
        'tags': [
            {'name': 'document.framework.type', 'type': 'bootstrap-5'},
        ]
    };
}());

(function () {
    class SizeProvider extends TuliaEditor.Document.Infrastructure.FrontendFramework.Contract.AbstractSizeProvider {
        /**
         * @inheritDoc
         */
        get framework () {
            return 'bootstrap-5';
        }

        /**
         * @inheritDoc
         */
        getSizeClass (size, breakpoint) {
            let sizeClass = 'col-';

            switch (breakpoint) {
                case 'xs': break;
                case 'sm': sizeClass += 'sm-'; break;
                case 'md': sizeClass += 'md-'; break;
                case 'lg': sizeClass += 'lg-'; break;
                case 'xl': sizeClass += 'xl-'; break;
                case 'xxl': sizeClass += 'xxl-'; break;
            }

            switch (size) {
                case 1: sizeClass += '1'; break;
                case 2: sizeClass += '2'; break;
                case 3: sizeClass += '3'; break;
                case 4: sizeClass += '4'; break;
                case 5: sizeClass += '5'; break;
                case 6: sizeClass += '6'; break;
                case 7: sizeClass += '7'; break;
                case 8: sizeClass += '8'; break;
                case 9: sizeClass += '9'; break;
                case 10: sizeClass += '10'; break;
                case 11: sizeClass += '11'; break;
                case 12: sizeClass += '12'; break;
            }

            return sizeClass;
        }

        /**
         * @inheritDoc
         */
        getBreakpoints () {
            return [
                new TuliaEditor.Document.Infrastructure.FrontendFramework.Model.Grid.Breakpoint('xxl', 1400),
                new TuliaEditor.Document.Infrastructure.FrontendFramework.Model.Grid.Breakpoint('xl', 1200),
                new TuliaEditor.Document.Infrastructure.FrontendFramework.Model.Grid.Breakpoint('lg', 992),
                new TuliaEditor.Document.Infrastructure.FrontendFramework.Model.Grid.Breakpoint('md', 768),
                new TuliaEditor.Document.Infrastructure.FrontendFramework.Model.Grid.Breakpoint('sm', 576),
                new TuliaEditor.Document.Infrastructure.FrontendFramework.Model.Grid.Breakpoint('xs', 380),
            ];
        }
    }

    TuliaEditor.ns('TuliaEditor.Document.Infrastructure.FrontendFramework.BuiltInFramework.Bootstrap5.SizeProvider', SizeProvider);
}());

(function () {
    class Breakpoint {
        /** @type @param {String} */
        name;

        /** @type @param {Number} */
        width;

        /**
         * @param {String} name
         * @param {Number} width
         */
        constructor(name, width) {
            this.name = name;
            this.width = width;
        }
    }

    TuliaEditor.ns('TuliaEditor.Document.Infrastructure.FrontendFramework.Model.Grid.Breakpoint', Breakpoint);
}());

(function () {
    class ColumnSizeProvider {
        /**
         * @param {TuliaEditor.Document.Infrastructure.FrontendFramework.FrameworkProvider} provider
         */
        constructor (provider) {
            /** @type {TuliaEditor.Document.Infrastructure.FrontendFramework.FrameworkProvider} */
            this.provider = provider;
        }

        getSizeClass (size, breakpoint) {
            return this.provider.getSizeClass(size, breakpoint);
        }

        /**
         * @param {String} name
         * @return {TuliaEditor.Document.Infrastructure.FrontendFramework.Model.Grid.Breakpoint}
         */
        getBreakpoint (name) {
            let breakpoints = this.provider.getBreakpoints();

            for (let i in breakpoints) {
                if (breakpoints[i].name === name) {
                    return breakpoints[i];
                }
            }

            throw new Error('Breakpoint named "' + name + '" not exists.');
        }

        getBreakpoints () {
            return this.provider.getBreakpoints().sort(function (a, b) {
                return b.width - a.width;
            });
        }

        getDesktopBreakpoint () {
            return this.provider.getDesktopBreakpoint();
        }

        getColumnsCount () {
            return this.provider.getColumnsCount();
        }
    }

    TuliaEditor.ns('TuliaEditor.Document.Infrastructure.FrontendFramework.Proxy.ColumnSizeProvider', ColumnSizeProvider);
}());

(function() {
    class EditControls {
        /**
         * @param {TuliaEditor.Document.Domain.Grid.Entity.Block} entity
         * @param {TuliaEditor.Layout.Domain.EditControls.Model.Group} group
         */
        collectEditControls (entity, group) {
            entity.block.editOptions(group);
        }
    }

    TuliaEditor.ns('TuliaEditor.Block.Application.EventListener.EditControls', EditControls);
}());

(function() {
    class SelectedBlockExecutor {
        /**
         * @param {TuliaEditor.Block.Domain.Block.BlockPicker} blockPicker
         */
        constructor (blockPicker) {
            /** @type {TuliaEditor.Block.Domain.Block.BlockPicker} */
            this.blockPicker = blockPicker;
        }

        /**
         * Awaits for block click event, from BlockPicker.
         *
         * @internal
         * @param {String} type
         */
        executeSelectedCallback (type) {
            this.blockPicker.executeSelectedCallback(type);
        }
    }

    TuliaEditor.ns('TuliaEditor.Block.Application.EventListener.SelectedBlockExecutor', SelectedBlockExecutor);
}());

(function () {
    class UpdateBlockPreview {
        /**
         * @param {TuliaEditor.Layout.Domain.EditControls.Model.AbstractControl} control
         * @param {TuliaEditor.Document.Domain.Grid.Entity.AbstractEntity} entity
         */
        update (control, entity) {
            if (entity instanceof TuliaEditor.Document.Domain.Grid.Entity.Block) {
                entity.block.data = entity.data;
                entity.block.update();
            }
        }
    }

    TuliaEditor.ns('TuliaEditor.Block.Application.EventListener.UpdateBlockPreview', UpdateBlockPreview);
}());

(function() {
    class AbstractBlock {
        /**
         * Store jQuery node of rendered Block content.
         * This node is used to manipulate preview of the editor,
         * and is not used to exporting data from editor.
         *
         * @type {jQuery}
         */
        node;

        /**
         * Store data used to render and update the block.
         *
         * @type {Object}
         */
        data = {};

        /**
         * Store type of block. Filled when block object is initiating/creating.
         *
         * @type {String}
         */
        type;

        /**
         * Returns default data used when Block is rendered for preview.
         *
         * @return {Object}
         */
        getDefaultData () {
            return {};
        }

        /**
         * Renders HTML content to show in the editor, using this.data
         * (from JSON Document or DefaultData when creating new).
         */
        render () {

        }

        /**
         * Updated block preview in editor using this.data.
         */
        update () {

        }

        /**
         * Compile data to jQuery. Result is an jQuery object with rendered block content.
         *
         * @return {null|jQuery}
         */
        compile () {

        }

        /**
         * Exports data from HTML element to array, and returns it to create JSON Document.
         *
         * @return {Array}
         */
        export () {
            return {};
        }

        /**
         * Creates block Context Menu items and appends them into given Menu.
         *
         * @param {TuliaEditor.ContextMenu.Domain.Entity.Menu} menu
         */
        contextmenu (menu) {

        }

        /**
         * Creates Edit Options used to modify block.
         *
         * @param {TuliaEditor.Layout.Domain.EditControls.Model.Group} group
         */
        editOptions (group) {

        }
    }

    TuliaEditor.ns('TuliaEditor.Block.Domain.Block.AbstractBlock', AbstractBlock);
}());

(function() {
    class TextBlock extends TuliaEditor.Block.Domain.Block.AbstractBlock {
        /**
         * @inheritDoc
         */
        getDefaultData () {
            return {
                content: '<p>Start typing...</p>'
            };
        }

        /**
         * @inheritDoc
         */
        render () {
            this.node.append('<div data-tued-editable="wysiwyg" data-tued-editable-bind="content">' + (this.data.content ?? '') + '</div>');
        }

        /**
         * @inheritDoc
         */
        compile () {
            return $(this.data.content);
        }

        /**
         * @inheritDoc
         */
        export () {
            return {
                content: this.data.content
            };
        }

        /**
         * @inheritDoc
         */
        /*contextmenu (menu) {
            menu.addItem(new TuliaEditor.ContextMenu.Domain.Entity.Item('block.core.text.edit-text', 'Edit text'));
        }*/
    }

    TuliaEditor.ns('TuliaEditor.Block.Domain.Block.Core.TextBlock', TextBlock);
    TuliaEditor.block('core/text', TextBlock, {
        name: 'block.core.text.name',
        description: 'block.core.text.description',
        icon: '<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 4445 5218" shape-rendering="geometricPrecision" text-rendering="geometricPrecision" image-rendering="optimizeQuality" fill-rule="evenodd" clip-rule="evenodd"><path d="M1339 3691c-74 0-134-60-134-134s60-134 134-134h996c74 0 134 60 134 134s-60 134-134 134h-996zm0-1896c-74 0-134-60-134-134s60-134 134-134h1767c74 0 134 60 134 134s-60 134-134 134H1339zM311 0h3823c86 0 164 35 220 91s91 134 91 220v4595c0 86-35 164-91 220s-134 91-220 91H311c-86 0-164-35-220-91S0 4992 0 4906V311c0-86 35-164 91-220S225 0 311 0zm3823 268H311c-12 0-23 5-31 13s-13 19-13 31v4595c0 12 5 23 13 31s19 13 31 13h3823c12 0 23-5 31-13s13-19 13-31V312c0-12-5-23-13-31s-19-13-31-13zM1339 2743c-74 0-134-60-134-134s60-134 134-134h1767c74 0 134 60 134 134s-60 134-134 134H1339z" fill-rule="nonzero"/></svg>'
    });
    TuliaEditor.i18n['en']['block.core.text.name'] = 'Text';
    TuliaEditor.i18n['en']['block.core.text.description'] = 'WYSIWYG text block';
    TuliaEditor.i18n['pl']['block.core.text.name'] = 'Tekst';
    TuliaEditor.i18n['pl']['block.core.text.description'] = 'Tekst z edytorem WYSIWYG';
}());

(function() {
    class HeadingBlock extends TuliaEditor.Block.Domain.Block.AbstractBlock {
        /**
         * @param {Object} options
         */
        constructor (options) {
            super();

            this.options = options;
        }

        /**
         * @inheritDoc
         */
        getDefaultData () {
            return {
                content: 'Heading',
                level: 'h2',
                style: ''
            };
        }

        /**
         * @inheritDoc
         */
        render () {
            let level = this.data.level;
            this.node.html(`<${level} class="${this.data.style}" data-tued-editable="inline" data-tued-editable-bind="content">${this.data.content}</${level}>`);
        }

        /**
         * @inheritDoc
         */
        update () {
            this.render();
        }

        /**
         * @inheritDoc
         */
        compile () {
            let level = this.data.level;
            return $(`<${level} class="${this.data.style}">${this.data.content}</${level}>`);
        }

        /**
         * @inheritDoc
         */
        export () {
            return {
                content: this.data.content,
                level: this.data.level,
                style: this.data.style,
            };
        }

        /**
         * @inheritDoc
         */
        editOptions (group) {
            group.addControl('select', 'heading_level')
                .setValue(function (entity) {
                    return entity.data.level;
                })
                .setLabel('block.core.heading.level')
                .setOptions({
                    choices: {h1: "H1", h2: "H2", h3: "H3", h4: "H4", h5: "H5", h6: "H6"}
                })
                .setCallback(function (entity, value, next) {
                    entity.data.level = value;
                    next();
                })
            ;

            if (typeof(this.options.styles.predefined.heading) === 'object') {
                group.addControl('select', 'heading_style')
                    .setValue(function (entity) {
                        return entity.data.style;
                    })
                    .setLabel('block.core.heading.style')
                    .setOptions({
                        choices: $.extend(
                            {},
                            // Default empty style.
                            {"": "lackOfStyle"},
                            this.options.styles.predefined.heading
                        )
                    })
                    .setCallback(function (entity, value, next) {
                        entity.data.style = value;
                        next();
                    })
                ;
            }
        }
    }

    TuliaEditor.ns('TuliaEditor.Block.Domain.Block.Core.HeadingBlock', HeadingBlock);
    TuliaEditor.block('core/heading', 'TuliaEditor.Block.Domain.Block.Core.HeadingBlock', {
        name: 'block.core.heading.name',
        description: 'block.core.heading.description',
        icon: '<svg version="1.1" xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink" x="0px" y="0px" viewBox="0 0 122.88 120.26" style="enable-background:new 0 0 122.88 120.26" xml:space="preserve"><g><polygon points="0,14.54 0,0 49.81,0 49.81,14.54 36.93,17.03 36.93,51.7 85.98,51.7 85.98,17.03 73.1,14.54 73.1,0 85.98,0 110,0 122.88,0 122.88,14.54 110,17.03 110,103.31 122.88,105.79 122.88,120.26 73.1,120.26 73.1,105.79 85.98,103.31 85.98,70.3 36.93,70.3 36.93,103.31 49.81,105.79 49.81,120.26 0,120.26 0,105.79 12.8,103.31 12.8,17.03 0,14.54"/></g></svg>'
    });

    TuliaEditor.services['TuliaEditor.Block.Domain.Block.Core.HeadingBlock'] = {
        'class': TuliaEditor.Block.Domain.Block.Core.HeadingBlock,
        'arguments': [
            '@options'
        ]
    };

    TuliaEditor.i18n['en']['block.core.heading.name'] = 'Heading';
    TuliaEditor.i18n['en']['block.core.heading.description'] = 'Heading text block';
    TuliaEditor.i18n['en']['block.core.heading.level'] = 'Heading level';
    TuliaEditor.i18n['en']['block.core.heading.style'] = 'Heading style';

    TuliaEditor.i18n['pl']['block.core.heading.name'] = 'Nagłówek';
    TuliaEditor.i18n['pl']['block.core.heading.description'] = 'Nagłówek';
    TuliaEditor.i18n['pl']['block.core.heading.level'] = 'Poziom nagłówka';
    TuliaEditor.i18n['pl']['block.core.heading.style'] = 'Styl nagłówka';
}());

(function() {
    class ImageBlock extends TuliaEditor.Block.Domain.Block.AbstractBlock {
        /**
         * @type {String}
         */
        placeholder = 'https://via.placeholder.com/800x300?text=Tulia+CMS+Image';

        /**
         * @param {TuliaEditor.Selection.Application.Service.Selection} selection
         */
        constructor (selection) {
            super();
            /** @type {TuliaEditor.Selection.Application.Service.Selection} */
            this.selection = selection;
        }

        /**
         * @inheritDoc
         */
        getDefaultData () {
            return {
                source: this.placeholder,
            };
        }

        /**
         * @inheritDoc
         */
        render () {
            let self = this;
            let img = $('<img/>');

            img.on('load', function () {
                $(this).removeAttr('style');
                self.selection.updatePosition();
            });
            img.on('error', function () {
                $(this).css({
                    'height': '100px',
                    'width': '100%',
                    'background-color': '#ddd',
                    'background-image': 'url(\'data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAADAAAAA8CAMAAAAXHsnOAAAASFBMVEUAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAACrhKybAAAAF3RSTlMA4dOvxy2c8RQhu5LqQGFLVn44pYhzbHU8gRcAAAIJSURBVEjH3ZTZDqMwDEVNFrIBoUDr///TcUwaSCuKIs3DaK4KRZBjx0sMEAZEc/3rNNTa8EZirAGBt0Tto6NX6kq7tU5/AAKupOmrImJpAeZAK5YGYISVfLgWAMjH4FqA3UcDwD6UbgFAEuEaACaEawA4DqFbALtyHPdAsG/C01L7GwCPH+pugIifugFgEqYBYDldJGvgXv1/DWjpmgDr0f8GFrnBSSt9CJ/lkFMBBknVnKAoYNIDznoNiNJngGXG0g1kYqNrPpnvkVUAIY+JGMndzJQuLUjmu3mHYKDbk+MRlo0N+25CGRRW5pBitwOSLSnaIxG2e8e75kM8pbTMO9obBPHM29xXkjWfX5CJ3tqUgVwVpsFC1jjQ3gJPk+N8Srq6CEV5eYm2nu3LgKTg4EoPJJ3NzQZNqY+u/JSKvWoT3pbHY682lGUyvAOCWlocxZ8pLhNrV0+cvhojBeQd5zGHWoc/npudTD5gVERNkKouc5mPfOYyly2ImPyr3BrC+lIuLiH7V/bUGLY+D1zVcBqh0qUb5MZQ8fvELZTxZ3krHLvZgBujd/ANwPhO1SP3tTbkNG0uXpzpFxELQOQ/jhWT5PUQCCm5ydF0nDwxwSXA6fDifJaD1D/HjOXyrw2DTBOhmibfOHSuCYB5+Wen998GUPkseSn6qJRJgMA2wYZNUgDBNKz39g/i8Ux67FHfqgAAAABJRU5ErkJggg==\')',
                    'background-position': 'center center',
                    'background-repeat': 'no-repeat',
                });

                self.selection.updatePosition();
            });
            img.attr('src', this.data.source ?? this.placeholder);

            this.node.append(img);
        }

        /**
         * @inheritDoc
         */
        update () {
            this.node.find('img').attr('src', this.data.source ?? this.placeholder);
        }

        /**
         * @inheritDoc
         */
        compile () {
            return $(`<img src="${this.data.source ?? this.placeholder}" />`);
        }

        /**
         * @inheritDoc
         */
        export () {
            return {
                source: this.data.source,
            };
        }

        /**
         * @inheritDoc
         */
        editOptions (group) {
            group.addControl('text', 'image_source')
                .setValue(function (entity) {
                    return entity.data.source;
                })
                .setLabel('block.core.image.source')
                .setCallback(function (entity, value, next) {
                    entity.data.source = value;
                    next();
                })
            ;
        }
    }

    TuliaEditor.ns('TuliaEditor.Block.Domain.Block.Core.ImageBlock', ImageBlock);
    TuliaEditor.block('core/image', 'TuliaEditor.Block.Domain.Block.Core.ImageBlock', {
        name: 'block.core.image.name',
        description: 'block.core.image.description',
        icon: '<svg version="1.1" xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink" x="0px" y="0px" viewBox="0 0 122.88 122.151" enable-background="new 0 0 122.88 122.151" xml:space="preserve"><g><path d="M8.676,0h105.529c2.405,0,4.557,0.984,6.124,2.552c1.567,1.567,2.551,3.754,2.551,6.124v104.8 c0,2.405-0.983,4.557-2.551,6.124c-1.568,1.567-3.755,2.552-6.124,2.552H8.676c-2.406,0-4.557-0.984-6.124-2.553 C0.984,118.032,0,115.845,0,113.476V8.675C0,6.27,0.984,4.119,2.552,2.552C4.12,0.984,6.307,0,8.676,0L8.676,0z M9.097,88.323 l35.411-33.9c1.421-1.313,3.645-1.167,4.921,0.255c0.037,0.036,0.037,0.073,0.073,0.073l31.459,37.218l4.812-29.6 c0.328-1.896,2.114-3.208,4.01-2.879c0.729,0.109,1.385,0.474,1.895,0.948l22.07,23.184V10.773c0-0.474-0.183-0.875-0.511-1.166 c-0.291-0.292-0.729-0.511-1.166-0.511H10.737c-0.474,0-0.875,0.182-1.166,0.511c-0.292,0.291-0.511,0.729-0.511,1.166v77.55H9.097 L9.097,88.323z M90.526,19.866c3.464,0,6.635,1.422,8.895,3.682c2.297,2.296,3.682,5.431,3.682,8.895 c0,3.463-1.421,6.634-3.682,8.894c-2.296,2.297-5.431,3.682-8.895,3.682c-3.462,0-6.634-1.421-8.894-3.682 c-2.297-2.296-3.682-5.431-3.682-8.894c0-3.463,1.421-6.634,3.682-8.895C83.929,21.251,87.064,19.866,90.526,19.866L90.526,19.866z"/></g></svg>'
    });

    TuliaEditor.services['TuliaEditor.Block.Domain.Block.Core.ImageBlock'] = {
        'class': TuliaEditor.Block.Domain.Block.Core.ImageBlock,
        'arguments': [
            '@TuliaEditor.Selection.Application.Service.Selection'
        ]
    };

    TuliaEditor.i18n['en']['block.core.image.name'] = 'Image';
    TuliaEditor.i18n['en']['block.core.image.description'] = 'Image block';
    TuliaEditor.i18n['en']['block.core.image.source'] = 'Image source';
    TuliaEditor.i18n['pl']['block.core.image.name'] = 'Obraz';
    TuliaEditor.i18n['pl']['block.core.image.description'] = 'Blok ze zdjęciem';
    TuliaEditor.i18n['pl']['block.core.image.source'] = 'Źródło (adres) obrazka';
}());

(function() {
    class HtmlBlock extends TuliaEditor.Block.Domain.Block.AbstractBlock {
        /**
         * @inheritDoc
         */
        getDefaultData () {
            return {
                source: '<div></div>',
            };
        }

        /**
         * @inheritDoc
         */
        render () {
            this.node.append('<pre></pre>').text(this.data.source ?? '<div></div>');
        }

        /**
         * @inheritDoc
         */
        compile (data) {
            return $(data.source ?? '<div></div>');
        }

        /**
         * @inheritDoc
         */
        export () {
            return {
                source: this.node.html(),
            };
        }
    }

    TuliaEditor.ns('TuliaEditor.Block.Domain.Block.Core.HtmlBlock', HtmlBlock);
    TuliaEditor.block('core/htmlcode', HtmlBlock, {
        name: 'block.core.htmlcode.name',
        description: 'block.core.htmlcode.description',
        icon: '<svg version="1.1" id="Layer_1" xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink" x="0px" y="0px" viewBox="0 0 122.88 91.26" style="enable-background:new 0 0 122.88 91.26" xml:space="preserve"><style type="text/css">.st0{fill-rule:evenodd;clip-rule:evenodd;}</style><g><path class="st0" d="M8.32,0h106.24c4.58,0,8.32,3.74,8.32,8.32v74.62c0,4.57-3.74,8.32-8.32,8.32H8.32C3.74,91.26,0,87.51,0,82.94 V8.32C0,3.74,3.74,0,8.32,0L8.32,0z M54.46,72.22L32,58.61v-8.63l22.46-13.61v10.26l-13.65,7.69l13.65,7.7V72.22L54.46,72.22z M68.42,72.22l22.46-13.61v-8.63L68.42,36.37v10.26l13.65,7.69l-13.65,7.7V72.22L68.42,72.22z M117.97,23.29H5.29v60.46 c0,0.64,0.25,1.2,0.67,1.63c0.42,0.42,0.99,0.67,1.63,0.67h108.04c0.64,0,1.2-0.25,1.63-0.67c0.43-0.43,0.67-0.99,0.67-1.63V23.29 H117.97L117.97,23.29z M106.64,9.35c2.27,0,4.11,1.84,4.11,4.11c0,2.27-1.84,4.11-4.11,4.11c-2.27,0-4.11-1.84-4.11-4.11 C102.54,11.19,104.38,9.35,106.64,9.35L106.64,9.35z M78.8,9.35c2.27,0,4.11,1.84,4.11,4.11c0,2.27-1.84,4.11-4.11,4.11 c-2.27,0-4.11-1.84-4.11-4.11C74.69,11.19,76.53,9.35,78.8,9.35L78.8,9.35z M92.72,9.35c2.27,0,4.11,1.84,4.11,4.11 c0,2.27-1.84,4.11-4.11,4.11c-2.27,0-4.11-1.84-4.11-4.11C88.61,11.19,90.45,9.35,92.72,9.35L92.72,9.35z"/></g></svg>'
    });

    TuliaEditor.i18n['en']['block.core.htmlcode.name'] = 'HTML';
    TuliaEditor.i18n['en']['block.core.htmlcode.description'] = 'HTML code block';
    TuliaEditor.i18n['pl']['block.core.htmlcode.name'] = 'HTML';
    TuliaEditor.i18n['pl']['block.core.htmlcode.description'] = 'Edytor kodu HTML';
}());

(function() {
    class TestBlock extends TuliaEditor.Block.Domain.Block.AbstractBlock {
        /**
         * @inheritDoc
         */
        getDefaultData () {
            return {
                tagline: 'Easily Understandable & Customizable',
                headline: 'WALKTHROUGH VIDEOS & DEMOS',
                video: 'https://www.youtube.com/embed/0oiZQJSmDxg',
                description: 'Democracy inspire breakthroughs, Rosa Parks; inspiration raise awareness natural resources. Governance impact; transformative donation philanthropy, respect reproductive.',
            };
        }

        /**
         * @inheritDoc
         */
        render () {
            this.node.append(
                '<div class="text-center">' +
                    '<div class="mb-4" data-tued-editable="inline" data-tued-editable-bind="tagline" style="color:#1abc9c!important">' + (this.data.tagline ?? '') + '</div>' +
                    '<h3 class="mb-4" data-tued-editable="inline" data-tued-editable-bind="headline">' + (this.data.headline ?? '') + '</h3>' +
                    '<div class="ratio ratio-16x9 mb-4"><iframe width="560" height="315" src="' + (this.data.video ?? '') + '" frameborder="0" allow="accelerometer; autoplay; clipboard-write; encrypted-media; gyroscope; picture-in-picture" allowfullscreen></iframe></div>' +
                    '<h3 class="mb-4" data-tued-editable="inline" data-tued-editable-bind="description" style="font-weight:200">' + (this.data.description ?? '') + '</h3>' +
                '</div>'
            );
        }

        /**
         * @inheritDoc
         */
        compile () {
            return $('<div class="text-center">' +
                '<div class="mb-4" data-tued-editable="inline" data-tued-editable-bind="tagline" style="color:#1abc9c!important">' + (this.data.tagline ?? '') + '</div>' +
                '<h3 class="mb-4" data-tued-editable="inline" data-tued-editable-bind="headline">' + (this.data.headline ?? '') + '</h3>' +
                '<div class="ratio ratio-16x9 mb-4"><iframe width="560" height="315" src="' + (this.data.video ?? '') + '" frameborder="0" allow="accelerometer; autoplay; clipboard-write; encrypted-media; gyroscope; picture-in-picture" allowfullscreen></iframe></div>' +
                '<h3 class="mb-4" data-tued-editable="inline" data-tued-editable-bind="description" style="font-weight:200">' + (this.data.description ?? '') + '</h3>' +
                '</div>');
        }

        /**
         * @inheritDoc
         */
        export () {
            return {
                tagline: this.data.tagline,
                headline: this.data.headline,
                video: this.data.video,
                description: this.data.description
            };
        }
    }

    TuliaEditor.ns('TuliaEditor.Block.Domain.Block.Core.TestBlock', TestBlock);
    TuliaEditor.block('core/testblock', TestBlock, {
        name: 'TestBlock',
        icon: '<svg version="1.1" id="Layer_1" xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink" x="0px" y="0px" viewBox="0 0 122.88 122.88" style="enable-background:new 0 0 122.88 122.88" xml:space="preserve"><g><path d="M76.36,56.15l-2.48-2.48c-0.75-0.75-0.75-1.96,0-2.71c0.75-0.75,1.96-0.75,2.71,0l4.95,4.95c3.9-0.33,7.8-1.03,11.72-2.31 l-15.8-15.8c-0.75-0.75-0.75-1.96,0-2.71c0.75-0.75,1.96-0.75,2.71,0l17.02,17.02c2.91-1.26,5.83-2.87,8.76-4.93l-20.8-20.8 c-0.75-0.75-0.75-1.96,0-2.71c0.75-0.75,1.96-0.75,2.71,0l21.17,21.17c1.46-1.19,2.93-2.49,4.39-3.92c0.76-0.74,1.97-0.72,2.7,0.04 c0.74,0.76,0.72,1.97-0.04,2.7C96.88,62.42,78.4,60.72,59.79,59C41.3,57.3,22.66,55.59,3.28,75.62c-0.74,0.76-1.95,0.77-2.7,0.04 c-0.76-0.74-0.77-1.95-0.04-2.7c18.97-19.61,37.02-19.68,54.88-18.17c-0.55-8.13-0.63-16.46,1.43-25.12 c2.22-9.33,6.9-18.97,16.13-29.04c0.71-0.78,1.92-0.83,2.69-0.12c0.78,0.71,0.83,1.92,0.12,2.69 c-8.72,9.52-13.13,18.59-15.22,27.35c-1.99,8.39-1.86,16.57-1.29,24.58l0.86,0.08c1.03,0.09,2.06,0.19,3.09,0.28 c-0.55-7.75-0.6-15.5,1.33-23.38c2.06-8.38,6.36-16.81,14.66-25.31c0.74-0.76,1.95-0.77,2.7-0.04c0.76,0.74,0.77,1.95,0.04,2.7 c-7.77,7.96-11.78,15.79-13.69,23.56c-1.86,7.56-1.75,15.16-1.19,22.78C70.18,56.02,73.27,56.18,76.36,56.15L76.36,56.15z M39.74,97.9c0.75,0.75,0.75,1.96,0,2.71c-0.75,0.75-1.96,0.75-2.71,0L15.02,78.59c-0.39-0.39-0.57-0.9-0.56-1.4 c-1.65,1.38-3.3,2.91-4.96,4.63c-0.73,0.76-1.94,0.78-2.7,0.05c-0.76-0.73-0.78-1.94-0.05-2.7c18.43-19.13,36.24-17.63,54.84-16.06 c18.2,1.53,37.2,3.13,58.1-16.02c0.78-0.71,1.98-0.66,2.69,0.12c0.71,0.78,0.66,1.98-0.12,2.69 C102.75,67.78,85.03,68.61,68.1,67.46c0.72,8.53,1.07,17.12-0.94,25.89c-2.18,9.53-7.09,19.17-17.24,28.99 c-0.76,0.74-1.97,0.72-2.7-0.04c-0.74-0.76-0.72-1.97,0.04-2.7c9.54-9.24,14.15-18.23,16.17-27.09c1.93-8.48,1.53-16.92,0.81-25.34 c-0.99-0.08-1.99-0.16-2.98-0.25l-1.05-0.09c0.58,7.93,0.75,15.74-1.11,23.61c-2.04,8.57-6.47,17.09-15.39,25.69 c-0.76,0.73-1.97,0.71-2.7-0.05c-0.73-0.76-0.71-1.97,0.05-2.7c8.31-8.01,12.44-15.9,14.32-23.81c1.8-7.56,1.57-15.23,0.98-23.04 c-3.3-0.25-6.58-0.43-9.84-0.42l3.8,3.8c0.75,0.75,0.75,1.96,0,2.71c-0.75,0.75-1.96,0.75-2.71,0l-5.29-5.29 c-0.3-0.3-0.48-0.67-0.54-1.05c-4.09,0.29-8.15,0.98-12.21,2.33l16.77,16.77c0.75,0.75,0.75,1.96,0,2.71 c-0.75,0.75-1.96,0.75-2.71,0L26.44,70.91c-0.26-0.26-0.43-0.58-0.51-0.91c-3.06,1.33-6.11,3.08-9.17,5.36 c0.35,0.07,0.68,0.25,0.96,0.52L39.74,97.9L39.74,97.9z"/></g></svg>'
    });
}());

(function() {
    class BlocksRegistry {
        /**
         * @param {TuliaEditor.Shared.DependencyInjection.Container} container
         */
        constructor (container) {
            /** @type {TuliaEditor.Shared.DependencyInjection.Container} */
            this.container = container;
        }

        all () {
            return TuliaEditor.blocks;
        }

        /**
         * @param {String} type
         * @return {Boolean}
         */
        exists (type) {
            return !! TuliaEditor.blocks[type];
        }

        /**
         * @param {String} type
         * @return {TuliaEditor.Block.Domain.Block.AbstractBlock}
         */
        get (type) {
            /** @type {null|TuliaEditor.Block.Domain.Block.AbstractBlock} block */
            let block = null;

            if (typeof(TuliaEditor.blocks[type]["class"]) === 'string') {
                block = this.container.produce(TuliaEditor.blocks[type]["class"]);
            } else if (typeof(TuliaEditor.blocks[type]["class"]) === 'function') {
                block = new TuliaEditor.blocks[type]["class"]();
            }

            if (block instanceof TuliaEditor.Block.Domain.Block.AbstractBlock) {
                block.type = type;
                block.data = block.getDefaultData();

                return block;
            }

            throw new Error('Block "' + type + '" must be a service name or a function.');
        }

        /**
         * @param {String} type
         * @return {Object}
         */
        info (type) {
            return TuliaEditor.blocks[type].info;
        }
    }

    TuliaEditor.ns('TuliaEditor.Block.Domain.Block.BlocksRegistry', BlocksRegistry);
}());

(function() {
    class BlockPicker {
        /**
         * Store callback executed when someone selects any block from Blocks Picker.
         *
         * @type {null|Function}
         */
        callback;

        /**
         * @param {TuliaEditor.Block.Domain.Block.BlocksRegistry} registry
         * @param {TuliaEditor.Block.Infrastructure.View.BlockPicker} view
         */
        constructor (registry, view) {
            /** @type {TuliaEditor.Block.Domain.Block.BlocksRegistry} */
            this.registry = registry;
            /** @type {TuliaEditor.Block.Infrastructure.View.BlockPicker} */
            this.view = view;
        }

        /**
         * Opens a Block Picker.
         *
         * @param {Function} callback
         */
        open (callback) {
            this.callback = callback;
            this.view.open(this.registry.all());
        }

        /**
         * Close a Block Picker.
         */
        close () {
            this.view.close();
        }

        /**
         * Awaits for block click event.
         *
         * @internal
         * @param {String} type
         */
        executeSelectedCallback (type) {
            if (typeof(this.callback) === 'function') {
                let block = this.registry.get(type);
                this.callback(block);
                this.callback = null;
            }
        }
    }

    TuliaEditor.ns('TuliaEditor.Block.Domain.Block.BlockPicker', BlockPicker);
}());

(function() {
    class BlockPicker {
        /** @type {TuliaEditor.Modal.Domain.Model.Modal} */
        modal;

        /**
         * @param {TuliaEditor.Modal.Domain.Modals} modals
         * @param {TuliaEditor.Shared.EventDispatcher.EventDispatcher} eventDispatcher
         * @param {TuliaEditor.Shared.I18n.Translator} translator
         */
        constructor (modals, eventDispatcher, translator) {
            /** @type {TuliaEditor.Block.Domain.Block.BlocksRegistry} */
            this.modals = modals;
            /** @type {TuliaEditor.Shared.EventDispatcher.EventDispatcher} */
            this.eventDispatcher = eventDispatcher;
            /** @type {TuliaEditor.Shared.I18n.Translator} */
            this.translator = translator;
        }

        open (blocks) {
            this.createModal(blocks).open();
        }

        close () {
            this.modal.close();
        }

        createModal(blocks) {
            if (this.modal) {
                return this.modal;
            }

            let self = this;

            let modal = this.modals.create();
            let cont = $('<div class="tued-blocks-collection"></div>');

            for (let type in blocks) {
                let block = blocks[type];

                let name = this.translator.trans(block.info.name ?? block.info.id) || block.info.name;
                let description = this.translator.trans(block.info.description) || block.info.description;

                cont.append('<div class="tued-block-item" data-block-type="' + type + '">\
                    <div class="tued-block-icon">' + block.info.icon + '</div>\
                    <div class="tued-block-info">\
                        <div class="tued-block-name">' + name + '</div>\
                        <div class="tued-block-description">' + description + '</div>\
                    </div>\
                </div>');
            }

            cont.find('.tued-block-item').click(function () {
                self.eventDispatcher.dispatch('layout.block.picker.pick', $(this).attr('data-block-type'));
            });

            modal.body.empty().append(cont);
            modal.title = this.translator.trans('selectBlock');

            return this.modal = modal;
        }
    }

    TuliaEditor.ns('TuliaEditor.Block.Infrastructure.View.BlockPicker', BlockPicker);
}());

(function () {
    class Hover {
        /** @type {jQuery} */
        //boundariesNode;

        /** @type {null|jQuery} */
        highlighted;

        /** @type {jQuery[]} */
        highlightedStack = [];

        /**
         * @param {TuliaEditor.Shared.EventDispatcher.EventDispatcher} eventDispatcher
         * @param {TuliaEditor.Selection.Domain.Selection} selection
         */
        constructor (eventDispatcher, selection) {
            /** @type {TuliaEditor.Shared.EventDispatcher.EventDispatcher} */
            this.eventDispatcher = eventDispatcher;
            /** @type {TuliaEditor.Selection.Domain.Selection} */
            this.selection = selection;
        }

        /**
         * @internal
         */
        init () {
            //this.boundariesNode = this.layout.getHoverableElementBoundariesNode();
        }

        showFor (element) {
            if (this.selection.isDisabled()) {
                return;
            }

            this.highlightedStack.push(element);
            this.highlighted = element;
            this.eventDispatcher.dispatch('domain.selection.hover.show', this.highlighted);
            //this.updatePosition();
            //this.boundariesNode.removeClass('tued-hidden');
        }

        hideFor () {
            this.highlightedStack.pop();

            if (this.highlightedStack[this.highlightedStack.length - 1]) {
                this.highlighted = this.highlightedStack[this.highlightedStack.length - 1];
                this.eventDispatcher.dispatch('domain.selection.hover.show', this.highlighted);
                //this.updatePosition();
            } else {
                //this.boundariesNode.addClass('tued-hidden');
                this.eventDispatcher.dispatch('domain.selection.hover.hide');
            }
        }

        isHighlightActive () {
            return !! this.highlighted;
        }
    }

    TuliaEditor.ns('TuliaEditor.Selection.Domain.Hover', Hover);
}());

(function () {
    class Selection {
        /** @type {null|TuliaEditor.Document.Domain.Grid.Entity.AbstractEntity} */
        selected;

        /** @type {Boolean} */
        preventHide = false;

        /** @type {Number} */
        disableStack = 0;

        /**
         * @param {TuliaEditor.Shared.EventDispatcher.EventDispatcher} eventDispatcher
         * @param {TuliaEditor.Document.Domain.Model.Document} document
         */
        constructor (eventDispatcher, document) {
            /** @type {TuliaEditor.Shared.EventDispatcher.EventDispatcher} */
            this.eventDispatcher = eventDispatcher;
            /** @type {TuliaEditor.Document.Domain.Model.Document} */
            this.document = document;
        }

        /**
         * @param {String} id
         */
        select (id) {
            let element = this.document.get(id);

            if (element) {
                this.selectElement(element);
            }
        }

        hide () {
            if (this.isDisabled()) {
                return;
            }

            this.selected = null;
            this.eventDispatcher.dispatch('domain.selection.hide');
        }

        /**
         * @internal
         * @param {TuliaEditor.Document.Domain.Grid.Entity.AbstractEntity} element
         */
        selectElement (element) {
            if (this.isDisabled()) {
                return;
            }

            /**
             * Preventing hide element after event document propagation.
             * First event is on our element, but last event os always od BODY
             * which hides selection, so after first selection we prevent hiding
             * on BODY event (click).
             *
             * Must be the very first statement, to prevent select and unselect
             * when user clicks at the same element multiple times at row.
             */
            this.preventHide = true;

            if (this.selected && this.selected.id === element.id) {
                return;
            }

            this.selected = element;
            this.eventDispatcher.dispatch('domain.selection.show', this.selected);
        }

        /**
         * @internal
         */
        hideIfNotPrevented () {
            if (this.preventHide) {
                this.preventHide = false;
                return;
            }

            this.hide();
        }

        disable () {
            this.disableStack++;

            if (this.disableStack === 1) {
                this.eventDispatcher.dispatch('domain.selection.disabled');
            }
        }

        enable () {
            this.disableStack--;

            if (this.disableStack === 0) {
                this.eventDispatcher.dispatch('domain.selection.enabled');
            }
        }

        isDisabled () {
            return this.disableStack !== 0;
        }
    }

    TuliaEditor.ns('TuliaEditor.Selection.Domain.Selection', Selection);
}());

(function () {
    class Collector {
        /**
         * @param {TuliaEditor.Shared.EventDispatcher.EventDispatcher} eventDispatcher
         */
        constructor (eventDispatcher) {
            /** @type {TuliaEditor.Shared.EventDispatcher.EventDispatcher} */
            this.eventDispatcher = eventDispatcher;
        }

        /**
         * @param {String} type
         * @param {TuliaEditor.Document.Domain.Grid.Entity.AbstractEntity} element
         * @return {TuliaEditor.Selection.Domain.Actions.Model.Actions}
         */
        collect (type, element) {
            let actions = new TuliaEditor.Selection.Domain.Actions.Model.Actions();

            this.eventDispatcher.dispatch('domain.selection.actions.' + type, element, actions);

            return actions;
        }
    }

    TuliaEditor.ns('TuliaEditor.Selection.Domain.Actions.Collector', Collector);
}());

(function () {
    class Action {
        /**
         * @param {String} label
         * @param {String} icon
         * @param {Function} callback
         */
        constructor (label, icon, callback) {
            this.label = label;
            this.icon = icon;
            this.callback = callback;
        }
    }

    TuliaEditor.ns('TuliaEditor.Selection.Domain.Actions.Model.Action', Action);
}());

(function () {
    class Actions {
        /** @type {TuliaEditor.Selection.Domain.Actions.Model.Action[]} */
        actions = [];

        /**
         * @param {TuliaEditor.Selection.Domain.Actions.Model.Action} action
         */
        add (action) {
            if (! (action instanceof TuliaEditor.Selection.Domain.Actions.Model.Action)) {
                throw new Error('Action must be instance of "TuliaEditor.Selection.Domain.Actions.Model.Action".')
            }

            this.actions.push(action);
        }
    }

    TuliaEditor.ns('TuliaEditor.Selection.Domain.Actions.Model.Actions', Actions);
}());

(function () {
    class CollectSelectedActions {
        /**
         * @param {TuliaEditor.Selection.Application.Service.Selection} selection
         * @param {TuliaEditor.Shared.I18n.Translator} translator
         */
        constructor (selection, translator) {
            /** @type {TuliaEditor.Selection.Application.Service.Selection} */
            this.selection = selection;
            /** @type {TuliaEditor.Shared.I18n.Translator} */
            this.translator = translator;
        }

        /**
         * @param {TuliaEditor.Document.Domain.Grid.Entity.AbstractEntity} element
         * @param {TuliaEditor.Selection.Domain.Actions.Model.Actions} actions
         */
        collect (element, actions) {
            if (element instanceof TuliaEditor.Document.Domain.Grid.Entity.Block) {
                this.collectForBlocks(element, actions);
            }
            if (element instanceof TuliaEditor.Document.Domain.Grid.Entity.Column) {
                this.collectForColumns(element, actions);
            }
            if (element instanceof TuliaEditor.Document.Domain.Grid.Entity.Row) {
                this.collectForRows(element, actions);
            }
        }

        /**
         * @param {TuliaEditor.Document.Domain.Grid.Entity.Block} element
         * @param {TuliaEditor.Selection.Domain.Actions.Model.Actions} actions
         */
        collectForBlocks (element, actions) {
            actions.add(this.createSelectParentAction(element));
        }

        /**
         * @param {TuliaEditor.Document.Domain.Grid.Entity.Column} element
         * @param {TuliaEditor.Selection.Domain.Actions.Model.Actions} actions
         */
        collectForColumns (element, actions) {
            actions.add(this.createSelectParentAction(element));
        }

        /**
         * @param {TuliaEditor.Document.Domain.Grid.Entity.Row} element
         * @param {TuliaEditor.Selection.Domain.Actions.Model.Actions} actions
         */
        collectForRows (element, actions) {
            actions.add(this.createSelectParentAction(element));
        }

        /**
         * @param {TuliaEditor.Document.Domain.Grid.Entity.AbstractEntity} element
         * @return {TuliaEditor.Selection.Domain.Actions.Model.Action}
         */
        createSelectParentAction (element) {
            let self = this;

            return new TuliaEditor.Selection.Domain.Actions.Model.Action(
                this.translator.trans('selectParentBlock'),
                '<i class="fas fa-long-arrow-alt-up"></i>',
                function (element) {self.selection.selectParent();}
            );
        }
    }

    TuliaEditor.ns('TuliaEditor.Selection.Application.EventListener.Domain.CollectSelectedActions', CollectSelectedActions);
}());

(function () {
    class ExecuteSelectedAction {
        /**
         * @param {TuliaEditor.Selection.Application.Service.Selection} selection
         */
        constructor (selection) {
            /** @type {TuliaEditor.Selection.Application.Service.Selection} */
            this.selection = selection;
        }

        /**
         * @param {Function} callback
         */
        executeCallbackOnSelected (callback) {
            if (this.selection.getSelected() && typeof(callback) === 'function') {
                callback(this.selection.getSelected());
            }
        }
    }

    TuliaEditor.ns('TuliaEditor.Selection.Application.EventListener.Domain.ExecuteSelectedAction', ExecuteSelectedAction);
}());

(function () {
    class InitSelection {
        /**
         * @param {TuliaEditor.Selection.Application.Service.Initiator} initiator
         */
        constructor (initiator) {
            /** @type {TuliaEditor.Selection.Application.Service.Initiator} */
            this.initiator = initiator;
        }

        init () {
            this.initiator.initiate();
        }
    }

    TuliaEditor.ns('TuliaEditor.Selection.Application.EventListener.Domain.InitSelection', InitSelection);
}());

(function () {
    class SelectionVisibility {
        /**
         * @param {TuliaEditor.Selection.Application.Service.Selection} selection
         */
        constructor (selection) {
            /** @type {TuliaEditor.Selection.Application.Service.Selection} */
            this.selection = selection;
        }

        /**
         * @param {TuliaEditor.Document.Domain.Grid.Entity.AbstractEntity} element
         */
        selectInsertedElement (element) {
            this.selection.select(element);
        }

        hideSelection () {
            this.selection.hide();
        }
    }

    TuliaEditor.ns('TuliaEditor.Selection.Application.EventListener.ExternalDomainEvents.SelectionVisibility', SelectionVisibility);
}());

(function () {
    class SelectionDisabler {
        /**
         * @param {TuliaEditor.Selection.Infrastructure.Selection} selectionView
         * @param {TuliaEditor.Selection.Infrastructure.Hover} hoverView
         */
        constructor (selectionView, hoverView) {
            /** @type {TuliaEditor.Selection.Infrastructure.Selection} */
            this.selectionView = selectionView;
            /** @type {TuliaEditor.Selection.Infrastructure.Hover} */
            this.hoverView = hoverView;
        }

        disable () {
            this.selectionView.disable();
            this.hoverView.disable();
        }

        enable () {
            this.selectionView.enable();
            this.hoverView.enable();
        }
    }

    TuliaEditor.ns('TuliaEditor.Selection.Application.EventListener.PreviewUpdate.SelectionDisabler', SelectionDisabler);
}());

(function () {
    class UpdateSelectionPosition {
        /**
         * @param {TuliaEditor.Selection.Application.Service.Selection} selection
         * @param {TuliaEditor.Selection.Infrastructure.Selection} view
         * @param {TuliaEditor.Shared.I18n.Translator} translator
         * @param {TuliaEditor.Document.Infrastructure.View.Structure.NodesStorage} nodesStorage
         * @param {TuliaEditor.Selection.Domain.Actions.Collector} actionsCollector
         */
        constructor (selection, view, translator, nodesStorage, actionsCollector) {
            /** @type {TuliaEditor.Selection.Application.Service.Selection} */
            this.selection = selection;
            /** @type {TuliaEditor.Selection.Infrastructure.Selection} */
            this.view = view;
            /** @type {TuliaEditor.Shared.I18n.Translator} */
            this.translator = translator;
            /** @type {TuliaEditor.Document.Infrastructure.View.Structure.NodesStorage} */
            this.nodesStorage = nodesStorage;
            /** @type {TuliaEditor.Selection.Domain.Actions.Collector} */
            this.actionsCollector = actionsCollector;
        }

        updatePosition () {
            this.selection.updatePosition();
        }

        hide () {
            this.view.hide();
        }

        /**
         * @param {TuliaEditor.Document.Domain.Grid.Entity.AbstractEntity} element
         */
        show (element) {
            this.view.show(
                this.translator.trans(
                    this.view.getElementName(this.nodesStorage.get(element.id)).toLocaleLowerCase()
                ),
                this.actionsCollector.collect('selected', element)
            );
            this.selection.updatePosition();
        }
    }

    TuliaEditor.ns('TuliaEditor.Selection.Application.EventListener.UserInterfaceEvents.UpdateSelectionPosition', UpdateSelectionPosition);
}());

(function () {
    class UpdateHoverPosition {
        /**
         * @param {TuliaEditor.Selection.Application.Service.Hover} hover
         * @param {TuliaEditor.Selection.Infrastructure.Hover} view
         */
        constructor (hover, view) {
            /** @type {TuliaEditor.Selection.Application.Service.Hover} */
            this.hover = hover;
            /** @type {TuliaEditor.Selection.Infrastructure.Hover} */
            this.view = view;
        }

        updatePosition () {
            this.hover.updatePosition();
        }

        hide () {
            this.view.hide();
        }

        /**
         * @param {TuliaEditor.Document.Domain.Grid.Entity.AbstractEntity} element
         */
        show (element) {
            this.view.show();
            this.hover.updatePosition();
        }
    }

    TuliaEditor.ns('TuliaEditor.Selection.Application.EventListener.UserInterfaceEvents.UpdateHoverPosition', UpdateHoverPosition);
}());

(function () {
    class SelectElement {
        /**
         * @param {TuliaEditor.Selection.Application.Service.Selection} selection
         */
        constructor (selection) {
            /** @type {TuliaEditor.Selection.Application.Service.Selection} */
            this.selection = selection;
        }

        /**
         * @param {jQuery} element
         */
        selectNodeElement (element) {
            this.selection.selectNode(element);
        }

        hideSelection () {
            this.selection.hideIfNotPrevented();
        }
    }

    TuliaEditor.ns('TuliaEditor.Selection.Application.EventListener.UserInterfaceEvents.SelectElement', SelectElement);
}());

(function () {
    class HoverElement {
        /**
         * @param {TuliaEditor.Selection.Application.Service.Hover} hover
         */
        constructor (hover) {
            /** @type {TuliaEditor.Selection.Application.Service.Hover} */
            this.hover = hover;
        }

        /**
         * @param {jQuery} node
         */
        showFor (node) {
            this.hover.showFor(node);
        }

        hideFor () {
            this.hover.hideFor();
        }
    }

    TuliaEditor.ns('TuliaEditor.Selection.Application.EventListener.UserInterfaceEvents.HoverElement', HoverElement);
}());

(function () {
    class Initiator {
        /**
         * @param {TuliaEditor.Selection.Infrastructure.UserInterface.CanvasEvents} canvasEvents
         */
        constructor (canvasEvents) {
            /** @type {TuliaEditor.Selection.Infrastructure.UserInterface.CanvasEvents} */
            this.canvasEvents = canvasEvents;
        }

        initiate () {
            this.canvasEvents.handleCanvasMouseEvents();
        }
    }

    TuliaEditor.ns('TuliaEditor.Selection.Application.Service.Initiator', Initiator);
}());

(function () {
    class Selection {
        /**
         * @param {TuliaEditor.Selection.Domain.Selection} selection
         * @param {TuliaEditor.Selection.Infrastructure.Selection} view
         * @param {TuliaEditor.Selection.Infrastructure.ElementBoundaries} elementBoundaries
         */
        constructor (selection, view, elementBoundaries,) {
            /** @type {TuliaEditor.Selection.Domain.Selection} */
            this.selection = selection;
            /** @type {TuliaEditor.Selection.Infrastructure.Selection} */
            this.view = view;
            /** @type {TuliaEditor.Selection.Infrastructure.ElementBoundaries} */
            this.elementBoundaries = elementBoundaries;
        }

        /**
         * @param {TuliaEditor.Document.Domain.Grid.Entity.AbstractEntity} element
         */
        select (element) {
            if (element instanceof TuliaEditor.Document.Domain.Grid.Entity.AbstractEntity) {
                this.selection.select(element.id);
            } else if (typeof(element) === 'string') {
                this.selection.select(element);
            }
        }

        /**
         * @param {jQuery} node
         */
        selectNode (node) {
            let elementId = this.view.findSelectableElementId(node);

            if (elementId) {
                this.selection.select(elementId);
            }
        }

        selectParent () {
            let selected = this.selection.selected;

            if (selected && selected.parent) {
                this.selection.select(selected.parent.id);
            }
        }

        hide () {
            this.selection.hide();
        }

        hideIfNotPrevented () {
            this.selection.hideIfNotPrevented();
        }

        updatePosition () {
            if (! this.selection.selected) {
                return;
            }

            let boundaries = this.elementBoundaries.getBoundaries(this.selection.selected);

            if (! boundaries) {
                return;
            }

            this.view.updatePosition(boundaries);
        }

        disable () {
            this.selection.disable();
        }

        enable () {
            this.selection.enable();
            this.updatePosition();
        }

        /**
         * @return {null|TuliaEditor.Document.Domain.Grid.Entity.AbstractEntity}
         */
        getSelected () {
            return this.selection.selected;
        }

        /**
         * @return {Boolean}
         */
        isDisabled () {
            return this.selection.isDisabled();
        }
    }

    TuliaEditor.ns('TuliaEditor.Selection.Application.Service.Selection', Selection);
}());

(function () {
    class Hover {
        /**
         * @param {TuliaEditor.Selection.Domain.Hover} hover
         * @param {TuliaEditor.Selection.Infrastructure.Hover} view
         * @param {TuliaEditor.Selection.Infrastructure.ElementBoundaries} elementBoundaries
         */
        constructor (hover, view, elementBoundaries,) {
            /** @type {TuliaEditor.Selection.Domain.Hover} */
            this.hover = hover;
            /** @type {TuliaEditor.Selection.Infrastructure.Hover} */
            this.view = view;
            /** @type {TuliaEditor.Selection.Infrastructure.ElementBoundaries} */
            this.elementBoundaries = elementBoundaries;
        }

        /**
         * @param {jQuery} node
         */
        showFor (node) {
            this.hover.showFor(node);
        }

        /**
         * @param {jQuery} node
         */
        hideFor (node) {
            this.hover.hideFor(node);
        }

        updatePosition () {
            if (! this.hover.isHighlightActive()) {
                return;
            }

            let boundaries = this.elementBoundaries.getBoundaries(this.hover.highlighted);

            if (! boundaries) {
                return;
            }

            this.view.updatePosition(boundaries);
        }
    }

    TuliaEditor.ns('TuliaEditor.Selection.Application.Service.Hover', Hover);
}());

(function () {
    class Selection {
        /** @type {jQuery} */
        boundariesNodeElement;

        /** @type {jQuery} */
        actionsNodeElement;

        /**
         * @param {TuliaEditor.Shared.EventDispatcher.EventDispatcher} eventDispatcher
         * @param {TuliaEditor.Layout.Infrastructure.View.Layout} layout
         */
        constructor (eventDispatcher, layout) {
            /** @type {TuliaEditor.Shared.EventDispatcher.EventDispatcher} */
            this.eventDispatcher = eventDispatcher;
            /** @type {TuliaEditor.Layout.Infrastructure.View.Layout} */
            this.layout = layout;
        }

        enable () {
            this.boundariesNode.removeClass('tued-disabled');
            this.actionsNode.removeClass('tued-disabled');
        }

        disable () {
            this.boundariesNode.addClass('tued-disabled');
            this.actionsNode.addClass('tued-disabled');
        }

        /**
         * @param {String} nodeName
         * @param {TuliaEditor.Selection.Domain.Actions.Model.Actions} actions
         */
        show (nodeName, actions) {
            this.actionsNode.empty();
            let self = this;

            for (let action of actions.actions) {
                let node = $('<div data-tued-tooltip="" title="' + action.label + '">' + action.icon + '</div>');
                node.on('click', function () {
                    self.eventDispatcher.dispatch('layout.selection.selected.action', action.callback);
                });
                this.actionsNode.append(node);
            }

            this.boundariesNode.find('.tued-node-name').text(nodeName);
            this.boundariesNode.removeClass('tued-hidden');
            this.actionsNode.removeClass('tued-hidden');
        }

        hide () {
            this.boundariesNode.addClass('tued-hidden');
            this.actionsNode.addClass('tued-hidden');
        }

        /**
         * @internal
         */
        updatePosition (boundaries) {
            this.boundariesNode.css({
                width : boundaries.width,
                height: boundaries.height,
                left  : boundaries.left,
                top   : boundaries.top - boundaries.scrollTop
            });

            this.actionsNode.css({
                left: boundaries.left + boundaries.width - this.actionsNode.width(),
                top : boundaries.top - boundaries.scrollTop
            });
        }

        /**
         * @param {jQuery} element
         * @return {null|jQuery}
         */
        findSelectableElementId (element) {
            if (element.attr('data-tued-selectable')) {
                return element;
            }

            element = element.closest('[data-tued-selectable]');

            return element.length ? element.attr('data-tued-element-id') : null;
        }

        /**
         * @internal
         * @return {String}
         */
        getElementName (element) {
            if (element.hasClass('tued-node-block')) {
                return 'Block';
            } else if (element.hasClass('tued-node-column')) {
                return 'Column';
            } else if (element.hasClass('tued-node-row')) {
                return 'Row';
            } else if (element.hasClass('tued-node-section')) {
                return 'Section';
            } else {
                return element.get(0).tagName;
            }
        }

        /**
         * @return {jQuery}
         */
        get actionsNode () {
            if (this.actionsNodeElement) {
                return this.actionsNodeElement;
            }

            this.actionsNodeElement = this.layout.getSelectedElementActionsNode();

            return this.actionsNodeElement;
        }

        /**
         * @return {jQuery}
         */
        get boundariesNode () {
            if (this.boundariesNodeElement) {
                return this.boundariesNodeElement;
            }

            return this.boundariesNodeElement = this.layout.getSelectedElementBoundariesNode();
        }
    }

    TuliaEditor.ns('TuliaEditor.Selection.Infrastructure.Selection', Selection);
}());

(function () {
    class Hover {
        /** @type {jQuery} */
        boundariesNodeElement;

        /**
         * @param {TuliaEditor.Layout.Infrastructure.View.Layout} layout
         */
        constructor (layout) {
            /** @type {TuliaEditor.Layout.Infrastructure.View.Layout} */
            this.layout = layout;
        }

        /**
         * @param {String} nodeName
         * @param {TuliaEditor.Selection.Domain.Actions.Model.Actions} actions
         */
        show (nodeName, actions) {
            this.boundariesNode.find('.tued-node-name').text(nodeName);
            this.boundariesNode.removeClass('tued-hidden');
        }

        hide () {
            this.boundariesNode.addClass('tued-hidden');
        }

        enable () {
            this.boundariesNode.removeClass('tued-disabled');
        }

        disable () {
            this.boundariesNode.addClass('tued-disabled');
        }

        /**
         * @internal
         */
        updatePosition (boundaries) {
            this.boundariesNode.css({
                width : boundaries.width,
                height: boundaries.height,
                left  : boundaries.left,
                top   : boundaries.top - boundaries.scrollTop
            });
        }

        /**
         * @return {jQuery}
         */
        get boundariesNode () {
            if (this.boundariesNodeElement) {
                return this.boundariesNodeElement;
            }

            return this.boundariesNodeElement = this.layout.getHoverableElementBoundariesNode();
        }
    }

    TuliaEditor.ns('TuliaEditor.Selection.Infrastructure.Hover', Hover);
}());

(function () {
    class ElementBoundaries {
        /**
         * @param {TuliaEditor.Layout.Infrastructure.View.Canvas} canvas
         * @param {TuliaEditor.Document.Infrastructure.View.Structure.NodesStorage} nodesStorage
         */
        constructor (canvas, nodesStorage) {
            /** @type {TuliaEditor.Layout.Infrastructure.View.Canvas} */
            this.canvas = canvas;
            /** @type {TuliaEditor.Document.Infrastructure.View.Structure.NodesStorage} */
            this.nodesStorage = nodesStorage;
        }

        getBoundaries (element) {
            if (element instanceof TuliaEditor.Document.Domain.Grid.Entity.AbstractEntity) {
                element = this.nodesStorage.get(element.id);
            }

            if(! element)
                return null;

            let doc = element.get(0).ownerDocument;

            return {
                left      : element.offset().left,
                top       : element.offset().top,
                width     : element.outerWidth(),
                height    : element.outerHeight(),
                position  : element.css('position'),
                scrollTop : $(doc.defaultView || doc.parentWindow).scrollTop()
            };
        }
    }

    TuliaEditor.ns('TuliaEditor.Selection.Infrastructure.ElementBoundaries', ElementBoundaries);
}());

(function () {
    class CanvasEvents {
        /**
         * @param {TuliaEditor.Shared.EventDispatcher.EventDispatcher} eventDispatcher
         * @param {TuliaEditor.Layout.Infrastructure.View.Canvas} canvas
         */
        constructor (eventDispatcher, canvas) {
            /** @type {TuliaEditor.Shared.EventDispatcher.EventDispatcher} */
            this.eventDispatcher = eventDispatcher;
            /** @type {TuliaEditor.Layout.Infrastructure.View.Canvas} */
            this.canvas = canvas;
        }

        handleCanvasMouseEvents () {
            let self = this;
            let canvas = $(this.canvas.body);

            canvas.on('click contextmenu', '[data-tued-selectable]', function (e) {
                self.eventDispatcher.dispatch('layout.selection.selectable.click', $(e.target));
            }).click(function () {
                self.eventDispatcher.dispatch('layout.selection.canvas.click');
            }).on('mouseenter', '[data-tued-selectable]', function () {
                self.eventDispatcher.dispatch('layout.selection.hoverable.enter', $(this));
            }).on('mouseleave', '[data-tued-selectable]', function () {
                self.eventDispatcher.dispatch('layout.selection.hoverable.leave', $(this));
            });

            $(this.canvas.window).on('scroll', function () {
                self.eventDispatcher.dispatch('layout.selection.canvas.scroll');
            }).on('resize', function () {
                self.eventDispatcher.dispatch('layout.selection.canvas.resize');
            });
        }
    }

    TuliaEditor.ns('TuliaEditor.Selection.Infrastructure.UserInterface.CanvasEvents', CanvasEvents);
}());

(function() {
    class VisibilityChange {
        /**
         * @param {TuliaEditor.ContextMenu.Domain.Manager} manager
         */
        constructor (manager) {
            /** @type {TuliaEditor.ContextMenu.Domain.Manager} */
            this.manager = manager;
        }

        /**
         * @param {jQuery} target
         * @param {Object} clickPosition {x:Number, y:Number}
         * @param {Event} event
         */
        show (target, clickPosition, event) {
            let showed = this.manager.show(target, clickPosition);

            if (showed) {
                event.preventDefault();
            }
        }

        hide () {
            this.manager.hide();
        }
    }

    TuliaEditor.ns('TuliaEditor.ContextMenu.Application.EventListener.VisibilityChange', VisibilityChange);
}());

(function() {
    class Builder {
        /**
         * @param {TuliaEditor.Shared.EventDispatcher.EventDispatcher} eventDispatcher
         * @param {TuliaEditor.Document.Domain.Model.Document} document
         * @param {TuliaEditor.Shared.I18n.Translator} translator
         */
        constructor (eventDispatcher, document, translator) {
            /** @type {TuliaEditor.Shared.EventDispatcher.EventDispatcher} */
            this.eventDispatcher = eventDispatcher;
            /** @type {TuliaEditor.Document.Domain.Model.Document} */
            this.document = document;
            /** @type {TuliaEditor.Shared.I18n.Translator} */
            this.translator = translator;
        }

        /**
         * Create Context Menu for defined target (and all parents) and returns structure.
         *
         * @param {jQuery} target
         * @return {TuliaEditor.ContextMenu.Domain.Entity.Menu}
         */
        createMenu (target) {
            let rootMenu = new TuliaEditor.ContextMenu.Domain.Entity.Menu();
            let elementsStack = this.findParents(target);

            let insertItem = new TuliaEditor.ContextMenu.Domain.Entity.Item('core.insert', this.translator.trans('insert'));
            insertItem.menu = new TuliaEditor.ContextMenu.Domain.Entity.Menu();
            rootMenu.addItem(insertItem);

            let removeItem = new TuliaEditor.ContextMenu.Domain.Entity.Item('core.remove', this.translator.trans('remove'));
            removeItem.menu = new TuliaEditor.ContextMenu.Domain.Entity.Menu();
            rootMenu.addItem(removeItem);

            this.eventDispatcher.dispatch('domain.contextmenu.build.root', rootMenu);

            for (let element of elementsStack) {
                let context = element.attr('data-tued-contextmenu');

                if (context) {
                    this.eventDispatcher.dispatch(
                        'domain.contextmenu.build.' + context,
                        rootMenu,
                        this.document.structure.findByElement(element)
                    );
                }
            }

            rootMenu.removeEmptySubmenus();

            return rootMenu;
        }

        findParents (target) {
            let parents = [];
            let parent = target;

            do {
                if (parent.attr('data-tued-contextmenu')) {
                    parents.push(parent);
                }

                parent = parent.parent();
            } while (parent.length);

            return parents;
        }
    }

    TuliaEditor.ns('TuliaEditor.ContextMenu.Domain.Builder', Builder);
}());

(function() {
    class Manager {
        /**
         * @param {TuliaEditor.ContextMenu.Domain.Builder} menuBuilder
         * @param {TuliaEditor.ContextMenu.Infrastructure.Builder} viewBuilder
         * @param {TuliaEditor.ContextMenu.Infrastructure.View} view
         * @param {TuliaEditor.Selection.Application.Service.Selection} selection
         */
        constructor (menuBuilder, viewBuilder, view, selection) {
            /** @type {TuliaEditor.ContextMenu.Domain.Builder} */
            this.menuBuilder = menuBuilder;
            /** @type {TuliaEditor.ContextMenu.Infrastructure.Builder} */
            this.viewBuilder = viewBuilder;
            /** @type {TuliaEditor.ContextMenu.Infrastructure.View} */
            this.view = view;
            /** @type {TuliaEditor.Selection.Application.Service.Selection} */
            this.selection = selection;
        }

        /**
         * @param {jQuery} target
         * @param {Object} clickPosition {x:Number, y:Number}
         * @return {Boolean} If the menu was showed.
         */
        show (target, clickPosition) {
            if (this.selection.isDisabled()) {
                return false;
            }

            let menu = this.menuBuilder.createMenu(target);

            if (menu.isEmpty()) {
                this.hide();
                return false;
            }

            this.view.show(
                this.viewBuilder.buildMenu(menu),
                clickPosition
            );

            return true;
        }

        hide () {
            this.view.hide();
        }
    }

    TuliaEditor.ns('TuliaEditor.ContextMenu.Domain.Manager', Manager);
}());

(function() {
    class Item {
        /** @type {String} */
        id;

        /** @type {String} */
        label;

        /** @type {Function} */
        callback;

        /** @type {String} */
        icon;

        /** @type {TuliaEditor.ContextMenu.Domain.Entity.Menu} */
        menu;

        /**
         * @param {String} id
         * @param {String} label
         * @param {null|Function} callback
         */
        constructor (id, label, callback) {
            this.id = id;
            this.label = label;
            this.callback = callback;
        }

        /**
         * @return {Boolean}
         */
        hasMenu () {
            return this.menu instanceof TuliaEditor.ContextMenu.Domain.Entity.Menu;
        }
    }

    TuliaEditor.ns('TuliaEditor.ContextMenu.Domain.Entity.Item', Item);
}());

(function() {
    class Menu {
        /** @type {TuliaEditor.ContextMenu.Domain.Entity.Item[]} */
        items = [];

        /**
         * @param {TuliaEditor.ContextMenu.Domain.Entity.Item} item
         */
        addItem (item) {
            this.items.push(item);
        }

        removeItem (toRemove) {
            for (let item of this.items) {
                if (item.id === toRemove.id) {
                    let index = this.items.indexOf(toRemove);
                    if (index > -1) {
                        this.items.splice(index, 1);
                    }
                    return;
                }

                if (item.hasMenu()) {
                    item.menu.removeItem(toRemove);
                }
            }
        }

        isEmpty () {
            return this.items.length === 0;
        }

        find (id) {
            for (let item of this.items) {
                if (item.id === id) {
                    return item;
                }

                if (item.hasMenu()) {
                    let child = item.menu.find(id);

                    if (child instanceof TuliaEditor.ContextMenu.Domain.Entity.Item) {
                        return child;
                    }
                }
            }
        }

        removeEmptySubmenus () {
            for (let item of this.items) {
                if (item.hasMenu()) {
                    item.menu.removeEmptySubmenus();

                    if (item.menu.items.length === 0) {
                        this.removeItem(item);
                    }
                }
            }
        }
    }

    TuliaEditor.ns('TuliaEditor.ContextMenu.Domain.Entity.Menu', Menu);
}());

(function() {
    class Builder {
        /**
         * @param {TuliaEditor.ContextMenu.Domain.Entity.Menu} menu
         * @return {jQuery}
         */
        buildMenu (menu) {
            let res = $('<ul></ul>');

            for (let item of menu.items) {
                res.append(this.buildItem(item));
            }

            return res;
        }

        /**
         * @param {TuliaEditor.ContextMenu.Domain.Entity.Item} item
         * @return {jQuery}
         */
        buildItem (item) {
            let res = $('<li class="tued-menu-item"></li>');
            let link = $('<a href="#" class="tued-menu-link"></a>');

            link.on('click', function (e) {
                e.preventDefault();
                if (typeof(item.callback) === 'function') {
                    item.callback(e);
                }
            });
            link.text(item.label);
            link.attr('data-tued-menu-item-id', item.id);

            res.append(link);

            if (item.hasMenu()) {
                let menu = this.buildMenu(item.menu);
                menu.addClass('tued-dropdown-submenu');
                res.addClass('tued-dropdown-has-submenu');
                res.append(menu);
            }

            return res;
        }
    }

    TuliaEditor.ns('TuliaEditor.ContextMenu.Infrastructure.Builder', Builder);
}());

(function() {
    class View {
        /** @type {jQuery}
        contextmenu;

        /**
         * @param {TuliaEditor.Layout.Infrastructure.View.Layout} layout
         * @param {TuliaEditor.Layout.Infrastructure.View.Canvas} canvas
         * @param {TuliaEditor.Shared.EventDispatcher.EventDispatcher} eventDispatcher
         */
        constructor (layout, canvas, eventDispatcher) {
            /** @type {TuliaEditor.Layout.Infrastructure.View.Layout} */
            this.layout = layout;
            /** @type {TuliaEditor.Layout.Infrastructure.View.Canvas} */
            this.canvas = canvas;
            /** @type {TuliaEditor.Shared.EventDispatcher.EventDispatcher} */
            this.eventDispatcher = eventDispatcher;
        }

        /**
         * @internal
         */
        init () {
            this.contextmenu = this.layout.getContextMenu();
            let self = this;

            this.canvas.body.on('contextmenu', function (e) {
                self.eventDispatcher.dispatch(
                    'layout.contextmenu.document-trigger.show',
                    $(e.target),
                    {
                        x: e.pageX,
                        y: e.pageY - $('body').scrollTop()
                    },
                    e
                );
            }).on('click', function () {
                self.eventDispatcher.dispatch('layout.contextmenu.document-trigger.hide');
            });

            $('body').click(function () {
                self.eventDispatcher.dispatch('layout.contextmenu.document-trigger.hide');
            });
        }

        /**
         * @param {jQuery} menu The <ul /> element
         * @param {Object} clickPosition The x and y click position inside the canvas (iframe).
         */
        show (menu, clickPosition) {
            this.contextmenu
                .addClass('tued-showed')
                .html(menu.contents())
                .css({
                    left: clickPosition.x + this.canvas.getOffset().left,
                    top: clickPosition.y - this.canvas.getScrollTop(),
                });
        }

        hide () {
            this.contextmenu.removeClass('tued-showed');
        }
    }

    TuliaEditor.ns('TuliaEditor.ContextMenu.Infrastructure.View', View);
}());

(function() {
    class DocumentElementResolver {
        /**
         * @param {TuliaEditor.Layout.Infrastructure.View.Canvas} canvas
         * @param {TuliaEditor.Shared.EventDispatcher.EventDispatcher} eventDispatcher
         */
        constructor (canvas, eventDispatcher) {
            /** @type {TuliaEditor.Layout.Infrastructure.View.Canvas} */
            this.canvas = canvas;
            /** @type {TuliaEditor.Shared.EventDispatcher.EventDispatcher} */
            this.eventDispatcher = eventDispatcher;
        }

        prepareListeners () {
            let self = this;

            this.canvas.body.on('dblclick', '[data-tued-editable]', function (e) {
                self.eventDispatcher.dispatch(
                    'layout.content-editor.edit',
                    $(this).attr('data-tued-editable'),
                    $(e.currentTarget)
                );
            }).on('click', function (e) {
                self.eventDispatcher.dispatch('layout.content-editor.close', $(e.target));
            });

            this.canvas.body.on('keydown', function (e) {
                let escapeKey = 27;

                if (e.which === escapeKey) {
                    self.eventDispatcher.dispatch('layout.content-editor.reject');
                }
            })
        }
    }

    TuliaEditor.ns('TuliaEditor.ContentEditor.Infrastructure.Document.DocumentElementResolver', DocumentElementResolver);
}());

(function() {
    class EditorRepository {
        /**
         * @type {TuliaEditor.ContentEditor.Infrastructure.Editor.AbstractEditor[]}
         */
        editors = {};

        /**
         * @param {TuliaEditor.ContentEditor.Infrastructure.Editor.ContenteditableEditor} inlineEditor
         * @param {TuliaEditor.ContentEditor.Infrastructure.Editor.SummernoteEditor} wysiwygEditor
         */
        constructor (inlineEditor, wysiwygEditor) {
            this.editors['inline'] = inlineEditor;
            this.editors['wysiwyg'] = wysiwygEditor;
        }

        /**
         * @param {String} type
         * @return {TuliaEditor.ContentEditor.Infrastructure.Editor.AbstractEditor}
         */
        get (type) {
            return this.editors[type];
        }

        /**
         * @param {String} type
         * @return {Boolean}
         */
        has (type) {
            return !! this.editors[type];
        }
    }

    TuliaEditor.ns('TuliaEditor.ContentEditor.Infrastructure.Editor.EditorRepository', EditorRepository);
}());

(function() {
    class AbstractEditor {
        /**
         * Created editor for given node. Node contains content that must be edited in the editor.
         * Editor can operate on this node or just hide it when created the proper editor,
         * and can show this node when editor will be destroyed.
         * @param {jQuery} node
         */
        createForNode (node) {

        }

        /**
         * Destroys editor for given node. While destroying, editor should not set the content to the node,
         * as this operation will be created by the manager using the getContent() method.
         * @param {jQuery} node
         */
        destroy (node) {

        }

        /**
         * Returns the editor content.
         * @param {jQuery} node
         * @return {String}
         */
        getContent (node) {
            return node.html();
        }
    }

    TuliaEditor.ns('TuliaEditor.ContentEditor.Infrastructure.Editor.AbstractEditor', AbstractEditor);
}());

(function() {
    class ContenteditableEditor extends TuliaEditor.ContentEditor.Infrastructure.Editor.AbstractEditor {
        /**
         * @param {TuliaEditor.Layout.Infrastructure.View.Canvas} canvas
         */
        constructor (canvas) {
            super();

            /** @type {TuliaEditor.Layout.Infrastructure.View.Canvas} */
            this.canvas = canvas;
        }

        /**
         * @inheritDoc
         * @param {jQuery} node
         */
        createForNode (node) {
            node.attr('contenteditable', true).trigger('focus');
            this.setCaretAtTheBeginning(node);
        }

        /**
         * @inheritDoc
         * @param {jQuery} node
         */
        destroy (node) {
            node.trigger('blur').removeAttr('contenteditable');
        }

        /**
         * @inheritDoc
         * @param {jQuery} node
         * @return {String}
         */
        getContent (node) {
            return node.html();
        }

        /**
         * @inheritDoc
         * @param {jQuery} node
         * @param {String} content
         * @return {String}
         */
        setContent (node, content) {
            node.html(content);
        }

        /**
         * @internal
         * @param {jQuery} element
         */
        setCaretAtTheBeginning (element) {
            let range = this.canvas.document.createRange();
            let sel = this.canvas.window.getSelection();

            range.setStart(element[0], 0);
            range.collapse(true);

            sel.removeAllRanges();
            sel.addRange(range);
        }
    }

    TuliaEditor.ns('TuliaEditor.ContentEditor.Infrastructure.Editor.ContenteditableEditor', ContenteditableEditor);
}());

(function() {
    class SummernoteEditor extends TuliaEditor.ContentEditor.Infrastructure.Editor.AbstractEditor {
        /**
         * @param {TuliaEditor.Layout.Infrastructure.View.Canvas} canvas
         */
        constructor (canvas) {
            super();

            /** @type {TuliaEditor.Layout.Infrastructure.View.Canvas} */
            this.canvas = canvas;
        }

        /**
         * @inheritDoc
         * @param {jQuery} node
         */
        createForNode (node) {
            let copy = $('<div class="summernote-content"></div>');
            copy.html(node.html());

            node.wrapInner('<div class="summernote-content-copy" style="display:none !important;"></div>');
            node.append(copy);

            copy.summernote();
        }

        /**
         * @inheritDoc
         * @param {jQuery} node
         */
        destroy (node) {
            node.find('.summernote-content').summernote('destroy');

            node.html(node.find('.summernote-content').html());
        }

        /**
         * @inheritDoc
         * @param {jQuery} node
         * @return {String}
         */
        getContent (node) {
            return node.find('.summernote-content').summernote('code');
        }

        /**
         * @inheritDoc
         * @param {jQuery} node
         * @param {String} content
         * @return {String}
         */
        setContent (node, content) {
            node.find('.summernote-content').summernote('code', content);
        }
    }

    TuliaEditor.ns('TuliaEditor.ContentEditor.Infrastructure.Editor.SummernoteEditor', SummernoteEditor);
}());

(function() {
    class Editor {
        /** @type {TuliaEditor.ContentEditor.Infrastructure.Editor.AbstractEditor} */
        activeEditor = null;

        /** @type {jQuery} */
        activeNode = null;

        /** @type {null|String} */
        sourceContent = null;

        /**
         * @param {TuliaEditor.Layout.Infrastructure.View.Canvas} canvas
         * @param {TuliaEditor.Selection.Application.Service.Selection} selection
         * @param {TuliaEditor.ContentEditor.Infrastructure.Editor.EditorRepository} editorRepository
         */
        constructor (canvas, selection, editorRepository) {
            /** @type {TuliaEditor.Layout.Infrastructure.View.Canvas} */
            this.canvas = canvas;
            /** @type {TuliaEditor.Selection.Application.Service.Selection} */
            this.selection = selection;
            /** @type {TuliaEditor.ContentEditor.Infrastructure.Editor.EditorRepository} */
            this.editorRepository = editorRepository;
        }

        createEditorFor (type, element) {
            // Cannot create multiple editors at the same time.
            if (this.activeEditor !== null) {
                return;
            }

            if (this.editorRepository.has(type) === false) {
                return;
            }

            this.selection.disable();

            if (this.canvas.window.getSelection().empty) {
                // Chrome
                this.canvas.window.getSelection().empty();
            } else if (this.canvas.window.getSelection().removeAllRanges) {
                // Firefox
                this.canvas.window.getSelection().removeAllRanges();
            }

            this.activeNode = element;
            this.activeEditor = this.editorRepository.get(type);
            this.activeEditor.createForNode(element);

            this.sourceContent = this.activeEditor.getContent(this.activeNode);
        }

        destroy () {
            if (this.activeEditor === null) {
                return;
            }

            this.activeEditor.destroy(this.activeNode);
            this.activeEditor = null;
            this.activeNode = null;
            this.selection.enable();
        }

        rejectChanges () {
            if (this.activeEditor === null) {
                return;
            }

            this.activeEditor.setContent(this.activeNode, this.sourceContent);
            this.activeEditor.destroy(this.activeNode);
            this.activeEditor = null;
            this.activeNode = null;
            this.selection.enable();
        }

        /**
         * @return {null|String}
         */
        getContent () {
            if (this.activeEditor === null) {
                return null;
            }

            return this.activeEditor.getContent(this.activeNode);
        }

        /**
         * @return {Boolean}
         */
        isActiveEditor () {
            return this.activeEditor !== null;
        }

        /**
         * @return {null|jQuery}
         */
        getNodeOfActiveEditor () {
            return this.activeNode;
        }
    }

    TuliaEditor.ns('TuliaEditor.ContentEditor.Application.Service.Editor', Editor);
}());

(function() {
    class StructureContentAccessor {
        /** @type {TuliaEditor.Document.Infrastructure.View.Structure.NodesStorage} nodeStorage */
        /** @type {TuliaEditor.Document.Domain.Model.Document} document */
        /** @type {TuliaEditor.Document.Application.Service.StructureEntityDataAccessor} entityDataAccessor */
        constructor (nodeStorage, document, entityDataAccessor) {
            /** @type {TuliaEditor.Document.Infrastructure.View.Structure.NodesStorage} */
            this.nodeStorage = nodeStorage;
            /** @type {TuliaEditor.Document.Domain.Model.Document} */
            this.document = document;
            /** @type {TuliaEditor.Document.Application.Service.StructureEntityDataAccessor} */
            this.entityDataAccessor = entityDataAccessor;
        }

        setContentForNodeElement (node, content) {
            let entity = this.document.get(this.nodeStorage.getIdByNode(node));
            let property = node.attr('data-tued-editable-bind');

            this.entityDataAccessor.setValue(entity, property, content);
        }
    }

    TuliaEditor.ns('TuliaEditor.ContentEditor.Application.Service.StructureContentAccessor', StructureContentAccessor);
}());

(function() {
    class EditorPublisher {
        /**
         * @param {TuliaEditor.ContentEditor.Application.Service.Editor} editor
         * @param {TuliaEditor.ContentEditor.Application.Service.StructureContentAccessor} accessor
         */
        constructor (editor, accessor) {
            /** @type {TuliaEditor.ContentEditor.Application.Service.Editor} */
            this.editor = editor;
            /** @type {TuliaEditor.ContentEditor.Application.Service.StructureContentAccessor} */
            this.accessor = accessor;
        }

        createEditor (type, element) {
            this.editor.createEditorFor(type, element);
        }

        /**
         * @param {jQuery} node
         */
        closeEditor (node) {
            if (this.editor.isActiveEditor() === false) {
                return;
            }

            if (this.isActiveEditorNode(node)) {
                return;
            }

            let editorNode = this.editor.getNodeOfActiveEditor();
            let content = this.editor.getContent();
            this.editor.destroy();

            this.accessor.setContentForNodeElement(editorNode, content);
        }

        rejectChanges () {
            if (this.editor.isActiveEditor() === false) {
                return;
            }

            this.editor.rejectChanges();
        }

        isActiveEditorNode (node) {
            let editorNode = this.editor.getNodeOfActiveEditor();

            return jQuery.contains(editorNode[0], node[0]) || editorNode.is(node);
        }
    }

    TuliaEditor.ns('TuliaEditor.ContentEditor.Application.EventListener.EditorPublisher', EditorPublisher);
}());

(function() {
    class Editor {
        /**
         * @param {TuliaEditor.Editor.Infrastructure.View.Editor} view
         * @param {TuliaEditor.Shared.EventDispatcher.EventDispatcher} eventDispatcher
         */
        constructor (view, eventDispatcher) {
            /** @type {TuliaEditor.Editor.Infrastructure.View.Editor} */
            this.view = view;
            /** @type {TuliaEditor.Shared.EventDispatcher.EventDispatcher} */
            this.eventDispatcher = eventDispatcher;
        }

        open () {
            this.view.createLayout();
            this.view.openEditor();

            this.eventDispatcher.dispatch('editor.opened');
        }

        close () {
            this.view.closeEditor();

            this.eventDispatcher.dispatch('editor.closed');
        }
    }

    TuliaEditor.ns('TuliaEditor.Editor.Application.Service.Editor', Editor);
}());

(function() {
    class SimpleEventsDispatcher {
        /**
         * @param {TuliaEditor.Shared.EventDispatcher.EventDispatcher} eventDispatcher
         * @param {TuliaEditor.Document.Application.Service.Exporter} exporter
         */
        constructor (eventDispatcher, exporter) {
            /** @type {TuliaEditor.Shared.EventDispatcher.EventDispatcher} */
            this.eventDispatcher = eventDispatcher;
            /** @type {TuliaEditor.Document.Application.Service.Exporter} */
            this.exporter = exporter;
        }

        save () {
            this.eventDispatcher.dispatch('save', this.exporter.export());
        }

        edit () {
            this.eventDispatcher.dispatch('edit');
        }

        cancel () {
            this.eventDispatcher.dispatch('cancel');
        }
    }

    TuliaEditor.ns('TuliaEditor.Editor.Application.EventDispatcher.SimpleEventsDispatcher', SimpleEventsDispatcher);
}());

(function() {
    class OpenEditor {
        /**
         * @param {TuliaEditor.Editor.Application.Service.Editor} editor
         */
        constructor (editor) {
            this.editor = editor;
        }

        open () {
            this.editor.open();
        }

        close () {
            this.editor.close();
        }
    }

    TuliaEditor.ns('TuliaEditor.Editor.Port.Messaging.EventListener.OpenEditor', OpenEditor);
}());

(function() {
    class Editor {
        /**
         * @param {TuliaEditor.Layout.Infrastructure.View.Layout} layout
         */
        constructor (layout) {
            /** @type {TuliaEditor.Layout.Infrastructure.View.Layout} */
            this.layout = layout;
        }

        createLayout () {

        }

        openEditor () {
            $('body').addClass('tued-editor-opened');
            this.layout.getEditor().addClass('tued-editor-opened');
            this.layout.getPreview().removeClass('tued-preview-opened');
        }

        closeEditor () {
            $('body').removeClass('tued-editor-opened');
            this.layout.getEditor().removeClass('tued-editor-opened');
            this.layout.getPreview().addClass('tued-preview-opened');
        }
    }

    TuliaEditor.ns('TuliaEditor.Editor.Infrastructure.View.Editor', Editor);
}());

(function() {
    class PreviewUpdater {
        /**
         * @param {TuliaEditor.Document.Application.Service.Exporter} exporter
         * @param {TuliaEditor.Preview.Infrastructure.View.Preview} view
         */
        constructor (exporter, view) {
            /** @type {TuliaEditor.Document.Application.Service.Exporter} */
            this.exporter = exporter;
            /** @type {TuliaEditor.Preview.Infrastructure.View.Preview} */
            this.view = view;
        }

        updatePreview () {
            let exported = this.exporter.export();

            this.view.updateContent(exported.content);
            this.view.updateStylesheets(exported.styles);
            this.view.updateJavascripts(exported.scripts);
        }
    }

    TuliaEditor.ns('TuliaEditor.Preview.Application.Service.PreviewUpdater', PreviewUpdater);
}());

(function() {
    class PreviewCreator {
        /**
         * @param {TuliaEditor.Preview.Infrastructure.View.Preview} view
         */
        constructor (view) {
            /** @type {TuliaEditor.Preview.Infrastructure.View.Preview} */
            this.view = view;
        }

        createPreview () {
            this.view.create();
        }
    }

    TuliaEditor.ns('TuliaEditor.Preview.Application.Service.PreviewCreator', PreviewCreator);
}());

(function() {
    class UpdatePreview {
        constructor (previewUpdater) {
            this.previewUpdater = previewUpdater;
        }

        updatePreview () {
            this.previewUpdater.updatePreview();
        }
    }

    TuliaEditor.ns('TuliaEditor.Preview.Port.Messaging.EventListener.UpdatePreview', UpdatePreview);
}());

(function() {
    class PreparePreview {
        /**
         * @param {TuliaEditor.Preview.Application.Service.PreviewCreator} previewCreator
         */
        constructor (previewCreator) {
            this.previewCreator = previewCreator;
        }

        createPreview () {
            this.previewCreator.createPreview();
        }
    }

    TuliaEditor.ns('TuliaEditor.Preview.Port.Messaging.EventListener.PreparePreview', PreparePreview);
}());

(function() {
    class Preview {
        /** @type {TuliaEditor.Layout.Domain.View.CanvasSizeWatcher} */
        heightWatcher;

        /** @type {jQuery} */
        node;

        /**
         * @param {TuliaEditor.Layout.Infrastructure.View.Layout} layout
         */
        constructor (layout) {
            /** @type {TuliaEditor.Layout.Infrastructure.View.Layout} */
            this.layout = layout;
        }

        create () {
            this.node = this.layout.getPreviewNode();

            let self = this;

            this.heightWatcher = new TuliaEditor.Layout.Domain.View.CanvasSizeWatcher(this.node);
            this.heightWatcher.onChange(function (height) {
                self.node.height(height);
            });
        }

        updateContent (content) {
            let node = this.node;

            node.contents().find('body').html(content);
        }

        updateStylesheets (stylesheets) {
            let head = this.node.contents().find('head');

            head.find('.tued-preview-stylesheet');

            for (let name in stylesheets) {
                head.append('<link rel="stylesheet" class="tued-preview-stylesheet" id="tued-preview-stylesheet-' + name + '" href="' + stylesheets[name] + '" />');
            }
        }

        updateJavascripts (javascripts) {

        }
    }

    TuliaEditor.ns('TuliaEditor.Preview.Infrastructure.View.Preview', Preview);
}());

(function() {
    class Modals {
        /** @type {TuliaEditor.Modal.Domain.Model.Modal[]} */
        modals = [];

        /**
         * @param {TuliaEditor.Modal.Infrastructure.Modals} view
         */
        constructor (view) {
            /** @type {TuliaEditor.Modal.Infrastructure.Modals} */
            this.view = view;
        }

        /**
         * @return {TuliaEditor.Modal.Domain.Model.Modal}
         */
        create () {
            let id = TuliaEditor.uuid();
            let modal = new TuliaEditor.Modal.Domain.Model.Modal(
                id,
                this,
                new TuliaEditor.Modal.Infrastructure.Modal(this.view.createModalNode(id))
            );

            this.modals.push(modal);

            return modal;
        }

        /**
         * @param {TuliaEditor.Modal.Domain.Model.Modal} modal
         */
        modalOpened (modal) {
            this.view.showModals();
        }

        /**
         * @param {TuliaEditor.Modal.Domain.Model.Modal} modal
         */
        modalClosed (modal) {
            for (let m of this.modals) {
                if (m.opened) {
                    return;
                }
            }

            this.view.hideModals();
        }
    }

    TuliaEditor.ns('TuliaEditor.Modal.Domain.Modals', Modals);
}());

(function() {
    class Modal {
        /** @type {String} */
        id;

        /** @type {TuliaEditor.Modal.Domain.Modals} */
        modals;

        /** @type {TuliaEditor.Modal.Infrastructure.Modal} */
        view;

        /** @type {Boolean} */
        opened = false;

        /** @type {Array} */
        eventsListeners = [];

        /**
         * @param {String} id
         * @param {TuliaEditor.Modal.Domain.Modals} modals
         * @param {TuliaEditor.Modal.Infrastructure.Modal} view
         */
        constructor (id, modals, view) {
            /** @type {TuliaEditor.Modal.Domain.Modals} */
            this.modals = modals;
            /** @type {TuliaEditor.Modal.Infrastructure.Modal} */
            this.view = view;

            let self = this;
            this.view.onClose(function () {
                self.close();
            });
        }

        open () {
            this.callListeners('open');

            this.view.open();
            this.opened = true;
            this.modals.modalOpened(this);
        }

        close () {
            this.callListeners('close');

            this.view.close();
            this.opened = false;
            this.modals.modalClosed(this);
        }

        on (listen, callback) {
            this.eventsListeners.push({
                listen: listen,
                callback: callback
            });
        }

        set title (title) {
            this.view.title = title;
        }

        get title () {
            return this.view.title;
        }

        set body (body) {
            this.view.body = body;
        }

        get body () {
            return this.view.body;
        }

        set footer (footer) {
            this.view.footer = footer;
        }

        get footer () {
            return this.view.footer;
        }

        /**
         * @internal
         * @param {String} event
         */
        callListeners (event) {
            for (let row of this.eventsListeners) {
                if (row.listen === event) {
                    row.callback.call(this);
                }
            }
        }
    }

    TuliaEditor.ns('TuliaEditor.Modal.Domain.Model.Modal', Modal);
}());

(function() {
    class Modal {
        /**
         * @param {jQuery} node
         */
        constructor (node) {
            /** @type {jQuery} */
            this.node = node;
        }

        open () {
            this.node.addClass('tued-modal-opened');
        }

        close () {
            this.node.removeClass('tued-modal-opened');
        }

        set title (title) {
            this.node.find('.tued-modal-header').html(title);
        }

        get title () {
            return this.node.find('.tued-modal-header').html();
        }

        set body (body) {
            this.node.find('.tued-modal-body').html(body);
        }

        get body () {
            return this.node.find('.tued-modal-body');
        }

        set footer (footer) {
            this.view.footer = footer;
        }

        get footer () {
            return this.view.footer;
        }

        /**
         * @internal
         * @param {Function} callback
         */
        onClose (callback) {
            this.node.find('.tued-modal-backdrop, .tued-modal-close').click(function () {
                callback();
            });
        }
    }

    TuliaEditor.ns('TuliaEditor.Modal.Infrastructure.Modal', Modal);
}());

(function() {
    class Modals {
        /**
         * @param {TuliaEditor.Layout.Infrastructure.View.Layout} layout
         */
        constructor (layout) {
            /** @type {TuliaEditor.Layout.Infrastructure.View.Layout} */
            this.layout = layout;
        }

        showModals () {
            this.layout.getModalsNode().addClass('tued-showed');
        }

        hideModals () {
            this.layout.getModalsNode().removeClass('tued-showed');
        }

        /**
         * @param {String} id
         * @return {jQuery}
         */
        createModalNode (id) {
            let modal = $('<div class="tued-modal"><div class="tued-modal-backdrop"></div><div class="tued-modal-content"><div class="tued-modal-close"></div><div class="tued-modal-header"></div><div class="tued-modal-body"></div><div class="tued-modal-footer"></div></div></div>');
            modal.attr('id', id);

            this.layout.getModalsNode().append(modal);

            return modal;
        }
    }

    TuliaEditor.ns('TuliaEditor.Modal.Infrastructure.Modals', Modals);
}());

TuliaEditor.services = $.extend({}, TuliaEditor.services, {
    /**
     * NS: TuliaEditor.Layout
     */
    'TuliaEditor.Layout.Infrastructure.View.Layout': {
        'class': TuliaEditor.Layout.Infrastructure.View.Layout,
        'arguments': [
            '@root',
            '@TuliaEditor.Shared.EventDispatcher.EventDispatcher',
            '@TuliaEditor.Shared.I18n.Translator',
        ],
    },
    'TuliaEditor.Layout.Infrastructure.View.Canvas': {
        'class': TuliaEditor.Layout.Infrastructure.View.Canvas,
        'arguments': [
            '@TuliaEditor.Layout.Infrastructure.View.Layout',
            '@TuliaEditor.Shared.EventDispatcher.EventDispatcher',
        ],
        'tags': [
            {'name': 'event_listener', 'listen': 'layout.view.layout.ready', 'method': 'init'},
        ],
    },
    'TuliaEditor.Layout.Domain.View.Layout': {
        'class': TuliaEditor.Layout.Domain.View.Layout,
        'arguments': [
            '@TuliaEditor.Layout.Infrastructure.View.Layout',
            '@TuliaEditor.Shared.EventDispatcher.EventDispatcher',
            '@options',
        ],
        'tags': [
            {'name': 'initiable'},
        ],
    },
    'TuliaEditor.Layout.Domain.View.Canvas': {
        'class': TuliaEditor.Layout.Domain.View.Canvas,
        'arguments': [
            '@TuliaEditor.Layout.Infrastructure.View.Canvas',
            '@TuliaEditor.Document.Infrastructure.FrontendFramework.FrameworkProvider',
        ],
        'tags': [
            {'name': 'initiable'},
        ],
    },
    'TuliaEditor.Layout.Application.EventListener.ChangeCanvasBreakpoint': {
        'class': TuliaEditor.Layout.Application.EventListener.ChangeCanvasBreakpoint,
        'arguments': [
            '@TuliaEditor.Layout.Domain.View.Canvas',
        ],
        'tags': [
            {'name': 'event_listener', 'listen': 'layout.canvas.change_breakpoint', 'method': 'changeBreakpoint'},
        ],
    },
    'TuliaEditor.Layout.Application.EventListener.ChangeCanvasSize': {
        'class': TuliaEditor.Layout.Application.EventListener.ChangeCanvasSize,
        'arguments': [
            '@TuliaEditor.Layout.Infrastructure.View.Layout',
        ],
        'tags': [
            {'name': 'event_listener', 'listen': 'layout.canvas.height_change', 'method': 'changeHeight'},
        ],
    },
    'TuliaEditor.Layout.Application.Service.CanvasSize': {
        'class': TuliaEditor.Layout.Application.Service.CanvasSize,
        'arguments': [
            '@TuliaEditor.Layout.Domain.View.Canvas',
            '@TuliaEditor.Document.Infrastructure.FrontendFramework.FrameworkProvider',
        ],
    },
    /*'TuliaEditor.Layout.Domain.View.CanvasSizeWatcher': {
        'class': TuliaEditor.Layout.Domain.View.CanvasSizeWatcher,
        'arguments': [
            '@TuliaEditor.Layout.Infrastructure.View.Canvas',
            '@TuliaEditor.Shared.EventDispatcher.EventDispatcher',
        ],
        'tags': [
            {'name': 'initiable'},
        ],
    },*/
    'TuliaEditor.Layout.Infrastructure.EditControls.Renderer': {
        'class': TuliaEditor.Layout.Infrastructure.EditControls.Renderer,
        'arguments': [
            '@TuliaEditor.Layout.Infrastructure.View.Layout',
            '@TuliaEditor.Shared.I18n.Translator',
            '@TuliaEditor.Shared.EventDispatcher.EventDispatcher',
        ],
    },
    'TuliaEditor.Layout.Infrastructure.EditControls.EditControls': {
        'class': TuliaEditor.Layout.Infrastructure.EditControls.EditControls,
        'arguments': [
            '@TuliaEditor.Layout.Infrastructure.View.Layout',
            '@TuliaEditor.Layout.Infrastructure.EditControls.Renderer',
        ],
    },
    'TuliaEditor.Layout.Application.Command.EditControls': {
        'class': TuliaEditor.Layout.Application.Command.EditControls,
        'arguments': [
            '@TuliaEditor.Layout.Domain.EditControls.Collector',
            '@TuliaEditor.Layout.Infrastructure.EditControls.EditControls',
        ],
    },
    'TuliaEditor.Layout.Application.EventListener.EditControls': {
        'class': TuliaEditor.Layout.Application.EventListener.EditControls,
        'arguments': [
            '@TuliaEditor.Layout.Application.Command.EditControls',
        ],
        'tags': [
            {'name': 'event_listener', 'listen': 'layout.canvas.change_breakpoint', 'method': 'updateEditControls'},
            {'name': 'event_listener', 'listen': 'domain.selection.show', 'method': 'showEditControls'},
            {'name': 'event_listener', 'listen': 'domain.selection.hide', 'method': 'hideEditControls'},
        ],
    },
    'TuliaEditor.Layout.Domain.EditControls.Collector': {
        'class': TuliaEditor.Layout.Domain.EditControls.Collector,
        'arguments': [
            '@TuliaEditor.Shared.EventDispatcher.EventDispatcher',
            '@TuliaEditor.Document.Domain.Model.Document',
        ],
    },

    /**
     * NS: TuliaEditor.Document
     */
    'TuliaEditor.Document.Application.Service.Document': {
        'class': TuliaEditor.Document.Application.Service.Document,
        'arguments': [
            '@options',
            '@TuliaEditor.Document.Infrastructure.View.Document',
            '@TuliaEditor.Shared.I18n.Translator',
        ],
    },
    'TuliaEditor.Document.Application.EventListener.Document.PrepareDocument': {
        'class': TuliaEditor.Document.Application.EventListener.Document.PrepareDocument,
        'arguments': [
            '@options',
            '@TuliaEditor.Document.Domain.Service.SourceParser',
            '@TuliaEditor.Document.Application.Service.Document',
            '@TuliaEditor.Document.Domain.Model.Document',
        ],
        'tags': [
            {'name': 'event_listener', 'listen': 'layout.canvas.ready', 'method': 'prepareDocument'},
        ]
    },
    'TuliaEditor.Document.Infrastructure.View.Document': {
        'class': TuliaEditor.Document.Infrastructure.View.Document,
        'arguments': [
            '@TuliaEditor.Layout.Infrastructure.View.Canvas',
        ],
    },
    'TuliaEditor.Document.Infrastructure.View.Structure.NodesStorage': {
        'class': TuliaEditor.Document.Infrastructure.View.Structure.NodesStorage,
    },
    'TuliaEditor.Document.Domain.Model.Document': {
        'class': TuliaEditor.Document.Domain.Model.Document,
        'arguments': [
            '@TuliaEditor.Shared.EventDispatcher.EventDispatcher',
        ],
    },
    'TuliaEditor.Document.Domain.Service.SourceParser': {
        'class': TuliaEditor.Document.Domain.Service.SourceParser,
        'arguments': [
            '@TuliaEditor.Block.Domain.Block.BlocksRegistry',
        ],
    },
    'TuliaEditor.Document.Domain.Service.BlockDuplicator': {
        'class': TuliaEditor.Document.Domain.Service.BlockDuplicator,
        'arguments': [
            '@TuliaEditor.Block.Domain.Block.BlocksRegistry',
        ],
    },
    'TuliaEditor.Document.Infrastructure.View.Grid.Grid': {
        'class': TuliaEditor.Document.Infrastructure.View.Grid.Grid,
        'arguments': [
            '@TuliaEditor.Layout.Infrastructure.View.Canvas',
            '@TuliaEditor.Document.Infrastructure.View.Grid.Renderer.RendererFactory',
            '@TuliaEditor.Document.Infrastructure.View.Structure.NodesStorage',
        ],
    },
    'TuliaEditor.Document.Infrastructure.View.Grid.Renderer.RendererFactory': {
        'class': TuliaEditor.Document.Infrastructure.View.Grid.Renderer.RendererFactory,
        'arguments': [
            '@TuliaEditor.Document.Infrastructure.View.Grid.Renderer.SectionRenderer',
            '@TuliaEditor.Document.Infrastructure.View.Grid.Renderer.RowRenderer',
            '@TuliaEditor.Document.Infrastructure.View.Grid.Renderer.ColumnRenderer',
            '@TuliaEditor.Document.Infrastructure.View.Grid.Renderer.BlockRenderer',
        ],
    },
    'TuliaEditor.Document.Infrastructure.View.Grid.Renderer.SectionRenderer': {
        'class': TuliaEditor.Document.Infrastructure.View.Grid.Renderer.SectionRenderer,
    },
    'TuliaEditor.Document.Infrastructure.View.Grid.Renderer.RowRenderer': {
        'class': TuliaEditor.Document.Infrastructure.View.Grid.Renderer.RowRenderer,
    },
    'TuliaEditor.Document.Infrastructure.View.Grid.Renderer.ColumnRenderer': {
        'class': TuliaEditor.Document.Infrastructure.View.Grid.Renderer.ColumnRenderer,
        'arguments': [
            '@TuliaEditor.Document.Infrastructure.FrontendFramework.FrameworkProvider',
        ],
    },
    'TuliaEditor.Document.Infrastructure.View.Grid.Renderer.BlockRenderer': {
        'class': TuliaEditor.Document.Infrastructure.View.Grid.Renderer.BlockRenderer,
    },
    'TuliaEditor.Document.Infrastructure.FrontendFramework.FrameworkProvider': {
        'class': TuliaEditor.Document.Infrastructure.FrontendFramework.FrameworkProvider,
        'arguments': [
            '@options',
            '@TuliaEditor.Shared.DependencyInjection.Container'
        ],
    },
    'TuliaEditor.Document.Application.EventListener.UI.ContextMenu.RowContextMenu': {
        'class': TuliaEditor.Document.Application.EventListener.UI.ContextMenu.RowContextMenu,
        'arguments': [
            '@TuliaEditor.Shared.I18n.Translator',
            '@TuliaEditor.Document.Application.Service.StructureManipulator.RowManipulator',
        ],
        'tags': [
            {'name': 'event_listener', 'listen': 'domain.contextmenu.build.row', 'method': 'buildForRow'},
            {'name': 'event_listener', 'listen': 'domain.contextmenu.build.section', 'method': 'buildForSection'},
        ]
    },
    'TuliaEditor.Document.Application.EventListener.UI.ContextMenu.SectionContextMenu': {
        'class': TuliaEditor.Document.Application.EventListener.UI.ContextMenu.SectionContextMenu,
        'arguments': [
            '@TuliaEditor.Shared.I18n.Translator',
            '@TuliaEditor.Document.Application.Service.StructureManipulator.SectionManipulator',
        ],
        'tags': [
            {'name': 'event_listener', 'listen': 'domain.contextmenu.build.section', 'method': 'buildForSection'},
            {'name': 'event_listener', 'listen': 'domain.contextmenu.build.root', 'method': 'buildForRoot'},
        ]
    },
    'TuliaEditor.Document.Application.EventListener.UI.ContextMenu.BlockContextMenu': {
        'class': TuliaEditor.Document.Application.EventListener.UI.ContextMenu.BlockContextMenu,
        'arguments': [
            '@TuliaEditor.Shared.I18n.Translator',
            '@TuliaEditor.Document.Application.Service.StructureManipulator.BlockManipulator',
        ],
        'tags': [
            {'name': 'event_listener', 'listen': 'domain.contextmenu.build.block', 'method': 'build'},
            {'name': 'event_listener', 'listen': 'domain.contextmenu.build.column', 'method': 'buildForColumn'},
        ],
    },
    'TuliaEditor.Document.Application.EventListener.UI.EditControls.RowEditControls': {
        'class': TuliaEditor.Document.Application.EventListener.UI.EditControls.RowEditControls,
        'tags': [
            {'name': 'event_listener', 'listen': 'domain.layout.edit-controls.collect.row', 'method': 'collectEditControls'},
        ],
    },
    'TuliaEditor.Document.Application.EventListener.UI.EditControls.ColumnEditControls': {
        'class': TuliaEditor.Document.Application.EventListener.UI.EditControls.ColumnEditControls,
        'arguments': [
            '@TuliaEditor.Layout.Application.Service.CanvasSize',
        ],
        'tags': [
            {'name': 'event_listener', 'listen': 'domain.layout.edit-controls.collect.column', 'method': 'collectEditControls'},
        ],
    },
    'TuliaEditor.Document.Application.Service.Exporter': {
        'class': TuliaEditor.Document.Application.Service.Exporter,
        'arguments': [
            '@options',
            '@TuliaEditor.Document.Domain.Model.Document',
            '@TuliaEditor.Document.Infrastructure.View.Grid.Renderer.RendererFactory',
        ],
    },
    'TuliaEditor.Document.Application.Service.StructureManipulator.SectionManipulator': {
        'class': TuliaEditor.Document.Application.Service.StructureManipulator.SectionManipulator,
        'arguments': [
            '@TuliaEditor.Document.Domain.Model.Document',
        ],
    },
    'TuliaEditor.Document.Application.Service.StructureManipulator.RowManipulator': {
        'class': TuliaEditor.Document.Application.Service.StructureManipulator.RowManipulator,
        'arguments': [
            '@TuliaEditor.Document.Domain.Model.Document',
            '@TuliaEditor.Document.Infrastructure.FrontendFramework.FrameworkProvider',
        ],
    },
    'TuliaEditor.Document.Application.Service.StructureManipulator.BlockManipulator': {
        'class': TuliaEditor.Document.Application.Service.StructureManipulator.BlockManipulator,
        'arguments': [
            '@TuliaEditor.Block.Domain.Block.BlockPicker',
            '@TuliaEditor.Document.Domain.Service.BlockDuplicator',
            '@TuliaEditor.Document.Domain.Model.Document',
        ],
    },
    'TuliaEditor.Document.Application.Service.StructureEntityDataAccessor': {
        'class': TuliaEditor.Document.Application.Service.StructureEntityDataAccessor,
        'arguments': [
            '@TuliaEditor.Shared.EventDispatcher.EventDispatcher',
        ],
    },
    'TuliaEditor.Document.Application.EventListener.UI.SelectedActions': {
        'class': TuliaEditor.Document.Application.EventListener.UI.SelectedActions,
        'arguments': [
            '@TuliaEditor.Document.Domain.Model.Document',
            '@TuliaEditor.Shared.I18n.Translator',
            '@TuliaEditor.Document.Application.Service.StructureManipulator.BlockManipulator',
            '@TuliaEditor.Document.Application.Service.StructureManipulator.RowManipulator',
            '@TuliaEditor.Document.Application.Service.StructureManipulator.SectionManipulator',
        ],
        'tags': [
            {'name': 'event_listener', 'listen': 'domain.selection.actions.selected', 'method': 'collect', 'priority': -1000},
        ]
    },
    'TuliaEditor.Document.Application.EventListener.Structure.InsertElement': {
        'class': TuliaEditor.Document.Application.EventListener.Structure.InsertElement,
        'arguments': [
            '@TuliaEditor.Document.Infrastructure.View.Grid.Grid',
        ],
        'tags': [
            {'name': 'event_listener', 'listen': 'domain.document.grid.element.inserted', 'method': 'insertElementIntoView', 'priority': 9999},
        ],
    },
    'TuliaEditor.Document.Application.EventListener.Structure.RemoveElement': {
        'class': TuliaEditor.Document.Application.EventListener.Structure.RemoveElement,
        'arguments': [
            '@TuliaEditor.Document.Infrastructure.View.Grid.Grid',
        ],
        'tags': [
            {'name': 'event_listener', 'listen': 'domain.document.grid.element.removed', 'method': 'removeElementFromView', 'priority': 9999},
        ],
    },
    'TuliaEditor.Document.Application.EventListener.Structure.ReplaceWholeStructure': {
        'class': TuliaEditor.Document.Application.EventListener.Structure.ReplaceWholeStructure,
        'arguments': [
            '@TuliaEditor.Document.Infrastructure.View.Grid.Grid',
        ],
        'tags': [
            {'name': 'event_listener', 'listen': 'domain.document.grid.structure.replace', 'method': 'replaceWholeStructure', 'priority': 9999},
        ],
    },
    'TuliaEditor.Document.Application.EventListener.Document.Preview.UpdateColumnPreview': {
        'class': TuliaEditor.Document.Application.EventListener.Document.Preview.UpdateColumnPreview,
        'arguments': [
            '@TuliaEditor.Document.Infrastructure.View.Structure.NodesStorage',
            '@TuliaEditor.Document.Infrastructure.View.Grid.Renderer.ColumnRenderer',
        ],
        'tags': [
            {'name': 'event_listener', 'listen': 'layout.layout.edit_control.change', 'method': 'updateColumnPreview'},
        ],
    },
});

TuliaEditor.services = $.extend({}, TuliaEditor.services, {
    /**
     * NS: TuliaEditor.Shared
     */
    'TuliaEditor.Shared.DependencyInjection.Container': {
        'class': TuliaEditor.Shared.DependencyInjection.Container,
    },
    'TuliaEditor.Shared.EventDispatcher.EventDispatcher': {
        'class': TuliaEditor.Shared.EventDispatcher.EventDispatcher,
    },
    'TuliaEditor.Shared.EventDispatcher.ListenersRegistrator': {
        'class': TuliaEditor.Shared.EventDispatcher.ListenersRegistrator,
        'arguments': [
            '@TuliaEditor.Shared.DependencyInjection.Container',
            '@TuliaEditor.Shared.EventDispatcher.EventDispatcher',
        ],
    },
    'TuliaEditor.Shared.I18n.Translator': {
        'class': TuliaEditor.Shared.I18n.Translator,
        'arguments': [
            '@options',
        ],
    }
});

TuliaEditor.services = $.extend({}, TuliaEditor.services, {
    'TuliaEditor.Selection.Domain.Hover': {
        'class': TuliaEditor.Selection.Domain.Hover,
        'arguments': [
            '@TuliaEditor.Shared.EventDispatcher.EventDispatcher',
            '@TuliaEditor.Selection.Domain.Selection',
        ],
    },
    'TuliaEditor.Selection.Domain.Selection': {
        'class': TuliaEditor.Selection.Domain.Selection,
        'arguments': [
            '@TuliaEditor.Shared.EventDispatcher.EventDispatcher',
            '@TuliaEditor.Document.Domain.Model.Document',
        ],
    },
    'TuliaEditor.Selection.Infrastructure.Selection': {
        'class': TuliaEditor.Selection.Infrastructure.Selection,
        'arguments': [
            '@TuliaEditor.Shared.EventDispatcher.EventDispatcher',
            '@TuliaEditor.Layout.Infrastructure.View.Layout',
        ],
    },
    'TuliaEditor.Selection.Infrastructure.Hover': {
        'class': TuliaEditor.Selection.Infrastructure.Hover,
        'arguments': [
            '@TuliaEditor.Layout.Infrastructure.View.Layout',
        ],
    },
    'TuliaEditor.Selection.Infrastructure.UserInterface.CanvasEvents': {
        'class': TuliaEditor.Selection.Infrastructure.UserInterface.CanvasEvents,
        'arguments': [
            '@TuliaEditor.Shared.EventDispatcher.EventDispatcher',
            '@TuliaEditor.Layout.Infrastructure.View.Canvas',
        ],
    },
    'TuliaEditor.Selection.Infrastructure.ElementBoundaries': {
        'class': TuliaEditor.Selection.Infrastructure.ElementBoundaries,
        'arguments': [
            '@TuliaEditor.Layout.Infrastructure.View.Canvas',
            '@TuliaEditor.Document.Infrastructure.View.Structure.NodesStorage',
        ],
    },
    'TuliaEditor.Selection.Domain.Actions.Collector': {
        'class': TuliaEditor.Selection.Domain.Actions.Collector,
        'arguments': [
            '@TuliaEditor.Shared.EventDispatcher.EventDispatcher',
        ],
    },
    'TuliaEditor.Selection.Application.EventListener.Domain.CollectSelectedActions': {
        'class': TuliaEditor.Selection.Application.EventListener.Domain.CollectSelectedActions,
        'arguments': [
            '@TuliaEditor.Selection.Application.Service.Selection',
            '@TuliaEditor.Shared.I18n.Translator',
        ],
        'tags': [
            {'name': 'event_listener', 'listen': 'domain.selection.actions.selected', 'method': 'collect'},
        ],
    },
    'TuliaEditor.Selection.Application.EventListener.Domain.ExecuteSelectedAction': {
        'class': TuliaEditor.Selection.Application.EventListener.Domain.ExecuteSelectedAction,
        'arguments': [
            '@TuliaEditor.Selection.Application.Service.Selection',
        ],
        'tags': [
            {'name': 'event_listener', 'listen': 'layout.selection.selected.action', 'method': 'executeCallbackOnSelected'},
        ],
    },
    'TuliaEditor.Selection.Application.EventListener.UserInterfaceEvents.UpdateSelectionPosition': {
        'class': TuliaEditor.Selection.Application.EventListener.UserInterfaceEvents.UpdateSelectionPosition,
        'arguments': [
            '@TuliaEditor.Selection.Application.Service.Selection',
            '@TuliaEditor.Selection.Infrastructure.Selection',
            '@TuliaEditor.Shared.I18n.Translator',
            '@TuliaEditor.Document.Infrastructure.View.Structure.NodesStorage',
            '@TuliaEditor.Selection.Domain.Actions.Collector',
        ],
        'tags': [
            {'name': 'event_listener', 'listen': 'layout.selection.canvas.resize', 'method': 'updatePosition'},
            {'name': 'event_listener', 'listen': 'layout.selection.canvas.scroll', 'method': 'updatePosition'},
            {'name': 'event_listener', 'listen': 'layout.layout.edit_control.change', 'method': 'updatePosition', 'priority': -1000},
            {'name': 'event_listener', 'listen': 'domain.selection.hide', 'method': 'hide'},
            {'name': 'event_listener', 'listen': 'domain.selection.show', 'method': 'show'},
        ],
    },
    'TuliaEditor.Selection.Application.EventListener.UserInterfaceEvents.UpdateHoverPosition': {
        'class': TuliaEditor.Selection.Application.EventListener.UserInterfaceEvents.UpdateHoverPosition,
        'arguments': [
            '@TuliaEditor.Selection.Application.Service.Hover',
            '@TuliaEditor.Selection.Infrastructure.Hover',
        ],
        'tags': [
            {'name': 'event_listener', 'listen': 'layout.selection.canvas.resize', 'method': 'updatePosition'},
            {'name': 'event_listener', 'listen': 'layout.selection.canvas.scroll', 'method': 'updatePosition'},
            {'name': 'event_listener', 'listen': 'layout.layout.edit_control.change', 'method': 'updatePosition', 'priority': -1000},
            {'name': 'event_listener', 'listen': 'domain.selection.hover.hide', 'method': 'hide'},
            {'name': 'event_listener', 'listen': 'domain.selection.hover.show', 'method': 'show'},
        ],
    },
    'TuliaEditor.Selection.Application.EventListener.ExternalDomainEvents.SelectionVisibility': {
        'class': TuliaEditor.Selection.Application.EventListener.ExternalDomainEvents.SelectionVisibility,
        'arguments': [
            '@TuliaEditor.Selection.Application.Service.Selection',
        ],
        'tags': [
            {'name': 'event_listener', 'listen': 'domain.document.grid.element.inserted', 'method': 'selectInsertedElement'},
            {'name': 'event_listener', 'listen': 'domain.document.grid.element.removed', 'method': 'hideSelection'},
        ],
    },
    'TuliaEditor.Selection.Application.EventListener.UserInterfaceEvents.SelectElement': {
        'class': TuliaEditor.Selection.Application.EventListener.UserInterfaceEvents.SelectElement,
        'arguments': [
            '@TuliaEditor.Selection.Application.Service.Selection',
        ],
        'tags': [
            {'name': 'event_listener', 'listen': 'layout.selection.selectable.click', 'method': 'selectNodeElement'},
            {'name': 'event_listener', 'listen': 'layout.selection.canvas.click', 'method': 'hideSelection'},
        ],
    },
    'TuliaEditor.Selection.Application.EventListener.UserInterfaceEvents.HoverElement': {
        'class': TuliaEditor.Selection.Application.EventListener.UserInterfaceEvents.HoverElement,
        'arguments': [
            '@TuliaEditor.Selection.Application.Service.Hover',
        ],
        'tags': [
            {'name': 'event_listener', 'listen': 'layout.selection.hoverable.enter', 'method': 'showFor'},
            {'name': 'event_listener', 'listen': 'layout.selection.hoverable.leave', 'method': 'hideFor'},
        ],
    },
    'TuliaEditor.Selection.Application.EventListener.PreviewUpdate.SelectionDisabler': {
        'class': TuliaEditor.Selection.Application.EventListener.PreviewUpdate.SelectionDisabler,
        'arguments': [
            '@TuliaEditor.Selection.Infrastructure.Selection',
            '@TuliaEditor.Selection.Infrastructure.Hover',
        ],
        'tags': [
            {'name': 'event_listener', 'listen': 'domain.selection.disabled', 'method': 'disable'},
            {'name': 'event_listener', 'listen': 'domain.selection.enabled', 'method': 'enable'},
        ],
    },
    'TuliaEditor.Selection.Application.EventListener.Domain.InitSelection': {
        'class': TuliaEditor.Selection.Application.EventListener.Domain.InitSelection,
        'arguments': [
            '@TuliaEditor.Selection.Application.Service.Initiator',
        ],
        'tags': [
            {'name': 'initiable'},
        ],
    },
    'TuliaEditor.Selection.Application.Service.Selection': {
        'class': TuliaEditor.Selection.Application.Service.Selection,
        'arguments': [
            '@TuliaEditor.Selection.Domain.Selection',
            '@TuliaEditor.Selection.Infrastructure.Selection',
            '@TuliaEditor.Selection.Infrastructure.ElementBoundaries',
        ],
    },
    'TuliaEditor.Selection.Application.Service.Hover': {
        'class': TuliaEditor.Selection.Application.Service.Hover,
        'arguments': [
            '@TuliaEditor.Selection.Domain.Hover',
            '@TuliaEditor.Selection.Infrastructure.Hover',
            '@TuliaEditor.Selection.Infrastructure.ElementBoundaries',
        ],
    },
    'TuliaEditor.Selection.Application.Service.Initiator': {
        'class': TuliaEditor.Selection.Application.Service.Initiator,
        'arguments': [
            '@TuliaEditor.Selection.Infrastructure.UserInterface.CanvasEvents',
        ],
    },
});

TuliaEditor.services = $.extend({}, TuliaEditor.services, {
    'TuliaEditor.Preview.Port.Messaging.EventListener.UpdatePreview': {
        'class': TuliaEditor.Preview.Port.Messaging.EventListener.UpdatePreview,
        'arguments': [
            '@TuliaEditor.Preview.Application.Service.PreviewUpdater',
        ],
        'tags': [
            {'name': 'event_listener', 'listen': 'domain.document.grid.structure.replace', 'method': 'updatePreview'},
            {'name': 'event_listener', 'listen': 'layout.view.action.save', 'method': 'updatePreview'},
        ],
    },
    'TuliaEditor.Preview.Port.Messaging.EventListener.PreparePreview': {
        'class': TuliaEditor.Preview.Port.Messaging.EventListener.PreparePreview,
        'arguments': [
            '@TuliaEditor.Preview.Application.Service.PreviewCreator',
        ],
        'tags': [
            {'name': 'event_listener', 'listen': 'editor.ready', 'method': 'createPreview'},
        ],
    },
    'TuliaEditor.Preview.Application.Service.PreviewCreator': {
        'class': TuliaEditor.Preview.Application.Service.PreviewCreator,
        'arguments': [
            '@TuliaEditor.Preview.Infrastructure.View.Preview',
        ],
    },
    'TuliaEditor.Preview.Application.Service.PreviewUpdater': {
        'class': TuliaEditor.Preview.Application.Service.PreviewUpdater,
        'arguments': [
            '@TuliaEditor.Document.Application.Service.Exporter',
            '@TuliaEditor.Preview.Infrastructure.View.Preview',
        ],
    },
    'TuliaEditor.Preview.Infrastructure.View.Preview': {
        'class': TuliaEditor.Preview.Infrastructure.View.Preview,
        'arguments': [
            '@TuliaEditor.Layout.Infrastructure.View.Layout',
        ],
    },
});

TuliaEditor.services = $.extend({}, TuliaEditor.services, {
    'TuliaEditor.Editor.Port.Messaging.EventListener.OpenEditor': {
        'class': TuliaEditor.Editor.Port.Messaging.EventListener.OpenEditor,
        'arguments': [
            '@TuliaEditor.Editor.Application.Service.Editor',
        ],
        'tags': [
            {'name': 'event_listener', 'listen': 'layout.view.action.edit', 'method': 'open'},
            {'name': 'event_listener', 'listen': 'layout.view.action.cancel', 'method': 'close'},
            {'name': 'event_listener', 'listen': 'layout.view.action.save', 'method': 'close'},
        ],
    },
    'TuliaEditor.Editor.Application.Service.Editor': {
        'class': TuliaEditor.Editor.Application.Service.Editor,
        'arguments': [
            '@TuliaEditor.Editor.Infrastructure.View.Editor',
            '@TuliaEditor.Shared.EventDispatcher.EventDispatcher',
        ],
    },
    'TuliaEditor.Editor.Application.EventDispatcher.SimpleEventsDispatcher': {
        'class': TuliaEditor.Editor.Application.EventDispatcher.SimpleEventsDispatcher,
        'arguments': [
            '@TuliaEditor.Shared.EventDispatcher.EventDispatcher',
            '@TuliaEditor.Document.Application.Service.Exporter',
        ],
        'tags': [
            {'name': 'event_listener', 'listen': 'layout.view.action.save', 'method': 'save', 'priority': 0},
            {'name': 'event_listener', 'listen': 'layout.view.action.edit', 'method': 'edit', 'priority': 0},
            {'name': 'event_listener', 'listen': 'layout.view.action.cancel', 'method': 'cancel', 'priority': 0},
        ],
    },
    'TuliaEditor.Editor.Infrastructure.View.Editor': {
        'class': TuliaEditor.Editor.Infrastructure.View.Editor,
        'arguments': [
            '@TuliaEditor.Layout.Infrastructure.View.Layout',
        ],
    },
});

TuliaEditor.services = $.extend({}, TuliaEditor.services, {
    'TuliaEditor.ContextMenu.Domain.Builder': {
        'class': TuliaEditor.ContextMenu.Domain.Builder,
        'arguments': [
            '@TuliaEditor.Shared.EventDispatcher.EventDispatcher',
            '@TuliaEditor.Document.Domain.Model.Document',
            '@TuliaEditor.Shared.I18n.Translator',
        ],
    },
    'TuliaEditor.ContextMenu.Infrastructure.Builder': {
        'class': TuliaEditor.ContextMenu.Infrastructure.Builder,
    },
    'TuliaEditor.ContextMenu.Infrastructure.View': {
        'class': TuliaEditor.ContextMenu.Infrastructure.View,
        'arguments': [
            '@TuliaEditor.Layout.Infrastructure.View.Layout',
            '@TuliaEditor.Layout.Infrastructure.View.Canvas',
            '@TuliaEditor.Shared.EventDispatcher.EventDispatcher',
        ],
        'tags': [
            {'name': 'initiable'},
        ],
    },
    'TuliaEditor.ContextMenu.Domain.Manager': {
        'class': TuliaEditor.ContextMenu.Domain.Manager,
        'arguments': [
            '@TuliaEditor.ContextMenu.Domain.Builder',
            '@TuliaEditor.ContextMenu.Infrastructure.Builder',
            '@TuliaEditor.ContextMenu.Infrastructure.View',
            '@TuliaEditor.Selection.Application.Service.Selection',
        ],
    },
    'TuliaEditor.ContextMenu.Application.EventListener.VisibilityChange': {
        'class': TuliaEditor.ContextMenu.Application.EventListener.VisibilityChange,
        'arguments': [
            '@TuliaEditor.ContextMenu.Domain.Manager',
        ],
        'tags': [
            {'name': 'event_listener', 'listen': 'layout.contextmenu.document-trigger.hide', 'method': 'hide'},
            {'name': 'event_listener', 'listen': 'layout.contextmenu.document-trigger.show', 'method': 'show'},
        ],
    },
});

TuliaEditor.services = $.extend({}, TuliaEditor.services, {
    'TuliaEditor.Modal.Domain.Modals': {
        'class': TuliaEditor.Modal.Domain.Modals,
        'arguments': [
            '@TuliaEditor.Modal.Infrastructure.Modals',
        ],
    },
    'TuliaEditor.Modal.Infrastructure.Modals': {
        'class': TuliaEditor.Modal.Infrastructure.Modals,
        'arguments': [
            '@TuliaEditor.Layout.Infrastructure.View.Layout',
        ],
    }
});

TuliaEditor.services = $.extend({}, TuliaEditor.services, {
    'TuliaEditor.ContentEditor.Infrastructure.Document.DocumentElementResolver': {
        'class': TuliaEditor.ContentEditor.Infrastructure.Document.DocumentElementResolver,
        'arguments': [
            '@TuliaEditor.Layout.Infrastructure.View.Canvas',
            '@TuliaEditor.Shared.EventDispatcher.EventDispatcher',
        ],
        'tags': [
            {'name': 'event_listener', 'listen': 'layout.canvas.ready', 'method': 'prepareListeners'},
        ],
    },
    'TuliaEditor.ContentEditor.Application.EventListener.EditorPublisher': {
        'class': TuliaEditor.ContentEditor.Application.EventListener.EditorPublisher,
        'arguments': [
            '@TuliaEditor.ContentEditor.Application.Service.Editor',
            '@TuliaEditor.ContentEditor.Application.Service.StructureContentAccessor',
        ],
        'tags': [
            {'name': 'event_listener', 'listen': 'layout.content-editor.edit', 'method': 'createEditor'},
            {'name': 'event_listener', 'listen': 'layout.content-editor.close', 'method': 'closeEditor'},
            {'name': 'event_listener', 'listen': 'layout.content-editor.reject', 'method': 'rejectChanges'},
        ],
    },
    'TuliaEditor.ContentEditor.Application.Service.Editor': {
        'class': TuliaEditor.ContentEditor.Application.Service.Editor,
        'arguments': [
            '@TuliaEditor.Layout.Infrastructure.View.Canvas',
            '@TuliaEditor.Selection.Application.Service.Selection',
            '@TuliaEditor.ContentEditor.Infrastructure.Editor.EditorRepository',
        ],
    },
    'TuliaEditor.ContentEditor.Application.Service.StructureContentAccessor': {
        'class': TuliaEditor.ContentEditor.Application.Service.StructureContentAccessor,
        'arguments': [
            '@TuliaEditor.Document.Infrastructure.View.Structure.NodesStorage',
            '@TuliaEditor.Document.Domain.Model.Document',
            '@TuliaEditor.Document.Application.Service.StructureEntityDataAccessor',
        ],
    },
    'TuliaEditor.ContentEditor.Infrastructure.Editor.EditorRepository': {
        'class': TuliaEditor.ContentEditor.Infrastructure.Editor.EditorRepository,
        'arguments': [
            '@TuliaEditor.ContentEditor.Infrastructure.Editor.ContenteditableEditor',
            '@TuliaEditor.ContentEditor.Infrastructure.Editor.SummernoteEditor',
        ],
    },
    'TuliaEditor.ContentEditor.Infrastructure.Editor.ContenteditableEditor': {
        'class': TuliaEditor.ContentEditor.Infrastructure.Editor.ContenteditableEditor,
        'arguments': [
            '@TuliaEditor.Layout.Infrastructure.View.Canvas',
        ],
        'tags': [
            {'name': 'content-editor', 'type': 'inline'},
        ],
    },
    'TuliaEditor.ContentEditor.Infrastructure.Editor.SummernoteEditor': {
        'class': TuliaEditor.ContentEditor.Infrastructure.Editor.SummernoteEditor,
        'arguments': [
            '@TuliaEditor.Layout.Infrastructure.View.Canvas',
        ],
        'tags': [
            {'name': 'content-editor', 'type': 'wysiwyg'},
        ],
    },
});

TuliaEditor.services = $.extend({}, TuliaEditor.services, {
    'TuliaEditor.Block.Domain.Block.BlocksRegistry': {
        'class': TuliaEditor.Block.Domain.Block.BlocksRegistry,
        'arguments': [
            '@TuliaEditor.Shared.DependencyInjection.Container',
        ],
    },
    'TuliaEditor.Block.Infrastructure.View.BlockPicker': {
        'class': TuliaEditor.Block.Infrastructure.View.BlockPicker,
        'arguments': [
            '@TuliaEditor.Modal.Domain.Modals',
            '@TuliaEditor.Shared.EventDispatcher.EventDispatcher',
            '@TuliaEditor.Shared.I18n.Translator',
        ],
    },
    'TuliaEditor.Block.Domain.Block.BlockPicker': {
        'class': TuliaEditor.Block.Domain.Block.BlockPicker,
        'arguments': [
            '@TuliaEditor.Block.Domain.Block.BlocksRegistry',
            '@TuliaEditor.Block.Infrastructure.View.BlockPicker',
        ],
    },
    'TuliaEditor.Block.Application.EventListener.SelectedBlockExecutor': {
        'class': TuliaEditor.Block.Application.EventListener.SelectedBlockExecutor,
        'arguments': [
            '@TuliaEditor.Block.Domain.Block.BlockPicker',
        ],
        'tags': [
            {'name': 'event_listener', 'listen': 'layout.block.picker.pick', 'method': 'executeSelectedCallback'},
        ],
    },
    'TuliaEditor.Block.Application.EventListener.EditControls': {
        'class': TuliaEditor.Block.Application.EventListener.EditControls,
        'tags': [
            {'name': 'event_listener', 'listen': 'domain.layout.edit-controls.collect.block', 'method': 'collectEditControls'},
        ],
    },
    'TuliaEditor.Block.Application.EventListener.UpdateBlockPreview': {
        'class': TuliaEditor.Block.Application.EventListener.UpdateBlockPreview,
        'tags': [
            {'name': 'event_listener', 'listen': 'layout.layout.edit_control.change', 'method': 'update', 'priority': 1000},
            {'name': 'event_listener', 'listen': 'domain.document.grid.element.updated', 'method': 'update', 'priority': 1000},
        ],
    },
});
